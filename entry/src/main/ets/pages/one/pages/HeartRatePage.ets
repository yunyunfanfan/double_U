import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';

///è¿™æ˜¯å¿ƒç‡é¡µé¢

// æ˜ç¡®çš„ç±»å‹å®šä¹‰
class CategoryFlags {
  current: boolean = false;
  resting: boolean = false;
  max: boolean = false;
  min: boolean = false;
  avg: boolean = false;

  constructor() {}

  toString(): string {
    return `CategoryFlags{current: ${this.current}, resting: ${this.resting}, max: ${this.max}, min: ${this.min}, avg: ${this.avg}}`;
  }
}

class StatCardItem {
  title: string = '';
  value: number = 0;
  color: string = '';
  emoji: string = '';

  constructor(title: string, value: number, color: string, emoji: string) {
    this.title = title;
    this.value = value;
    this.color = color;
    this.emoji = emoji;
  }
}

class AdviceItem {
  text: string = '';
  emoji: string = '';

  constructor(text: string, emoji: string) {
    this.text = text;
    this.emoji = emoji;
  }
}

// å¿ƒç‡è®°å½•æ•°æ®ç»“æ„
class HeartRateRecord {
  time: string = '';
  value: number = 0;
  status: string = '';
  timestamp: string = '';
  category: string = '';

  constructor(time: string, value: number, status: string, timestamp?: string, category?: string) {
    this.time = time;
    this.value = value;
    this.status = status;
    this.timestamp = timestamp || '';
    this.category = category || 'å®æ—¶';
  }

  toString(): string {
    return `HeartRateRecord{time: ${this.time}, value: ${this.value}, status: ${this.status}, category: ${this.category}}`;
  }
}

// å¿ƒç‡ç»Ÿè®¡æ•°æ®ç»“æ„
class HeartRateStats {
  minValue: number = 0;
  maxValue: number = 0;
  avgValue: number = 0;
  currentValue: number = 0;
  restingValue: number = 0;
  recordCount: number = 0;

  constructor() {}

  toString(): string {
    return `HeartRateStats{min: ${this.minValue}, max: ${this.maxValue}, avg: ${this.avgValue}, current: ${this.currentValue}, resting: ${this.restingValue}, count: ${this.recordCount}}`;
  }
}

// å­˜å‚¨çš„å¿ƒç‡æ•°æ®ç»“æ„
class StoredHeartRateData {
  timestamp: string = '';
  type: string = '';
  value: string = '';
  unit: string = '';
  additionalInfo: HeartRateAdditionalInfo = new HeartRateAdditionalInfo();

  constructor(timestamp: string, type: string, value: string, unit: string, additionalInfo?: HeartRateAdditionalInfo) {
    this.timestamp = timestamp;
    this.type = type;
    this.value = value;
    this.unit = unit;
    if (additionalInfo) {
      this.additionalInfo = additionalInfo;
    }
  }

  toString(): string {
    return `StoredHeartRateData{timestamp: "${this.timestamp}", type: "${this.type}", value: "${this.value}", unit: "${this.unit}", category: "${this.additionalInfo.category}"}`;
  }
}

// å¿ƒç‡é™„åŠ ä¿¡æ¯ç»“æ„
class HeartRateAdditionalInfo {
  category: string = '';
  minValue: string = '';
  maxValue: string = '';
  avgValue: string = '';

  constructor() {}

  toString(): string {
    return `HeartRateAdditionalInfo{category: "${this.category}", min: "${this.minValue}", max: "${this.maxValue}", avg: "${this.avgValue}"}`;
  }
}

@Entry
@Component
export struct HeartRatePage {
  @State currentHeartRate: number = 0;
  @State restingHeartRate: number = 0;
  @State minHeartRate: number = 0;
  @State maxHeartRate: number = 0;
  @State avgHeartRate: number = 0;
  @State heartRateRecords: HeartRateRecord[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State heartRateStats: HeartRateStats = new HeartRateStats();

  private preferencesHelper: preferences.Preferences | null = null;

  aboutToAppear(): void {
    console.info('[å¿ƒç‡é¡µé¢] ================ æ™ºèƒ½å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ– ================');
    console.info('[å¿ƒç‡é¡µé¢] å½“å‰ç”¨æˆ·: gadz2021, ç³»ç»Ÿæ—¶é—´: 2025-05-31 02:54:09 UTC');
    console.info('[å¿ƒç‡é¡µé¢] é¡µé¢ç‰ˆæœ¬: v4.2.0, åŠŸèƒ½: ä¿®å¤ArkTSç±»å‹æ£€æŸ¥é”™è¯¯');
    console.info('[å¿ƒç‡é¡µé¢] æ ¸å¿ƒä¿®å¤: ä½¿ç”¨æ˜ç¡®çš„ç±»å‹å®šä¹‰ï¼Œé¿å…å¯¹è±¡å­—é¢é‡');
    console.info('[å¿ƒç‡é¡µé¢] å¼€å§‹åˆå§‹åŒ–å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿ');

    this.initializeHeartRateSystem();
  }

  private async initializeHeartRateSystem(): Promise<void> {
    try {
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ========');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ç±»å‹å®‰å…¨: ä½¿ç”¨æ˜ç¡®çš„ç±»å’Œæ¥å£å®šä¹‰');

      await this.initPreferences();
      await this.loadHeartRateDataFromStorage();
      this.calculateHeartRateStatistics();
      this.isLoading = false;

      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ ========');
      console.info(`[ç³»ç»Ÿåˆå§‹åŒ–] æœ€ç»ˆçŠ¶æ€: å½“å‰=${this.currentHeartRate}, é™æ¯=${this.restingHeartRate}, æœ€é«˜=${this.maxHeartRate}, å¹³å‡=${this.avgHeartRate}, æœ€ä½=${this.minHeartRate}`);
      console.info(`[ç³»ç»Ÿåˆå§‹åŒ–] å®æ—¶è®°å½•æ•°é‡: ${this.heartRateRecords.length} æ¡`);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] åˆå§‹åŒ–å¤±è´¥: ${errorMessage}`);
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] å½“å‰ç”¨æˆ·: gadz2021, é”™è¯¯æ—¶é—´: 2025-05-31 02:54:09 UTC`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${errorMessage}`;
      this.isLoading = false;
      this.loadDefaultHeartRateData();
    }
  }

  private async initPreferences(): Promise<void> {
    console.info('[å­˜å‚¨ç³»ç»Ÿ] ======== åˆå§‹åŒ–é¸¿è’™Preferenceså­˜å‚¨ç³»ç»Ÿ ========');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');

    this.preferencesHelper = await preferences.getPreferences(getContext(), 'health_data');

    console.info('[å­˜å‚¨ç³»ç»Ÿ] Preferencesè¿æ¥æˆåŠŸï¼Œå­˜å‚¨ç³»ç»ŸçŠ¶æ€: å¯ç”¨');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] æ”¯æŒæ“ä½œ: get/put/flush/clearï¼Œæ•°æ®æŒä¹…åŒ–: å·²å¯ç”¨');
  }

  private async loadHeartRateDataFromStorage(): Promise<void> {
    if (!this.preferencesHelper) {
      throw new Error('å­˜å‚¨ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œæ— æ³•è¯»å–æ•°æ®');
    }

    console.info('[æ•°æ®åŠ è½½] ======== å¼€å§‹ä»å­˜å‚¨è¯»å–å¿ƒç‡æ•°æ® ========');
    console.info('[æ•°æ®åŠ è½½] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
    console.info('[æ•°æ®åŠ è½½] ç±»å‹å®‰å…¨ç­–ç•¥: ä½¿ç”¨æ˜ç¡®å®šä¹‰çš„ç±»è¿›è¡Œæ•°æ®å¤„ç†');

    const storedData = await this.preferencesHelper.get('health_records', '[]') as string;
    console.info(`[æ•°æ®åŠ è½½] åŸå§‹å­˜å‚¨æ•°æ®é•¿åº¦: ${storedData.length} å­—ç¬¦`);

    const healthRecords: StoredHeartRateData[] = JSON.parse(storedData);
    console.info(`[æ•°æ®åŠ è½½] JSONè§£ææˆåŠŸï¼Œå¥åº·è®°å½•æ€»æ•°: ${healthRecords.length} æ¡`);

    const heartRateRecords = healthRecords.filter((record: StoredHeartRateData) =>
    record.type === 'heart_rate' || record.type === 'heartrate'
    );
    console.info(`[æ•°æ®åŠ è½½] å¿ƒç‡è®°å½•è¿‡æ»¤å®Œæˆï¼Œæ‰¾åˆ° ${heartRateRecords.length} æ¡å¿ƒç‡è®°å½•`);

    if (heartRateRecords.length === 0) {
      console.warn('[æ•°æ®åŠ è½½] å­˜å‚¨ä¸­æ— å¿ƒç‡è®°å½•ï¼Œå°†ä½¿ç”¨é»˜è®¤æ•°æ®');
      return;
    }

    this.processHeartRateRecords(heartRateRecords);
    console.info('[æ•°æ®åŠ è½½] ======== å¿ƒç‡æ•°æ®åŠ è½½å®Œæˆ ========');
  }

  private processHeartRateRecords(storedRecords: StoredHeartRateData[]): void {
    console.info('[æ•°æ®å¤„ç†] ======== å¼€å§‹å¤„ç†å¿ƒç‡è®°å½•ï¼ˆç±»å‹å®‰å…¨ç‰ˆï¼‰ ========');
    console.info(`[æ•°æ®å¤„ç†] å½“å‰ç”¨æˆ·: gadz2021, å¤„ç†æ—¶é—´: 2025-05-31 02:54:09 UTC`);
    console.info(`[æ•°æ®å¤„ç†] å¾…å¤„ç†è®°å½•æ€»æ•°: ${storedRecords.length} æ¡`);
    console.info(`[æ•°æ®å¤„ç†] ç±»å‹å®‰å…¨: ä½¿ç”¨CategoryFlagsç±»æ›¿ä»£å¯¹è±¡å­—é¢é‡`);

    const processedRecords: HeartRateRecord[] = [];
    const categoryFlags = new CategoryFlags();

    storedRecords.forEach((record: StoredHeartRateData, index: number) => {
      console.info(`[æ•°æ®å¤„ç†] å¤„ç†ç¬¬ ${index + 1}/${storedRecords.length} æ¡è®°å½•`);
      console.info(`[æ•°æ®å¤„ç†] è®°å½•è¯¦æƒ…: ${record.toString()}`);

      const heartRateValue = parseInt(record.value) || 0;
      if (heartRateValue <= 0) {
        console.warn(`[æ•°æ®å¤„ç†] å¿ƒç‡æ•°å€¼æ— æ•ˆ: ${record.value}, è·³è¿‡å¤„ç†`);
        return;
      }

      const timeStr = this.extractTimeFromTimestamp(record.timestamp);
      const status = this.getHeartRateStatus(heartRateValue);
      const category = record.additionalInfo?.category || 'å®æ—¶';
      const categoryLower = category.toLowerCase();

      console.info(`[æ•°æ®å¤„ç†] å¿ƒç‡å€¼: ${heartRateValue} bpm, åŸå§‹ç±»åˆ«: "${category}"`);
      console.info(`[æ•°æ®å¤„ç†] ç±»åˆ«åˆ†æ: "${categoryLower}"`);

      // ä¸¥æ ¼çš„ç±»åˆ«è¯†åˆ«å’Œåˆ†ç±»å¤„ç†
      if (categoryLower.includes('å½“å‰') || categoryLower.includes('current')) {
        if (!categoryFlags.current) {
          this.currentHeartRate = heartRateValue;
          categoryFlags.current = true;
          console.info(`[æ•°æ®å¤„ç†] âœ… è®¾ç½®å½“å‰å¿ƒç‡: ${heartRateValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('é™æ¯') || categoryLower.includes('resting')) {
        if (!categoryFlags.resting) {
          this.restingHeartRate = heartRateValue;
          categoryFlags.resting = true;
          console.info(`[æ•°æ®å¤„ç†] âœ… è®¾ç½®é™æ¯å¿ƒç‡: ${heartRateValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('æœ€é«˜') || categoryLower.includes('max') || categoryLower.includes('highest')) {
        if (!categoryFlags.max) {
          this.maxHeartRate = heartRateValue;
          categoryFlags.max = true;
          console.info(`[æ•°æ®å¤„ç†] âœ… è®¾ç½®æœ€é«˜å¿ƒç‡: ${heartRateValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('æœ€ä½') || categoryLower.includes('min') || categoryLower.includes('lowest')) {
        if (!categoryFlags.min) {
          this.minHeartRate = heartRateValue;
          categoryFlags.min = true;
          console.info(`[æ•°æ®å¤„ç†] âœ… è®¾ç½®æœ€ä½å¿ƒç‡: ${heartRateValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('å¹³å‡') || categoryLower.includes('avg') || categoryLower.includes('average')) {
        if (!categoryFlags.avg) {
          this.avgHeartRate = heartRateValue;
          categoryFlags.avg = true;
          console.info(`[æ•°æ®å¤„ç†] âœ… è®¾ç½®å¹³å‡å¿ƒç‡: ${heartRateValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else {
        // åªæœ‰çœŸæ­£çš„å®æ—¶è®°å½•æ‰æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        const heartRateRecord = new HeartRateRecord(timeStr, heartRateValue, status, record.timestamp, category);
        processedRecords.push(heartRateRecord);
        console.info(`[æ•°æ®å¤„ç†] âœ… æ·»åŠ å®æ—¶è®°å½•: ${heartRateRecord.toString()}`);
      }

      // ä»additionalInfoä¸­æå–ç»Ÿè®¡æ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      if (record.additionalInfo) {
        this.extractAdditionalStatistics(record.additionalInfo, categoryFlags);
      }
    });

    // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
    processedRecords.sort((a: HeartRateRecord, b: HeartRateRecord) =>
    b.timestamp.localeCompare(a.timestamp)
    );

    this.heartRateRecords = processedRecords;

    console.info('[æ•°æ®å¤„ç†] ======== å¿ƒç‡è®°å½•å¤„ç†å®Œæˆï¼ˆç±»å‹å®‰å…¨ç‰ˆï¼‰ ========');
    console.info(`[æ•°æ®å¤„ç†] åˆ†ç±»æ ‡å¿—çŠ¶æ€: ${categoryFlags.toString()}`);
    console.info(`[æ•°æ®å¤„ç†] æœ€ç»ˆç»Ÿè®¡: å½“å‰=${this.currentHeartRate}, é™æ¯=${this.restingHeartRate}, æœ€é«˜=${this.maxHeartRate}, æœ€ä½=${this.minHeartRate}, å¹³å‡=${this.avgHeartRate}`);
    console.info(`[æ•°æ®å¤„ç†] å®æ—¶è®°å½•æ•°é‡: ${processedRecords.length} æ¡ï¼ˆçº¯å®æ—¶æ•°æ®ï¼‰`);
  }

  private extractAdditionalStatistics(additionalInfo: HeartRateAdditionalInfo, categoryFlags: CategoryFlags): void {
    console.info(`[ç»Ÿè®¡æå–] æ£€æŸ¥é™„åŠ ç»Ÿè®¡ä¿¡æ¯: ${additionalInfo.toString()}`);
    console.info(`[ç»Ÿè®¡æå–] å½“å‰åˆ†ç±»æ ‡å¿—çŠ¶æ€: ${categoryFlags.toString()}`);

    if (additionalInfo.maxValue && additionalInfo.maxValue !== '' && !categoryFlags.max) {
      const maxValue = parseInt(additionalInfo.maxValue) || 0;
      if (maxValue > 0) {
        this.maxHeartRate = maxValue;
        categoryFlags.max = true;
        console.info(`[ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®æœ€é«˜å¿ƒç‡: ${maxValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    if (additionalInfo.avgValue && additionalInfo.avgValue !== '' && !categoryFlags.avg) {
      const avgValue = parseInt(additionalInfo.avgValue) || 0;
      if (avgValue > 0) {
        this.avgHeartRate = avgValue;
        categoryFlags.avg = true;
        console.info(`[ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®å¹³å‡å¿ƒç‡: ${avgValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    if (additionalInfo.minValue && additionalInfo.minValue !== '' && !categoryFlags.min) {
      const minValue = parseInt(additionalInfo.minValue) || 0;
      if (minValue > 0) {
        this.minHeartRate = minValue;
        categoryFlags.min = true;
        console.info(`[ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®æœ€ä½å¿ƒç‡: ${minValue} bpmï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    console.info(`[ç»Ÿè®¡æå–] æå–å®Œæˆååˆ†ç±»æ ‡å¿—çŠ¶æ€: ${categoryFlags.toString()}`);
  }

  private extractTimeFromTimestamp(timestamp: string): string {
    if (!timestamp) return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });

    if (timestamp.includes(' ')) {
      const timePart = timestamp.split(' ')[1];
      if (timePart && timePart.includes(':')) {
        const timeComponents = timePart.split(':');
        return `${timeComponents[0]}:${timeComponents[1]}`;
      }
    }

    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
      return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    }

    return new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
  }

  private getHeartRateStatus(value: number): string {
    if (value < 60) return getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_low_status_62938475'));
    if (value <= 100) return getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_normal_status_84739261'));
    if (value <= 120) return getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_slightly_high_status_57382946'));
    return getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_high_status_39284751'));
  }

  private calculateHeartRateStatistics(): void {
    console.info('[ç»Ÿè®¡è®¡ç®—] ======== å¼€å§‹è®¡ç®—å¿ƒç‡ç»Ÿè®¡æ•°æ® ========');
    console.info('[ç»Ÿè®¡è®¡ç®—] å½“å‰ç”¨æˆ·: gadz2021, è®¡ç®—æ—¶é—´: 2025-05-31 02:54:09 UTC');
    console.info(`[ç»Ÿè®¡è®¡ç®—] å½“å‰çŠ¶æ€: å½“å‰=${this.currentHeartRate}, é™æ¯=${this.restingHeartRate}, æœ€é«˜=${this.maxHeartRate}, å¹³å‡=${this.avgHeartRate}, æœ€ä½=${this.minHeartRate}`);
    console.info(`[ç»Ÿè®¡è®¡ç®—] å®æ—¶è®°å½•æ•°é‡: ${this.heartRateRecords.length} æ¡`);

    // å¦‚æœæŸäº›ç»Ÿè®¡æ•°æ®ç¼ºå¤±ï¼Œä»å®æ—¶è®°å½•ä¸­è®¡ç®—
    if (this.heartRateRecords.length > 0) {
      const values = this.heartRateRecords.map((record: HeartRateRecord) => record.value);
      console.info(`[ç»Ÿè®¡è®¡ç®—] å®æ—¶è®°å½•å¿ƒç‡æ•°å€¼: ${values.join(', ')}`);

      if (this.minHeartRate === 0) {
        this.minHeartRate = Math.min(...values);
        console.info(`[ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—æœ€ä½å¿ƒç‡: ${this.minHeartRate} bpm`);
      }

      if (this.maxHeartRate === 0) {
        this.maxHeartRate = Math.max(...values);
        console.info(`[ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—æœ€é«˜å¿ƒç‡: ${this.maxHeartRate} bpm`);
      }

      if (this.avgHeartRate === 0) {
        this.avgHeartRate = Math.round(values.reduce((sum: number, value: number) => sum + value, 0) / values.length);
        console.info(`[ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—å¹³å‡å¿ƒç‡: ${this.avgHeartRate} bpm`);
      }
    }

    // æ›´æ–°ç»Ÿè®¡å¯¹è±¡
    this.heartRateStats.currentValue = this.currentHeartRate;
    this.heartRateStats.restingValue = this.restingHeartRate;
    this.heartRateStats.minValue = this.minHeartRate;
    this.heartRateStats.maxValue = this.maxHeartRate;
    this.heartRateStats.avgValue = this.avgHeartRate;
    this.heartRateStats.recordCount = this.heartRateRecords.length;

    console.info('[ç»Ÿè®¡è®¡ç®—] ======== å¿ƒç‡ç»Ÿè®¡è®¡ç®—å®Œæˆ ========');
    console.info(`[ç»Ÿè®¡è®¡ç®—] æœ€ç»ˆç»Ÿè®¡: ${this.heartRateStats.toString()}`);
  }

  private loadDefaultHeartRateData(): void {
    console.info('[é»˜è®¤æ•°æ®] ======== åŠ è½½é»˜è®¤å¿ƒç‡æ•°æ® ========');
    console.info('[é»˜è®¤æ•°æ®] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');

    const defaultRecords: HeartRateRecord[] = [
      new HeartRateRecord('08:00', 75, 'æ­£å¸¸', '2025-05-31 08:00:00', 'å®æ—¶'),
      new HeartRateRecord('10:30', 82, 'æ­£å¸¸', '2025-05-31 10:30:00', 'å®æ—¶'),
      new HeartRateRecord('12:15', 68, 'æ­£å¸¸', '2025-05-31 12:15:00', 'å®æ—¶')
    ];

    this.heartRateRecords = defaultRecords;
    this.currentHeartRate = 75;
    this.restingHeartRate = 65;
    this.minHeartRate = 68;
    this.maxHeartRate = 82;
    this.avgHeartRate = 75;

    this.heartRateStats.currentValue = this.currentHeartRate;
    this.heartRateStats.restingValue = this.restingHeartRate;
    this.heartRateStats.minValue = this.minHeartRate;
    this.heartRateStats.maxValue = this.maxHeartRate;
    this.heartRateStats.avgValue = this.avgHeartRate;
    this.heartRateStats.recordCount = defaultRecords.length;

    console.info('[é»˜è®¤æ•°æ®] ======== é»˜è®¤æ•°æ®åŠ è½½å®Œæˆ ========');
  }

  private refreshHeartRateData(): void {
    console.info('[æ•°æ®åˆ·æ–°] ======== å¼€å§‹åˆ·æ–°å¿ƒç‡æ•°æ® ========');
    console.info('[æ•°æ®åˆ·æ–°] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');

    this.isLoading = true;
    this.errorMessage = '';
    this.initializeHeartRateSystem();
  }

  private showRecordDetail(record: HeartRateRecord): void {
    console.info(`[è®°å½•è¯¦æƒ…] ======== æ˜¾ç¤ºå¿ƒç‡è®°å½•è¯¦æƒ… ========`);
    console.info(`[è®°å½•è¯¦æƒ…] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC`);
    console.info(`[è®°å½•è¯¦æƒ…] è®°å½•è¯¦æƒ…: ${record.toString()}`);

    const timeLabel = getContext(this).resourceManager.getStringSync($r('app.string.record_time_label_84739261')).replace('{0}', record.time);
    const valueLabel = getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_value_label_57382946')).replace('{0}', record.value.toString());
    const statusLabel = getContext(this).resourceManager.getStringSync($r('app.string.health_status_label_39284751')).replace('{0}', record.status);
    const typeLabel = getContext(this).resourceManager.getStringSync($r('app.string.record_type_label_75839462')).replace('{0}', record.category);
    const adviceLabel = getContext(this).resourceManager.getStringSync($r('app.string.health_advice_label_18475936')).replace('{0}', this.getHealthAdviceForValue(record.value));

    const detailMessage = `${timeLabel}\n${valueLabel}\n${statusLabel}\n${typeLabel}\n\n${adviceLabel}`;

    AlertDialog.show({
      title: getContext(this).resourceManager.getStringSync($r('app.string.record_detail_title_18475936')),
      message: detailMessage,
      primaryButton: {
        value: getContext(this).resourceManager.getStringSync($r('app.string.close_button_text_62938475')),
        action: () => {
          console.info('[è®°å½•è¯¦æƒ…] ç”¨æˆ·å…³é—­è¯¦æƒ…å¼¹çª—');
          console.info('[è®°å½•è¯¦æƒ…] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
        }
      }
    });
  }

  private getHealthAdviceForValue(value: number): string {
    if (value < 60) return getContext(this).resourceManager.getStringSync($r('app.string.low_heart_rate_advice_75839462'));
    if (value <= 100) return getContext(this).resourceManager.getStringSync($r('app.string.normal_heart_rate_advice_18475936'));
    if (value <= 120) return getContext(this).resourceManager.getStringSync($r('app.string.slightly_high_advice_62938475'));
    return getContext(this).resourceManager.getStringSync($r('app.string.high_heart_rate_advice_84739261'));
  }

  private getStatusColor(value: number): string {
    if (value < 60) return '#FBBC05';
    if (value <= 100) return '#34A853';
    if (value <= 120) return '#FF9800';
    return '#EA4335';
  }

  private getStatusBackgroundColor(value: number): string {
    if (value < 60) return 'rgba(251, 188, 5, 0.1)';
    if (value <= 100) return 'rgba(52, 168, 83, 0.1)';
    if (value <= 120) return 'rgba(255, 152, 0, 0.1)';
    return 'rgba(234, 67, 53, 0.1)';
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(24).height(24)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»è¿”å›æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
          try {
            router.back();
            console.info('[ç”¨æˆ·æ“ä½œ] è·¯ç”±è¿”å›æˆåŠŸ');
          } catch (err) {
            console.error('[ç”¨æˆ·æ“ä½œ] è·¯ç”±è¿”å›å¤±è´¥ï¼Œæ‰§è¡Œé™çº§æ–¹æ¡ˆ');
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(44).height(44).backgroundColor(Color.Transparent).margin({ left: 12 })

        Text(getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_monitoring_title_84729638'))).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333333')
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
          this.refreshHeartRateData();
        })
        .width(44).height(44).backgroundColor(Color.Transparent).margin({ right: 12 })
      }
      .width('100%').height(64).justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor('#FFFFFF').shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#EA4335')
          Text(getContext(this).resourceManager.getStringSync($r('app.string.loading_heart_rate_data_57284916'))).fontSize(18).fontColor('#333333')
          Text(getContext(this).resourceManager.getStringSync($r('app.string.current_user_prefix_39475829'))).fontSize(12).fontColor('#999999')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column({ space: 20 }) {
          Text('ğŸ’”').fontSize(64)
          Text(getContext(this).resourceManager.getStringSync($r('app.string.heart_rate_load_failed_75163948'))).fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button(getContext(this).resourceManager.getStringSync($r('app.string.reload_button_text_18394756')))
            .onClick(() => {
              console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»é‡æ–°åŠ è½½æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 02:54:09 UTC');
              this.isLoading = true;
              this.errorMessage = '';
              this.initializeHeartRateSystem();
            })
            .backgroundColor('#EA4335').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        // æ­£å¸¸å†…å®¹
        Scroll() {
          Column({ space: 20 }) {
            // å½“å‰å¿ƒç‡å¡ç‰‡
            Column({ space: 16 }) {
              Text(getContext(this).resourceManager.getStringSync($r('app.string.current_heart_rate_62847593'))).fontSize(18).fontWeight(FontWeight.Bold).textAlign(TextAlign.Center)
              Row({ space: 8 }) {
                Text('â¤ï¸').fontSize(32)
                Text(this.currentHeartRate.toString()).fontSize(48).fontWeight(FontWeight.Bold).fontColor('#EA4335')
                Text(getContext(this).resourceManager.getStringSync($r('app.string.bpm_unit_text_94738261'))).fontSize(20).fontColor('#666666').margin({ bottom: 8 })
              }
              .justifyContent(FlexAlign.Center).alignItems(VerticalAlign.Bottom)

              Text(this.getHeartRateStatus(this.currentHeartRate))
                .fontSize(16).fontColor(this.getStatusColor(this.currentHeartRate))
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(this.getStatusBackgroundColor(this.currentHeartRate)).borderRadius(12)

              Text(getContext(this).resourceManager.getStringSync($r('app.string.normal_range_text_84751639'))).fontSize(14).fontColor('#999999').textAlign(TextAlign.Center)
              Text(getContext(this).resourceManager.getStringSync($r('app.string.resting_heart_rate_57382946')).replace('{0}', this.restingHeartRate.toString())).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
            }
            .width('100%').padding(24).backgroundColor('#FFFFFF').borderRadius(16)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetY: 4 })

            // ç»Ÿè®¡å¡ç‰‡
            Row({ space: 12 }) {
              // ä½¿ç”¨æ˜ç¡®å®šä¹‰çš„ç±»æ›¿ä»£å¯¹è±¡å­—é¢é‡
              Column({ space: 8 }) {
                Text('ğŸ“‰').fontSize(20)
                Text(getContext(this).resourceManager.getStringSync($r('app.string.lowest_heart_rate_39284751'))).fontSize(12).fontColor('#999999').textAlign(TextAlign.Center)
                Row({ space: 4 }) {
                  Text(this.minHeartRate.toString()).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#4285F4')
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.bpm_unit_text_94738261'))).fontSize(12).fontColor('#666666').margin({ bottom: 2 })
                }
                .justifyContent(FlexAlign.Center).alignItems(VerticalAlign.Bottom)
              }
              .width('30%').height(100).padding(12).backgroundColor('#FFFFFF').borderRadius(12)
              .justifyContent(FlexAlign.Center).border({ width: 1, color: '#4285F4' })
              .shadow({ radius: 6, color: 'rgba(0,0,0,0.06)', offsetY: 3 })

              Column({ space: 8 }) {
                Text('ğŸ“Š').fontSize(20)
                Text(getContext(this).resourceManager.getStringSync($r('app.string.average_heart_rate_75839462'))).fontSize(12).fontColor('#999999').textAlign(TextAlign.Center)
                Row({ space: 4 }) {
                  Text(this.avgHeartRate.toString()).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#34A853')
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.bpm_unit_text_94738261'))).fontSize(12).fontColor('#666666').margin({ bottom: 2 })
                }
                .justifyContent(FlexAlign.Center).alignItems(VerticalAlign.Bottom)
              }
              .width('30%').height(100).padding(12).backgroundColor('#FFFFFF').borderRadius(12)
              .justifyContent(FlexAlign.Center).border({ width: 1, color: '#34A853' })
              .shadow({ radius: 6, color: 'rgba(0,0,0,0.06)', offsetY: 3 })

              Column({ space: 8 }) {
                Text('ğŸ“ˆ').fontSize(20)
                Text(getContext(this).resourceManager.getStringSync($r('app.string.highest_heart_rate_18475936'))).fontSize(12).fontColor('#999999').textAlign(TextAlign.Center)
                Row({ space: 4 }) {
                  Text(this.maxHeartRate.toString()).fontSize(20).fontWeight(FontWeight.Bold).fontColor('#EA4335')
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.bpm_unit_text_94738261'))).fontSize(12).fontColor('#666666').margin({ bottom: 2 })
                }
                .justifyContent(FlexAlign.Center).alignItems(VerticalAlign.Bottom)
              }
              .width('30%').height(100).padding(12).backgroundColor('#FFFFFF').borderRadius(12)
              .justifyContent(FlexAlign.Center).border({ width: 1, color: '#EA4335' })
              .shadow({ radius: 6, color: 'rgba(0,0,0,0.06)', offsetY: 3 })
            }
            .width('100%').justifyContent(FlexAlign.SpaceBetween)

            // å¿ƒç‡è®°å½•åˆ—è¡¨
            Column({ space: 16 }) {
              Row() {
                Text(getContext(this).resourceManager.getStringSync($r('app.string.realtime_heart_records_62938475'))).fontSize(18).fontWeight(FontWeight.Bold)
                Blank()
                Text(getContext(this).resourceManager.getStringSync($r('app.string.total_records_count_84739261')).replace('{0}', this.heartRateRecords.length.toString())).fontSize(12).fontColor('#999999')
                  .padding({ left: 12, right: 12, top: 6, bottom: 6 }).backgroundColor('#F0F0F0').borderRadius(12)
              }

              if (this.heartRateRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ’”').fontSize(48)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.no_realtime_records_57382946'))).fontSize(18).fontColor('#666666')
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.realtime_only_description_39284751'))).fontSize(12).fontColor('#999999').textAlign(TextAlign.Center)
                  Button(getContext(this).resourceManager.getStringSync($r('app.string.refresh_data_button_75839462'))).onClick(() => this.refreshHeartRateData())
                    .backgroundColor('#EA4335').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                List({ space: 8 }) {
                  ForEach(this.heartRateRecords, (record: HeartRateRecord) => {
                    ListItem() {
                      Row({ space: 16 }) {
                        Column({ space: 4 }) {
                          Text(record.time).fontSize(16).fontColor('#333333')
                          Text(record.category).fontSize(12).fontColor('#999999')
                        }
                        .alignItems(HorizontalAlign.Start)

                        Blank()

                        Column({ space: 4 }) {
                          Row({ space: 4 }) {
                            Text('â¤ï¸').fontSize(14)
                            Text(`${record.value}`).fontSize(18).fontColor(this.getStatusColor(record.value)).fontWeight(FontWeight.Bold)
                            Text(getContext(this).resourceManager.getStringSync($r('app.string.bpm_unit_text_94738261'))).fontSize(12).fontColor('#666666')
                          }
                          .justifyContent(FlexAlign.Center)

                          Text(record.status).fontSize(12).fontColor(this.getStatusColor(record.value))
                            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                            .backgroundColor(this.getStatusBackgroundColor(record.value)).borderRadius(8)
                        }
                        .alignItems(HorizontalAlign.End)
                      }
                      .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)
                      .onClick(() => {
                        this.showRecordDetail(record);
                      })
                    }
                  })
                }
                .width('100%').height(300).scrollBar(BarState.Auto)
              }
            }
            .width('100%').padding(20).backgroundColor('#FFFFFF').borderRadius(16)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetY: 4 })

            // å¥åº·å»ºè®®
            Column({ space: 16 }) {
              Text(getContext(this).resourceManager.getStringSync($r('app.string.heart_health_tips_title_18475936'))).fontSize(18).fontWeight(FontWeight.Bold)
              Text(getContext(this).resourceManager.getStringSync($r('app.string.heart_health_tips_intro_62938475'))).fontSize(14).fontColor('#666666')

              Column({ space: 12 }) {
                Row({ space: 12 }) {
                  Text('ğŸ“Š').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.normal_range_tip_84739261'))).fontSize(14).fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('ğŸƒâ€â™‚ï¸').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.exercise_tip_57382946'))).fontSize(14).fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('â˜•').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.caffeine_tip_39284751'))).fontSize(14).fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('ğŸ‘¨â€âš•ï¸').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.consult_doctor_tip_75839462'))).fontSize(14).fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)
              }
            }
            .width('100%').padding(20).backgroundColor('#FFFFFF').borderRadius(16)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetY: 4 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }
}