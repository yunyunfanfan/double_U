import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest, RealtimeDataResponse, RealtimeDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

///è¿™æ˜¯å¿ƒç‡é¡µé¢

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

// å¿ƒç‡è®°å½•æ•°æ®ç»“æ„
class HeartRateRecord {
  time: string = '';
  value: number = 0;
  status: string = '';
  dayOfWeek: string = '';

  constructor(time: string, value: number, status: string, dayOfWeek: string) {
    console.info(`[å¿ƒç‡è®°å½•æ„é€ ] åˆ›å»ºå¿ƒç‡è®°å½•: ${time}, ${value}bpm, ${status}, ${dayOfWeek}`);
    this.time = time;
    this.value = value;
    this.status = status;
    this.dayOfWeek = dayOfWeek;
  }

  toString(): string {
    return `HeartRateRecord{time: ${this.time}, value: ${this.value}bpm, status: ${this.status}}`;
  }
}

@Entry
@Component
export struct HeartRatePage {
  @State currentHeartRate: number = 0;
  @State restingHeartRate: number = 0;
  @State minHeartRate: number = 0;
  @State maxHeartRate: number = 0;
  @State avgHeartRate: number = 0;
  @State heartRateRecords: HeartRateRecord[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State userId: number = 0;

  private weekDays: string[] = [];

  aboutToAppear(): void {
    console.info('[å¿ƒç‡é¡µé¢] ================ å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ================');
    console.info('[å¿ƒç‡é¡µé¢] å½“å‰ç”¨æˆ·: gadz2021, ç³»ç»Ÿæ—¶é—´: 2025-06-08 13:21:16 UTC');
    this.weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    console.info('[å¿ƒç‡é¡µé¢] å¼€å§‹åˆå§‹åŒ–å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿ');
    this.initializeHeartRateSystem();
  }

  private async initializeHeartRateSystem(): Promise<void> {
    try {
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ========');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-06-08 13:21:16 UTC');
      this.resetHeartRateData();
      await this.getUserId();
      await this.loadHeartRateDataFromDatabase();
      await this.loadHeartRateRecordsFromDatabase();
      this.isLoading = false;
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¿ƒç‡ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ ========');
    } catch (error) {
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] å¿ƒç‡ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error}`);
      this.errorMessage = `å¿ƒç‡æ•°æ®åŠ è½½å¤±è´¥: ${error}`;
      this.isLoading = false;
      this.resetHeartRateData();
    }
  }

  private resetHeartRateData(): void {
    console.info('[æ•°æ®é‡ç½®] ======== é‡ç½®å¿ƒç‡æ•°æ®ä¸ºåˆå§‹çŠ¶æ€ ========');
    this.currentHeartRate = 0;
    this.restingHeartRate = 0;
    this.minHeartRate = 0;
    this.maxHeartRate = 0;
    this.avgHeartRate = 0;
    this.heartRateRecords = [];
    console.info('[æ•°æ®é‡ç½®] å¿ƒç‡æ•°æ®é‡ç½®å®Œæˆï¼Œæ‰€æœ‰å€¼å·²è®¾ä¸º0');
  }

  private async getUserId(): Promise<void> {
    try {
      console.info('[ç”¨æˆ·ID] === å¼€å§‹è·å–ç”¨æˆ·ID ===');
      const userInfoStr = AppStorage.get<string>('userInfo');
      const userInfo: UserInfo = userInfoStr ? JSON.parse(userInfoStr) as UserInfo : {};      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        console.info(`[ç”¨æˆ·ID] === è·å–åˆ°ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('[ç”¨æˆ·ID] === æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
      }
    } catch (error) {
      console.error(`[ç”¨æˆ·ID] === è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
    }
  }

  private async loadHeartRateDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('[å¿ƒç‡æ•°æ®] === ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`[å¿ƒç‡æ•°æ®] === å¼€å§‹åŠ è½½å¿ƒç‡æ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      let heartRateResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 1, true);
      console.info(`[å¿ƒç‡æ•°æ®] === å¿ƒç‡æ•°æ®å“åº”: ${JSON.stringify(heartRateResponse)} ===`);

      if (heartRateResponse.success && heartRateResponse.data && heartRateResponse.data.length > 0) {
        let todayData: HealthDataRequest = heartRateResponse.data[0];
        console.info(`[å¿ƒç‡æ•°æ®] === ä»Šæ—¥æ•°æ®: ${JSON.stringify(todayData)} ===`);

        this.currentHeartRate = todayData.current_heart_rate || 0;
        this.restingHeartRate = todayData.resting_heart_rate || 0;
        this.minHeartRate = todayData.min_heart_rate || 0;
        this.avgHeartRate = todayData.avg_heart_rate || 0;
        this.maxHeartRate = todayData.max_heart_rate || 0;

        console.info(`[å¿ƒç‡æ•°æ®] === å¿ƒç‡ç»Ÿè®¡: å½“å‰=${this.currentHeartRate}bpm, é™æ¯=${this.restingHeartRate}bpm, æœ€ä½=${this.minHeartRate}bpm, å¹³å‡=${this.avgHeartRate}bpm, æœ€é«˜=${this.maxHeartRate}bpm ===`);
      } else {
        console.warn('[å¿ƒç‡æ•°æ®] === ä»Šæ—¥å¿ƒç‡æ•°æ®ä¸ºç©º ===');
      }
    } catch (error) {
      console.error(`[å¿ƒç‡æ•°æ®] === æ•°æ®åŠ è½½å¼‚å¸¸: ${error} ===`);
      throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}`);
    }
  }

  private async loadHeartRateRecordsFromDatabase(): Promise<void> {
    try {
      console.info(`[å¿ƒç‡è®°å½•] === å¼€å§‹åŠ è½½å¿ƒç‡è®°å½•ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      let realtimeResponse: RealtimeDataResponse = await userApiService.getRealtimeData(this.userId, 'heart_rate', 7);
      console.info(`[å¿ƒç‡è®°å½•] === å®æ—¶å¿ƒç‡æ•°æ®å“åº”: ${JSON.stringify(realtimeResponse)} ===`);

      if (realtimeResponse.success && realtimeResponse.data) {
        let records: HeartRateRecord[] = [];

        for (let i: number = 0; i < realtimeResponse.data.length; i++) {
          let item: RealtimeDataRequest = realtimeResponse.data[i];
          let heartRateValue: number = item.value || 0;
          let status: string = this.getHeartRateStatus(heartRateValue);
          let time: string = item.time_stamp || '';
          let dayOfWeek: string = this.extractDayOfWeek(time);

          let record: HeartRateRecord = new HeartRateRecord(time, heartRateValue, status, dayOfWeek);
          records.push(record);
        }

        this.heartRateRecords = records;
        console.info(`[å¿ƒç‡è®°å½•] === å¿ƒç‡è®°å½•åŠ è½½å®Œæˆï¼Œæ€»è®¡${records.length}æ¡ ===`);
      }
    } catch (error) {
      console.error(`[å¿ƒç‡è®°å½•] === åŠ è½½å¿ƒç‡è®°å½•å¼‚å¸¸: ${error} ===`);
    }
  }

  private getHeartRateStatus(value: number): string {
    console.info(`[å¿ƒç‡çŠ¶æ€] åˆ¤æ–­å¿ƒç‡çŠ¶æ€: ${value}bpm`);
    if (value < 60) return 'åä½';
    if (value <= 100) return 'æ­£å¸¸';
    if (value <= 120) return 'ç•¥é«˜';
    return 'åé«˜';
  }

  private extractDayOfWeek(timestamp: string): string {
    if (!timestamp) {
      return this.weekDays[new Date().getDay()];
    }
    let date: Date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
      return this.weekDays[date.getDay()];
    }
    return this.weekDays[new Date().getDay()];
  }

  private getStatusColor(value: number): string {
    if (value < 60) return '#FBBC05';
    if (value <= 100) return '#34A853';
    if (value <= 120) return '#FF9800';
    return '#EA4335';
  }

  private getStatusBackgroundColor(value: number): string {
    if (value < 60) return 'rgba(251, 188, 5, 0.1)';
    if (value <= 100) return 'rgba(52, 168, 83, 0.1)';
    if (value <= 120) return 'rgba(255, 152, 0, 0.1)';
    return 'rgba(234, 67, 53, 0.1)';
  }

  private refreshHeartRateData(): void {
    console.info('[æ•°æ®åˆ·æ–°] === å¼€å§‹åˆ·æ–°å¿ƒç‡æ•°æ® ===');
    this.isLoading = true;
    this.errorMessage = '';
    this.initializeHeartRateSystem();
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»è¿”å›æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021');
          try {
            router.back();
          } catch (err) {
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text('å¿ƒç‡ç›‘æµ‹')
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»åˆ·æ–°å¿ƒç‡æ•°æ®æŒ‰é’®');
          this.refreshHeartRateData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#EA4335')
          Text('æ­£åœ¨åŠ è½½å¿ƒç‡æ•°æ®...')
            .fontSize(18).fontColor('#333333')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ’”').fontSize(64)
          Text('åŠ è½½å¤±è´¥')
            .fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshHeartRateData())
            .backgroundColor('#EA4335').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            // å½“å‰å¿ƒç‡å¡ç‰‡
            Column() {
              Text(`å½“å‰å¿ƒç‡ (${this.weekDays[new Date().getDay()]})`)
                .fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 20 })

              Row() {
                Text('â¤ï¸').fontSize(32)
                Text(this.currentHeartRate.toString())
                  .fontSize(48).fontWeight(FontWeight.Bold).fontColor('#EA4335')
                Text(' bpm').fontSize(20).fontColor('#666666').margin({ bottom: 8 })
              }
              .justifyContent(FlexAlign.Center).alignItems(VerticalAlign.Bottom)

              Text(this.getHeartRateStatus(this.currentHeartRate))
                .fontSize(16).fontColor(this.getStatusColor(this.currentHeartRate))
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor(this.getStatusBackgroundColor(this.currentHeartRate)).borderRadius(12)

              Text('æ­£å¸¸èŒƒå›´ï¼š60-100 bpm')
                .fontSize(14).fontColor('#666666').margin({ top: 5 })

              Text(`é™æ¯å¿ƒç‡ï¼š${this.restingHeartRate} bpm`)
                .fontSize(14).fontColor('#666666').margin({ top: 5 })
            }
            .width('90%').padding(30).backgroundColor('#FFFFFF').borderRadius(20)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 4 })

            // ç»Ÿè®¡æ•°æ®
            Row() {
              this.statCard('æœ€ä½', `${this.minHeartRate} bpm`, '#4285F4')
              this.statCard('å¹³å‡', `${this.avgHeartRate} bpm`, '#34A853')
              this.statCard('æœ€é«˜', `${this.maxHeartRate} bpm`, '#EA4335')
            }
            .width('90%').justifyContent(FlexAlign.SpaceBetween)

            // å¿ƒç‡è®°å½•åˆ—è¡¨
            Column() {
              Text('å¿ƒç‡è®°å½•')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              if (this.heartRateRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ’”').fontSize(48)
                  Text('æš‚æ— å¿ƒç‡æ•°æ®')
                    .fontSize(18).fontColor('#666666')
                  Button('åˆ·æ–°æ•°æ®')
                    .onClick(() => this.refreshHeartRateData())
                    .backgroundColor('#EA4335').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                Column({ space: 12 }) {
                  ForEach(this.heartRateRecords, (record: HeartRateRecord, index: number) => {
                    Row() {
                      Row() {
                        Text('â¤ï¸').fontSize(20)
                      }
                      .width(44).height(44).borderRadius(22)
                      .backgroundColor(this.getStatusBackgroundColor(record.value))
                      .justifyContent(FlexAlign.Center).margin({ right: 16 })

                      Column() {
                        Row() {
                          Text(`${record.value} bpm`)
                            .fontSize(16).fontWeight(FontWeight.Medium)
                            .fontColor(this.getStatusColor(record.value))
                          Blank()
                          Text(record.time)
                            .fontSize(12).fontColor('#999999')
                        }
                        .width('100%')

                        Text(record.status)
                          .fontSize(14).fontColor('#666666').margin({ top: 4 })
                          .textAlign(TextAlign.Start).width('100%')
                      }
                      .layoutWeight(1).alignItems(HorizontalAlign.Start)
                    }
                    .width('100%').height(60).padding({ top: 8, bottom: 8, left: 12, right: 12 })
                    .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(12)
                    .alignItems(VerticalAlign.Center)
                  })
                }
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })

            // å¥åº·å»ºè®®
            Column() {
              Text('å¿ƒç‡å¥åº·å»ºè®®')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              Column({ space: 12 }) {
                this.buildAdviceItem('æ­£å¸¸å¿ƒç‡èŒƒå›´60-100 bpm', 'ğŸ“Š')
                this.buildAdviceItem('é€‚é‡è¿åŠ¨æœ‰åŠ©å¿ƒç‡å¥åº·', 'ğŸƒâ€â™‚ï¸')
                this.buildAdviceItem('é¿å…è¿‡é‡å’–å•¡å› æ‘„å…¥', 'â˜•')
                this.buildAdviceItem('å¼‚å¸¸æ—¶åŠæ—¶å’¨è¯¢åŒ»ç”Ÿ', 'ğŸ‘¨â€âš•ï¸')
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  @Builder
  statCard(title: string, value: string, color: string) {
    Column() {
      Text(title).fontSize(14).fontColor('#666666')
      Text(value).fontSize(18).fontWeight(FontWeight.Bold).fontColor(color)
    }
    .width('30%').padding(15).backgroundColor('#FFFFFF').borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .shadow({ radius: 6, color: 'rgba(0,0,0,0.06)', offsetY: 3 })
  }

  @Builder
  buildAdviceItem(advice: string, icon: string) {
    Row() {
      Text(icon).fontSize(20).margin({ right: 12 })
      Text(advice)
        .fontSize(14).fontColor('#333333').textAlign(TextAlign.Start)
        .layoutWeight(1).maxLines(3)
    }
    .width('100%').padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .backgroundColor('#F8F9FA').borderRadius(8).alignItems(VerticalAlign.Top)
  }
}