import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { DeepSeekService } from '../../../services/deepseek/DeepSeekService';
import { LvMarkdownIn, lvText, lvTitle, lvCode, lvLink, LMICallBack } from '@luvi/lv-markdown-in';
import { userApiService, HealthDataRequest, RegisterResponse } from '../../../services/api_network/UserApiService';

// å¥åº·æ•°æ®è§£æç»“æœç±»
class HealthDataParseResult {
  steps: number = 0;
  distance: number = 0;
  calories: number = 0;
  heart_rate: number = 0;
  blood_oxygen: number = 0;
  sleep_duration: number = 0;
  userMessage: string = '';

  constructor() {}

  toString(): string {
    return `HealthDataParseResult{steps: ${this.steps}, distance: ${this.distance}, calories: ${this.calories}}`;
  }
}

// å¯¹è¯é¡¹ç±»
class ConversationItem {
  role: string = '';
  content: string = '';

  constructor(role: string, content: string) {
    this.role = role;
    this.content = content;
  }
}

// æ¶ˆæ¯ç±»
class Message {
  type: string = '';
  content: string = '';
  time: string = '';
  isStreaming: boolean = false;

  constructor(type: string, content: string, time: string, isStreaming?: boolean) {
    this.type = type;
    this.content = content;
    this.time = time;
    this.isStreaming = isStreaming || false;
  }

  toString(): string {
    return `Message{type: "${this.type}", contentLength: ${this.content.length}, isStreaming: ${this.isStreaming}}`;
  }
}

// æµå¼å¤„ç†çŠ¶æ€ç±»
class StreamProcessingState {
  isResponseComplete: boolean = false;
  isDataParsed: boolean = false;
  isDataSaved: boolean = false;
  lastProcessedLength: number = 0;
  userFriendlyMessage: string = '';
  completionCallbackExecuted: boolean = false;
  processingRequestId: string = '';

  constructor() {}

  reset(): void {
    this.isResponseComplete = false;
    this.isDataParsed = false;
    this.isDataSaved = false;
    this.lastProcessedLength = 0;
    this.userFriendlyMessage = '';
    this.completionCallbackExecuted = false;
    this.processingRequestId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
  }
}

// AIä¿å­˜ç»“æœç±»
class AISaveResult {
  success: boolean = false;
  message: string = '';

  constructor(success: boolean, message: string) {
    this.success = success;
    this.message = message;
  }
}

@Entry
@Component
export struct HealthDataEntryPage {
  @State messages: Message[] = [];
  @State inputContent: string = '';
  @State isLoading: boolean = false;
  @State updateCounter: number = 0;
  @State isClearingDatabase: boolean = false;

  private conversation: ConversationItem[] = [];
  private cancelStream: (() => void) | null = null;
  private scrollerRef: Scroller = new Scroller();
  private inputController: TextInputController = new TextInputController();
  private streamState: StreamProcessingState = new StreamProcessingState();
  private currentUserId: number = 1; // å®é™…åº”ä»ç™»å½•çŠ¶æ€è·å–

  aboutToAppear(): void {
    this.initializeSystem();
  }

  private async initializeSystem(): Promise<void> {
    const currentTime = new Date().toLocaleString('zh-CN');

    const welcomeMessage = new Message(
      'assistant',
      'æ‚¨å¥½ï¼æˆ‘æ˜¯å¥åº·æ•°æ®å½•å…¥åŠ©æ‰‹ï¼Œè¯·å‘Šè¯‰æˆ‘æ‚¨çš„å¥åº·æ•°æ®ï¼Œæˆ‘ä¼šå¸®æ‚¨ç²¾ç¡®è®°å½•åˆ°æ•°æ®åº“ä¸­ã€‚',
      new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' })
    );

    this.messages = [welcomeMessage];

    const systemPrompt = this.buildPrecisionSystemPrompt(currentTime);
    const systemConversation = new ConversationItem('system', systemPrompt);
    const assistantConversation = new ConversationItem('assistant', welcomeMessage.content);

    this.conversation = [systemConversation, assistantConversation];

    this.configureUITheme();
  }

  private buildPrecisionSystemPrompt(currentTime: string): string {
    const currentDate = new Date();
    const currentWeekDay = currentDate.getDay();
    const weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    const todayWeekDay = weekDays[currentWeekDay];

    return `ä½ æ˜¯ç²¾ç¡®å¥åº·æ•°æ®å½•å…¥åŠ©æ‰‹ï¼Œå½“å‰æ—¶é—´ï¼š${currentTime}ï¼Œä»Šå¤©æ˜¯${todayWeekDay}

ã€é‡è¦ã€‘å¿…é¡»ä¿æŒæ•°å€¼ç²¾åº¦ï¼Œç‰¹åˆ«æ˜¯å°æ•°ç‚¹ï¼

ã€ä¸¥æ ¼æ ¼å¼è¦æ±‚ã€‘ä¸‰æ®µå¼å›å¤ï¼š

ç¬¬ä¸€æ®µï¼šæ•°æ®å½•å…¥å—
=== æ•°æ®å½•å…¥ ===
æ­¥æ•°:17777
è·ç¦»:5.9
çƒ­é‡:976
å¿ƒç‡:66
è¡€æ°§:97
ç¡çœ :474

ç¬¬äºŒæ®µï¼šåˆ†éš”ç¬¦
=== ç”¨æˆ·åé¦ˆ ===

ç¬¬ä¸‰æ®µï¼šç®€æ´ç¡®è®¤
âœ… ç²¾ç¡®æ•°æ®å·²ä¿å­˜ï¼
ğŸ“ è·ç¦»ï¼š5.9å…¬é‡Œï¼ˆç²¾ç¡®è®°å½•ï¼‰
ğŸš¶ æ­¥æ•°ï¼š17777æ­¥
â¤ï¸ å¿ƒç‡ï¼š66æ¬¡/åˆ†
ğŸ« è¡€æ°§ï¼š97%
ğŸ”¥ çƒ­é‡ï¼š976åƒå¡
ğŸ˜´ ç¡çœ ï¼š474åˆ†é’Ÿ

ã€æ•°å€¼ç²¾åº¦è¦æ±‚ã€‘
- è·ç¦»ï¼šå¿…é¡»ä¿ç•™å°æ•°ï¼ˆå¦‚5.9ã€6.2ï¼‰
- æ­¥æ•°ï¼šæ•´æ•°ï¼ˆå¦‚8666ï¼‰
- çƒ­é‡ï¼šæ”¯æŒå°æ•°ï¼ˆå¦‚323ã€323.5ï¼‰
- å¿ƒç‡ï¼šæ•´æ•°ï¼ˆå¦‚72ï¼‰
- è¡€æ°§ï¼šæ•´æ•°ï¼ˆå¦‚98ï¼‰
- ç¡çœ ï¼šåˆ†é’Ÿæ•°ï¼ˆå¦‚474è¡¨ç¤º7å°æ—¶54åˆ†é’Ÿï¼‰

ã€æ•°æ®ç±»å‹å¯¹åº”ã€‘
- æ­¥æ•° â†’ stepsï¼ˆæ­¥ï¼‰
- è·ç¦» â†’ distanceï¼ˆå…¬é‡Œï¼‰
- çƒ­é‡ â†’ caloriesï¼ˆåƒå¡ï¼‰
- å¿ƒç‡ â†’ heart_rateï¼ˆæ¬¡/åˆ†ï¼‰
- è¡€æ°§ â†’ blood_oxygenï¼ˆ%ï¼‰
- ç¡çœ  â†’ sleep_durationï¼ˆåˆ†é’Ÿï¼‰

ã€å…³é”®ã€‘æ•°å€¼å¿…é¡»ä¿æŒåŸå§‹ç²¾åº¦ï¼Œç»ä¸æˆªæ–­å°æ•°ï¼`;
  }

  private configureUITheme(): void {
    lvText.setTextSize(16);
    lvText.setTextLineHeight("24");
    lvTitle.setLevelTitleColor("#4CAF50");
    lvCode.setTheme("light");
    lvCode.setIndexState(true);
    lvLink.setTextColor("#4CAF50");
  }

  private parseHealthDataFromAI(aiResponse: string): HealthDataParseResult {
    console.info('[å¥åº·æ•°æ®è§£æ] å¼€å§‹è§£æAIå›å¤');

    const result = new HealthDataParseResult();

    try {
      let dataPart = '';
      let userPart = '';

      if (aiResponse.includes('=== æ•°æ®å½•å…¥ ===') && aiResponse.includes('=== ç”¨æˆ·åé¦ˆ ===')) {
        const parts = aiResponse.split('=== ç”¨æˆ·åé¦ˆ ===');
        dataPart = parts[0].replace('=== æ•°æ®å½•å…¥ ===', '').trim();
        userPart = parts[1] ? parts[1].trim() : '';
      } else {
        dataPart = aiResponse;
        userPart = aiResponse;
      }

      console.info(`[å¥åº·æ•°æ®è§£æ] æ•°æ®éƒ¨åˆ†: ${dataPart}`);

      // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–æ•°æ®
      const patterns: Record<string, RegExp> = {
        'steps': /æ­¥æ•°[:ï¼š]\s*(\d+)/,
        'distance': /è·ç¦»[:ï¼š]\s*([\d.]+)/,
        'calories': /çƒ­é‡[:ï¼š]\s*([\d.]+)/,
        'heart_rate': /å¿ƒç‡[:ï¼š]\s*(\d+)/,
        'blood_oxygen': /è¡€æ°§[:ï¼š]\s*(\d+)/,
        'sleep_duration': /ç¡çœ [:ï¼š]\s*(\d+)/
      };

      Object.keys(patterns).forEach((key: string) => {
        const match = dataPart.match(patterns[key]);
        if (match) {
          const value = parseFloat(match[1]);
          if (!isNaN(value)) {
            switch (key) {
              case 'steps':
                result.steps = Math.floor(value);
                break;
              case 'distance':
                result.distance = value;
                break;
              case 'calories':
                result.calories = value;
                break;
              case 'heart_rate':
                result.heart_rate = Math.floor(value);
                break;
              case 'blood_oxygen':
                result.blood_oxygen = Math.floor(value);
                break;
              case 'sleep_duration':
                result.sleep_duration = Math.floor(value);
                break;
            }
            console.info(`[å¥åº·æ•°æ®è§£æ] æå–${key}: ${value}`);
          }
        }
      });

      result.userMessage = userPart || 'æ•°æ®å½•å…¥å®Œæˆ';

      console.info(`[å¥åº·æ•°æ®è§£æ] è§£æç»“æœ: ${result.toString()}`);
      return result;

    } catch (error) {
      console.error('[å¥åº·æ•°æ®è§£æ] è§£æå¼‚å¸¸:', error);
      result.userMessage = aiResponse;
      return result;
    }
  }

  private async saveHealthDataToBackend(parseResult: HealthDataParseResult): Promise<AISaveResult> {
    try {
      console.info('[åç«¯ä¿å­˜] å¼€å§‹ä¿å­˜å¥åº·æ•°æ®åˆ°åç«¯');

      const requestData: HealthDataRequest = {
        user_id: this.currentUserId,
        record_date: new Date().toISOString().split('T')[0],
        steps: parseResult.steps,
        distance: parseResult.distance,
        active_calories: parseResult.calories,
        avg_heart_rate: parseResult.heart_rate,
        avg_blood_oxygen: parseResult.blood_oxygen,
        sleep_duration: parseResult.sleep_duration
      };

      // è°ƒç”¨åç«¯APIä¿å­˜å¥åº·æ•°æ®
      const response: RegisterResponse = await userApiService.saveHealthData(requestData);

      console.info(`[åç«¯ä¿å­˜] ä¿å­˜ç»“æœ: ${response.success}, æ¶ˆæ¯: ${response.message}`);

      return new AISaveResult(response.success, response.message);

    } catch (error) {
      console.error('[åç«¯ä¿å­˜] ä¿å­˜å¼‚å¸¸:', error);
      const errorMessage = error instanceof Error ? error.message : 'ç½‘ç»œè¿æ¥å¤±è´¥';
      return new AISaveResult(false, `ä¿å­˜å¤±è´¥: ${errorMessage}`);
    }
  }

  private scrollToBottom(): void {
    setTimeout(() => {
      try {
        this.scrollerRef.scrollEdge(Edge.Bottom);
      } catch (err) {
        console.error('[æ»šåŠ¨] æ»šåŠ¨åˆ°åº•éƒ¨å¤±è´¥:', err);
      }
    }, 100);
  }

  private sendToAI(userMessage: string): void {
    try {
      this.streamState.reset();

      const currentTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      const userMsg = new Message('user', userMessage, currentTime);
      this.messages.push(userMsg);
      this.scrollToBottom();

      const fullCurrentTime = new Date().toLocaleString('zh-CN');
      const contextualMessage = `å½“å‰æ—¶é—´ï¼š${fullCurrentTime}\nç²¾ç¡®å¥åº·æ•°æ®ï¼ˆä¿æŒå°æ•°ç²¾åº¦ï¼‰ï¼š${userMessage}`;

      const newConversation = new ConversationItem('user', contextualMessage);
      this.conversation.push(newConversation);

      const aiMessageIndex = this.messages.length;
      const aiMsg = new Message(
        'assistant',
        'æ­£åœ¨åˆ†ææ‚¨çš„å¥åº·æ•°æ®...',
        new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
        true
      );
      this.messages.push(aiMsg);
      this.scrollToBottom();

      let fullAIResponse = '';

      this.cancelStream = DeepSeekService.streamRequest(
        contextualMessage,
        this.conversation,

        (chunk: string) => {
          fullAIResponse = chunk;
          // å®æ—¶è§£æå¹¶æ˜¾ç¤ºç”¨æˆ·å‹å¥½ä¿¡æ¯
          const parseResult = this.parseHealthDataFromAI(fullAIResponse);
          if (parseResult.userMessage) {
            this.messages[aiMessageIndex].content = parseResult.userMessage;
            this.updateCounter++;
            this.messages = [...this.messages];
          }
        },

        async () => {
          if (this.streamState.completionCallbackExecuted) {
            return;
          }

          this.streamState.completionCallbackExecuted = true;
          this.isLoading = false;

          if (this.messages[aiMessageIndex]) {
            this.messages[aiMessageIndex].isStreaming = false;
          }

          // è§£æAIå›å¤
          const parseResult = this.parseHealthDataFromAI(fullAIResponse);

          // ä¿å­˜åˆ°åç«¯æ•°æ®åº“
          const saveResult = await this.saveHealthDataToBackend(parseResult);

          // æ›´æ–°ç”¨æˆ·æ¶ˆæ¯
          let finalMessage = parseResult.userMessage;
          if (saveResult.success) {
            finalMessage += '\n\nâœ… æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“';
          } else {
            finalMessage += `\n\nâŒ æ•°æ®ä¿å­˜å¤±è´¥: ${saveResult.message}`;
          }

          this.messages[aiMessageIndex].content = finalMessage;

          const assistantConversation = new ConversationItem('assistant', fullAIResponse);
          this.conversation.push(assistantConversation);

          this.updateCounter++;
          this.messages = [...this.messages];
          this.cancelStream = null;
          this.scrollToBottom();
        },

        (error: Error) => {
          this.isLoading = false;
          if (this.messages[aiMessageIndex]) {
            this.messages[aiMessageIndex].content = `åˆ†æå¤±è´¥: ${error.message}`;
            this.messages[aiMessageIndex].isStreaming = false;
          }

          this.updateCounter++;
          this.messages = [...this.messages];
          this.cancelStream = null;
          this.scrollToBottom();
          this.streamState.reset();
        }
      );
    } catch (err) {
      console.error('[AIå‘é€] å‘é€å¼‚å¸¸:', err);
      this.isLoading = false;
      this.streamState.reset();
      this.scrollToBottom();
    }
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(24).height(24)
        }
        .onClick(() => {
          try {
            router.back();
          } catch (err) {
            console.error('[å¯¼èˆª] è¿”å›å¤±è´¥:', err);
          }
        })
        .width(44).height(44).backgroundColor(Color.Transparent).margin({ left: 12 })

        Text('AIå¥åº·æ•°æ®å½•å…¥').fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333333')
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          if (this.isClearingDatabase) {
            LoadingProgress().width(20).height(20).color('#FF5722')
          } else {
            Text('ğŸ—‘ï¸').fontSize(18)
          }
        }
        .onClick(() => {
          if (!this.isClearingDatabase) {
            // æ¸…ç©ºä¼šè¯è®°å½•
            this.messages = this.messages.slice(0, 1); // ä¿ç•™æ¬¢è¿æ¶ˆæ¯
            this.conversation = this.conversation.slice(0, 2); // ä¿ç•™ç³»ç»Ÿæç¤ºå’Œæ¬¢è¿æ¶ˆæ¯
            this.updateCounter++;
          }
        })
        .enabled(!this.isClearingDatabase && !this.isLoading)
        .width(44).height(44).backgroundColor(Color.Transparent).margin({ right: 12 })
        .opacity(this.isClearingDatabase ? 0.6 : 1.0)
      }
      .width('100%').height(64).justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor('#FFFFFF').shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })

      Scroll(this.scrollerRef) {
        Column() {
          ForEach(this.messages, (msg: Message, index: number) => {
            Row() {
              if (msg.type === 'assistant') {
                Image($r('app.media.ic_service'))
                  .width(36).height(36).borderRadius(18)
                  .backgroundColor('#E8F5E8').padding(6)

                Column() {
                  Text(msg.time).fontSize(12).fontColor('#999').margin({ bottom: 4 })

                  LvMarkdownIn({
                    text: msg.content || 'æ­£åœ¨åˆ†ææ‚¨çš„å¥åº·æ•°æ®...',
                    loadMode: "text",
                    loadCallBack: {
                      success: (r: LMICallBack) => {
                        setTimeout(() => { this.scrollToBottom(); }, 50);
                      },
                      fail: (r: LMICallBack) => {
                        console.error('[Markdown] åŠ è½½å¤±è´¥');
                      }
                    }
                  })
                    .backgroundColor('#fff').borderRadius(16).padding(16)
                    .shadow({ radius: 3, color: '#E8F5E8', offsetY: 2 }).width('100%')

                  if (msg.isStreaming) {
                    Row() {
                      Text('æ­£åœ¨åˆ†æä¸­').fontSize(12).fontColor('#4CAF50').margin({ right: 8 })
                      ForEach([1, 2, 3], (i: number) => {
                        Text('â—').fontSize(14).fontColor('#4CAF50').opacity(0.3 + (i * 0.3))
                      })
                    }.width('100%').margin({ top: 8 })
                  }
                }.margin({ left: 10 }).width('82%')

                Blank()
              } else {
                Blank()

                Column() {
                  Text(msg.time).fontSize(12).fontColor('#999').margin({ bottom: 4 })
                  Text(msg.content).fontSize(16).fontColor('#fff').backgroundColor('#4CAF50')
                    .borderRadius(16).padding(16).lineHeight(24)
                }.margin({ right: 10 }).width('82%')

                Image($r('app.media.ic_user'))
                  .width(36).height(36).borderRadius(18)
                  .backgroundColor('#C8E6C9').padding(6)
              }
            }
            .width('100%').justifyContent(msg.type === 'user' ? FlexAlign.End : FlexAlign.Start)
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
          })
        }.width('100%').padding({ top: 12, bottom: 12 })
      }
      .layoutWeight(1).backgroundColor('#F8FFF8').scrollBar(BarState.Auto)

      if (this.isLoading) {
        Row() {
          LoadingProgress().width(28).height(28).color('#4CAF50')
          Text('æ­£åœ¨åˆ†ææ‚¨çš„å¥åº·æ•°æ®...').fontSize(14).fontColor('#4CAF50').margin({ left: 12 })
        }
        .justifyContent(FlexAlign.Center).width('100%').padding(12)
        .backgroundColor('#F0F8F0').borderRadius(8).margin({ left: 16, right: 16, bottom: 8 })
      }

      Row() {
        TextInput({
          placeholder: 'è¯·è¾“å…¥æ‚¨çš„å¥åº·æ•°æ®ï¼Œå¦‚ï¼šä»Šå¤©æˆ‘èµ°äº†8000æ­¥ï¼Œå¿ƒç‡å¹³å‡72æ¬¡...',
          text: this.inputContent,
          controller: this.inputController
        })
          .backgroundColor('#fff').borderRadius(24).border({ width: 1, color: '#4CAF50' })
          .padding({ left: 16, right: 16, top: 12, bottom: 12 }).fontSize(16).layoutWeight(1)
          .onChange((v: string) => {
            this.inputContent = v;
          })
          .enabled(!this.isLoading && !this.isClearingDatabase)
          .onSubmit(() => {
            if (this.inputContent && !this.isLoading && !this.isClearingDatabase) {
              const userMessage = this.inputContent;
              this.inputContent = '';
              this.isLoading = true;
              this.sendToAI(userMessage);
            }
          })

        Button({ type: ButtonType.Circle }) {
          Image(this.cancelStream ? $r('app.media.ic_stop') : $r('app.media.ic_send'))
            .width(24).height(24).fillColor(Color.White)
        }
        .onClick(() => {
          if (this.cancelStream) {
            this.cancelStream();
            this.cancelStream = null;
            this.isLoading = false;
            this.streamState.reset();
          } else {
            if (!this.inputContent || this.isLoading || this.isClearingDatabase) return;

            const userMessage = this.inputContent;
            this.inputContent = '';
            this.isLoading = true;
            this.sendToAI(userMessage);
          }
        })
        .enabled(!this.isClearingDatabase)
        .backgroundColor(this.cancelStream ? '#FF5252' : '#4CAF50').borderRadius(24)
        .width(50).height(50).margin({ left: 12 })
      }
      .padding(16).backgroundColor('#F8FFF8').border({ width: { top: 1 }, color: '#E8F5E8' })
    }
    .backgroundColor('#F8FFF8').height('100%')
  }
}