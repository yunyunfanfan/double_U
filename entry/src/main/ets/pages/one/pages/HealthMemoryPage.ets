import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

///ä¸ªæ€§åŒ–å¥åº·è®°å¿†é¡µé¢

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

interface RouterParams {
  user_id?: number;
}

// åˆ†æç»“æœç±»
class HealthAnalysisResult {
  title: string = '';
  content: string = '';

  constructor(title: string, content: string) {
    this.title = title;
    this.content = content;
  }

  toString(): string {
    return `HealthAnalysisResult{title: ${this.title}, contentLength: ${this.content.length}}`;
  }
}

// å±•ç¤ºç”¨çš„å¥åº·æ•°æ®ç»“æ„
class HealthData {
  steps: string = '';
  heartRate: string = '';
  sleepHours: string = '';
  calories: string = '';
  oxygenLevel: string = '';
  mood: string = '';
  stepGoal: string = '';

  constructor(steps: string, heartRate: string, sleepHours: string, calories: string, oxygenLevel: string, mood?: string, stepGoal?: string) {
    this.steps = steps;
    this.heartRate = heartRate;
    this.sleepHours = sleepHours;
    this.calories = calories;
    this.oxygenLevel = oxygenLevel;
    this.mood = mood || '';
    this.stepGoal = stepGoal || '';
  }

  toString(): string {
    return `HealthData{steps: ${this.steps}, heartRate: ${this.heartRate}, sleep: ${this.sleepHours}}`;
  }
}

class MemoryItem {
  date: string = '';
  title: string = '';
  content: string = '';
  healthData: HealthData;

  constructor(date: string, title: string, content: string, healthData: HealthData) {
    this.date = date;
    this.title = title;
    this.content = content;
    this.healthData = healthData;
  }

  toString(): string {
    return `MemoryItem{date: ${this.date}, title: ${this.title}, contentLength: ${this.content.length}}`;
  }
}

// æ—¥æœŸåˆ†ç»„çš„å¥åº·æ•°æ®
class DailyHealthData {
  date: string = '';
  steps: string = '0';
  heartRate: string = '0';
  sleepMinutes: number = 0; // å­˜å‚¨åˆ†é’Ÿæ•°
  activeCalories: number = 0; // æ´»åŠ¨çƒ­é‡
  metabolismCalories: number = 0; // ä»£è°¢çƒ­é‡
  oxygenLevel: string = '0';
  mood: string = '5';
  stepGoal: string = '0';
  recordCount: number = 0;

  constructor(date: string) {
    this.date = date;
  }

  toString(): string {
    return `DailyHealthData{date: ${this.date}, recordCount: ${this.recordCount}, steps: ${this.steps}}`;
  }

  getRecordCount(): number {
    return this.recordCount;
  }

  // è·å–æ ¼å¼åŒ–çš„ç¡çœ æ—¶é—´
  getFormattedSleepHours(): string {
    if (this.sleepMinutes <= 0) return '0å°æ—¶';
    let hours: number = Math.floor(this.sleepMinutes / 60);
    let minutes: number = this.sleepMinutes % 60;
    if (minutes > 0) {
      return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
    }
    return `${hours}å°æ—¶`;
  }

  // è·å–æ€»çƒ­é‡
  getTotalCalories(): number {
    return this.activeCalories + this.metabolismCalories;
  }

  // è·å–æ ¼å¼åŒ–çš„æ€»çƒ­é‡
  getFormattedCalories(): string {
    return `${this.getTotalCalories()}åƒå¡`;
  }
}

@Entry
@Component
export struct HealthMemoryPage {
  @State memories: MemoryItem[] = [];
  @State selectedMemory: number = 0;
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State currentHealthData: HealthData = new HealthData('', '', '', '', '');
  @State updateCounter: number = 0;
  @State userId: number = 0;
  @State isViewingOtherUser: boolean = false; // æ˜¯å¦æŸ¥çœ‹å…¶ä»–ç”¨æˆ·

  private dailyDataMap: Map<string, DailyHealthData> = new Map();

  aboutToAppear(): void {
    console.info('[å¥åº·è®°å¿†é¡µé¢] ================ å¥åº·è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ================');
    console.info('[å¥åº·è®°å¿†é¡µé¢] å½“å‰ç”¨æˆ·: gadz2021, ç³»ç»Ÿæ—¶é—´: 2025-06-08 13:43:32 UTC');
    console.info('[å¥åº·è®°å¿†é¡µé¢] ä¿®å¤: ç¡çœ å•ä½(åˆ†é’Ÿè½¬å°æ—¶)ï¼Œçƒ­é‡è®¡ç®—(æ´»åŠ¨+ä»£è°¢)');
    this.initializeHealthMemorySystem();
  }

  private async initializeHealthMemorySystem(): Promise<void> {
    try {
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¥åº·è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ========');
      await this.getUserId();
      await this.loadHealthDataFromDatabase();
      await this.processHealthDataIntoMemories();
      this.isLoading = false;
      this.updateCounter++;
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== å¥åº·è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ ========');
    } catch (error) {
      let errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥ç³»ç»Ÿé”™è¯¯';
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] å¥åº·è®°å¿†ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${errorMessage}`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${errorMessage}`;
      this.isLoading = false;
      this.updateCounter++;
      this.loadDefaultMemories();
    }
  }

  private async getUserId(): Promise<void> {
    try {
      console.info('[ç”¨æˆ·ID] === å¼€å§‹è·å–ç”¨æˆ·ID ===');

      // å…ˆæ£€æŸ¥è·¯ç”±å‚æ•°æ˜¯å¦æœ‰ä¼ å…¥user_id
      const params = router.getParams() as RouterParams;
      if (params && params.user_id) {
        console.info(`[ç”¨æˆ·ID] === ä»è·¯ç”±å‚æ•°è·å–ç”¨æˆ·ID: ${params.user_id} ===`);
        this.userId = params.user_id;
        this.isViewingOtherUser = true;
        return;
      }

      // å¦‚æœæ²¡æœ‰è·¯ç”±å‚æ•°ï¼Œåˆ™ä»AppStorageè·å–å½“å‰ç™»å½•ç”¨æˆ·
      const userInfoStr = AppStorage.get<string>('userInfo');
      const userInfo: UserInfo = userInfoStr ? JSON.parse(userInfoStr) as UserInfo : {};

      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        this.isViewingOtherUser = false;
        console.info(`[ç”¨æˆ·ID] === ä»å­˜å‚¨è·å–å½“å‰ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('[ç”¨æˆ·ID] === æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
        this.isViewingOtherUser = false;
      }
    } catch (error) {
      console.error(`[ç”¨æˆ·ID] === è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
      this.isViewingOtherUser = false;
    }
  }

  private async loadHealthDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('[å¥åº·æ•°æ®] === ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`[å¥åº·æ•°æ®] === å¼€å§‹åŠ è½½å¥åº·æ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      // è·å–7å¤©å®Œæ•´å†å²æ•°æ®ç”¨äºç”Ÿæˆå¥åº·è®°å¿†
      let healthResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 7, false);
      console.info(`[å¥åº·æ•°æ®] === å¥åº·æ•°æ®å“åº”: ${JSON.stringify(healthResponse)} ===`);

      if (healthResponse.success && healthResponse.data && healthResponse.data.length > 0) {
        // å¤„ç†æ‰€æœ‰å†å²æ•°æ®ç”¨äºç”Ÿæˆå¥åº·è®°å¿†
        this.groupHealthDataByDate(healthResponse.data);
        console.info(`[å¥åº·æ•°æ®] === å¥åº·æ•°æ®å¤„ç†å®Œæˆï¼Œå…±${healthResponse.data.length}æ¡è®°å½• ===`);

        // å•ç‹¬å¤„ç†ä»Šæ—¥æ•°æ®ç”¨äºå®æ—¶æ•°æ®æ˜¾ç¤º
        const today: string = new Date().toISOString().split('T')[0];
        const todayData: HealthDataRequest | undefined = healthResponse.data.find((item: HealthDataRequest) => {
          const itemDate: string = (item.record_date || '').replace(/'/g, '');
          return itemDate === today;
        });

        if (todayData) {
          console.info(`[å¥åº·æ•°æ®] === æ‰¾åˆ°ä»Šæ—¥å®æ—¶æ•°æ®ç”¨äºæ¦‚è§ˆæ˜¾ç¤º ===`);
          // æ›´æ–°ä»Šæ—¥æ•°æ®åˆ°æ¦‚è§ˆä¸­
          this.updateTodayOverviewData(todayData);
        } else {
          console.warn('[å¥åº·æ•°æ®] === ä»Šæ—¥æ— å®æ—¶æ•°æ®ï¼Œæ¦‚è§ˆæ˜¾ç¤ºå†å²æ•°æ® ===');
        }
      } else {
        console.warn('[å¥åº·æ•°æ®] === å¥åº·æ•°æ®ä¸ºç©º ===');
      }
    } catch (error) {
      console.error(`[å¥åº·æ•°æ®] === æ•°æ®åŠ è½½å¼‚å¸¸: ${error} ===`);
      throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}`);
    }
  }

  private updateTodayOverviewData(todayData: HealthDataRequest): void {
    console.info('[ä»Šæ—¥æ•°æ®] === æ›´æ–°ä»Šæ—¥æ¦‚è§ˆæ•°æ® ===');
    // è¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦æ›´æ–°å½“å‰å¥åº·æ•°æ®æ¦‚è§ˆ
    // å½“å‰çš„é€»è¾‘æ˜¯åœ¨processHealthDataIntoMemoriesä¸­è®¾ç½®currentHealthData
    // å¦‚æœéœ€è¦å¼ºåˆ¶ä½¿ç”¨ä»Šæ—¥æ•°æ®ï¼Œå¯ä»¥åœ¨è¿™é‡Œè¦†ç›–
  }

  private groupHealthDataByDate(healthRecords: HealthDataRequest[]): void {
    console.info(`[æ•°æ®åˆ†ç»„] === å¼€å§‹æŒ‰æ—¥æœŸåˆ†ç»„å¥åº·æ•°æ®ï¼Œå…±${healthRecords.length}æ¡è®°å½• ===`);

    for (let i: number = 0; i < healthRecords.length; i++) {
      let record: HealthDataRequest = healthRecords[i];
      let dateStr: string = (record.record_date || '').replace(/'/g, ''); // ç§»é™¤å¼•å·

      if (!dateStr) {
        console.warn(`[æ•°æ®åˆ†ç»„] === è·³è¿‡æ— æ—¥æœŸè®°å½•: ${JSON.stringify(record)} ===`);
        continue;
      }

      if (!this.dailyDataMap.has(dateStr)) {
        let newDailyData: DailyHealthData = new DailyHealthData(dateStr);
        this.dailyDataMap.set(dateStr, newDailyData);
      }

      let dailyData: DailyHealthData = this.dailyDataMap.get(dateStr) as DailyHealthData;
      this.updateDailyDataFromRecord(dailyData, record);
      dailyData.recordCount++;

      console.info(`[æ•°æ®åˆ†ç»„] === å¤„ç†æ—¥æœŸ${dateStr}çš„æ•°æ®: ${dailyData.toString()} ===`);
    }

    console.info(`[æ•°æ®åˆ†ç»„] === æ•°æ®åˆ†ç»„å®Œæˆï¼Œå…±${this.dailyDataMap.size}å¤©çš„æ•°æ® ===`);
  }

  private updateDailyDataFromRecord(dailyData: DailyHealthData, record: HealthDataRequest): void {
    console.info(`[æ•°æ®æ›´æ–°] === æ›´æ–°æ—¥æœŸ${dailyData.date}çš„å¥åº·æ•°æ® ===`);

    dailyData.steps = (record.steps || 0).toString();
    dailyData.heartRate = (record.current_heart_rate || 0).toString();

    // ç¡çœ æ—¶é—´ï¼šä»åˆ†é’Ÿè½¬æ¢
    dailyData.sleepMinutes = record.sleep_duration || 0;
    console.info(`[æ•°æ®æ›´æ–°] === ç¡çœ æ—¶é—´: ${dailyData.sleepMinutes}åˆ†é’Ÿ = ${dailyData.getFormattedSleepHours()} ===`);

    // çƒ­é‡ï¼šæ´»åŠ¨çƒ­é‡ + ä»£è°¢çƒ­é‡
    dailyData.activeCalories = record.active_calories || 0;
    dailyData.metabolismCalories = record.basic_metabolism_calories || 0;
    console.info(`[æ•°æ®æ›´æ–°] === çƒ­é‡è®¡ç®—: æ´»åŠ¨${dailyData.activeCalories} + ä»£è°¢${dailyData.metabolismCalories} = æ€»è®¡${dailyData.getTotalCalories()}åƒå¡ ===`);

    dailyData.oxygenLevel = (record.current_blood_oxygen || 0).toString();
    dailyData.mood = (record.current_mood || 5).toString();
    dailyData.stepGoal = (record.steps_goal || 10000).toString();
  }
  ///è¿™ä¸ªæ³¨é‡Šæ‰çš„æ˜¯æ˜¾ç¤ºæœ€æ–°(å¯èƒ½ä¸æ˜¯ä»Šå¤©çš„æ•°æ®)çš„é€»è¾‘å®ç°
  // private async processHealthDataIntoMemories(): Promise<void> {
  //   console.info('[è®°å¿†å¤„ç†] === å¼€å§‹å¤„ç†å¥åº·æ•°æ®ä¸ºè®°å¿† ===');
  //   let memories: MemoryItem[] = [];
  //   let sortedDates: string[] = Array.from(this.dailyDataMap.keys()).sort((a: string, b: string) => b.localeCompare(a));
  //   let recentDates: string[] = sortedDates.slice(0, 7);
  //
  //   for (let i: number = 0; i < recentDates.length; i++) {
  //     let date: string = recentDates[i];
  //     let dailyData: DailyHealthData = this.dailyDataMap.get(date) as DailyHealthData;
  //
  //     if (dailyData) {
  //       let healthData: HealthData = new HealthData(
  //         `${dailyData.steps}æ­¥`,
  //         `${dailyData.heartRate}bpm`,
  //         dailyData.getFormattedSleepHours(),
  //         dailyData.getFormattedCalories(),
  //         `${dailyData.oxygenLevel}%`,
  //         this.getMoodText(parseInt(dailyData.mood)),
  //         `${dailyData.stepGoal}æ­¥`
  //       );
  //
  //       let memory: MemoryItem = this.generateMemoryForDate(date, dailyData, healthData, i);
  //       memories.push(memory);
  //       console.info(`[è®°å¿†å¤„ç†] === ç”Ÿæˆè®°å¿†: ${memory.toString()} ===`);
  //     }
  //   }
  //
  //   this.memories = memories;
  //
  //   if (memories.length > 0) {
  //     this.currentHealthData = memories[0].healthData;
  //   } else {
  //     this.currentHealthData = new HealthData('0æ­¥', '0bpm', '0å°æ—¶', '0åƒå¡', '0%', 'ä¸€èˆ¬', '10000æ­¥');
  //   }
  //
  //   console.info(`[è®°å¿†å¤„ç†] === è®°å¿†å¤„ç†å®Œæˆï¼Œå…±ç”Ÿæˆ${memories.length}æ¡è®°å¿† ===`);
  // }


  private async processHealthDataIntoMemories(): Promise<void> {
    console.info('[è®°å¿†å¤„ç†] === å¼€å§‹å¤„ç†å¥åº·æ•°æ®ä¸ºè®°å¿† ===');
    let memories: MemoryItem[] = [];
    let sortedDates: string[] = Array.from(this.dailyDataMap.keys()).sort((a: string, b: string) => b.localeCompare(a));
    let recentDates: string[] = sortedDates.slice(0, 7);

    for (let i: number = 0; i < recentDates.length; i++) {
      let date: string = recentDates[i];
      let dailyData: DailyHealthData = this.dailyDataMap.get(date) as DailyHealthData;

      if (dailyData) {
        let healthData: HealthData = new HealthData(
          `${dailyData.steps}æ­¥`,
          `${dailyData.heartRate}bpm`,
          dailyData.getFormattedSleepHours(),
          dailyData.getFormattedCalories(),
          `${dailyData.oxygenLevel}%`,
          this.getMoodText(parseInt(dailyData.mood)),
          `${dailyData.stepGoal}æ­¥`
        );

        let memory: MemoryItem = this.generateMemoryForDate(date, dailyData, healthData, i);
        memories.push(memory);
        console.info(`[è®°å¿†å¤„ç†] === ç”Ÿæˆè®°å¿†: ${memory.toString()} ===`);
      }
    }

    this.memories = memories;

    // ä¿®æ”¹è¿™é‡Œï¼šä¼˜å…ˆæŸ¥æ‰¾ä»Šæ—¥æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼
    const today: string = new Date().toISOString().split('T')[0];
    const todayData: DailyHealthData | undefined = this.dailyDataMap.get(today);

    if (todayData) {
      console.info('[è®°å¿†å¤„ç†] === ä½¿ç”¨ä»Šæ—¥æ•°æ®è®¾ç½®æ¦‚è§ˆ ===');
      this.currentHealthData = new HealthData(
        `${todayData.steps}æ­¥`,
        `${todayData.heartRate}bpm`,
        todayData.getFormattedSleepHours(),
        todayData.getFormattedCalories(),
        `${todayData.oxygenLevel}%`,
        this.getMoodText(parseInt(todayData.mood)),
        `${todayData.stepGoal}æ­¥`
      );
    } else {
      console.warn('[è®°å¿†å¤„ç†] === ä»Šæ—¥æ— æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼ ===');
      this.currentHealthData = new HealthData('0æ­¥', '0bpm', '0å°æ—¶', '0åƒå¡', '0%', 'æ— æ•°æ®', '10000æ­¥');
    }

    console.info(`[è®°å¿†å¤„ç†] === è®°å¿†å¤„ç†å®Œæˆï¼Œå…±ç”Ÿæˆ${memories.length}æ¡è®°å¿† ===`);
  }

  private generateMemoryForDate(date: string, dailyData: DailyHealthData, healthData: HealthData, dayIndex: number): MemoryItem {
    let analysisResult: HealthAnalysisResult = this.analyzeHealthData(dailyData);
    return new MemoryItem(date, analysisResult.title, analysisResult.content, healthData);
  }

  private analyzeHealthData(dailyData: DailyHealthData): HealthAnalysisResult {
    let issues: string[] = [];
    let achievements: string[] = [];
    let suggestions: string[] = [];

    let steps: number = parseInt(dailyData.steps) || 0;
    let stepGoal: number = parseInt(dailyData.stepGoal) || 8000;

    if (steps >= stepGoal) {
      achievements.push(`å®Œæˆæ­¥æ•°ç›®æ ‡ï¼Œèµ°äº†${this.formatNumber(steps)}æ­¥`);
    } else if (steps > stepGoal * 0.8) {
      suggestions.push(`æ­¥æ•°å·²è¾¾æˆç›®æ ‡çš„${Math.round((steps / stepGoal) * 100)}%ï¼Œç»§ç»­åŠ æ²¹`);
    } else if (steps > 0) {
      issues.push(`æ­¥æ•°ä¸è¶³ï¼Œä»…å®Œæˆç›®æ ‡çš„${Math.round((steps / stepGoal) * 100)}%`);
    }

    let heartRate: number = parseInt(dailyData.heartRate) || 0;
    if (heartRate > 0) {
      if (heartRate >= 60 && heartRate <= 100) {
        achievements.push('å¿ƒç‡æ­£å¸¸ç¨³å®š');
      } else if (heartRate < 60) {
        issues.push('å¿ƒç‡åä½ï¼Œå»ºè®®å…³æ³¨');
      } else {
        issues.push('å¿ƒç‡åé«˜ï¼Œå»ºè®®ä¼‘æ¯');
      }
    }

    // ç¡çœ åˆ†æï¼šä½¿ç”¨åˆ†é’Ÿæ•°è¿›è¡Œåˆ¤æ–­
    let sleepHours: number = dailyData.sleepMinutes / 60;
    console.info(`[ç¡çœ åˆ†æ] === ç¡çœ æ—¶é—´: ${dailyData.sleepMinutes}åˆ†é’Ÿ = ${sleepHours.toFixed(1)}å°æ—¶ ===`);

    if (sleepHours >= 7) {
      achievements.push('ç¡çœ æ—¶é—´å……è¶³');
    } else if (sleepHours >= 6) {
      suggestions.push('ç¡çœ æ—¶é—´ç•¥æ˜¾ä¸è¶³ï¼Œå»ºè®®æ—©ç‚¹ä¼‘æ¯');
    } else if (sleepHours > 0) {
      issues.push('ç¡çœ ä¸¥é‡ä¸è¶³ï¼Œå½±å“å¥åº·');
    }

    // çƒ­é‡åˆ†æï¼šä½¿ç”¨æ€»çƒ­é‡ï¼ˆæ´»åŠ¨+ä»£è°¢ï¼‰
    let totalCalories: number = dailyData.getTotalCalories();
    console.info(`[çƒ­é‡åˆ†æ] === æ€»çƒ­é‡: ${totalCalories}åƒå¡ (æ´»åŠ¨${dailyData.activeCalories} + ä»£è°¢${dailyData.metabolismCalories}) ===`);

    if (totalCalories >= 2000) {
      achievements.push('çƒ­é‡æ¶ˆè€—è‰¯å¥½');
    } else if (totalCalories >= 1500) {
      suggestions.push('çƒ­é‡æ¶ˆè€—é€‚ä¸­ï¼Œå¯ç»§ç»­ä¿æŒ');
    }

    let mood: number = parseInt(dailyData.mood) || 5;
    if (mood >= 8) {
      achievements.push('å¿ƒæƒ…çŠ¶æ€ä¼˜ç§€');
    } else if (mood <= 3) {
      issues.push('å¿ƒæƒ…çŠ¶æ€è¾ƒå·®ï¼Œéœ€è¦è°ƒèŠ‚');
      suggestions.push('å»ºè®®è¿›è¡Œæ”¾æ¾ç»ƒä¹ ï¼Œå¦‚æ·±å‘¼å¸æˆ–å†¥æƒ³');
    }

    let title: string;
    let content: string;

    if (issues.length > 0) {
      title = 'å¥åº·æé†’';
      content = `ä»Šæ—¥å¥åº·æ•°æ®æ˜¾ç¤ºéœ€è¦æ³¨æ„ä»¥ä¸‹æ–¹é¢ï¼š\n\n`;
      content += issues.map((issue: string, index: number) => `${index + 1}. ${issue}`).join('\n');

      if (suggestions.length > 0) {
        content += `\n\nå»ºè®®ï¼š\n`;
        content += suggestions.map((suggestion: string, index: number) => `â€¢ ${suggestion}`).join('\n');
      }
    } else if (achievements.length > 0) {
      title = 'å¥åº·çŠ¶å†µè‰¯å¥½';
      content = `æ­å–œæ‚¨ï¼Œä»Šæ—¥å¥åº·è¡¨ç°ä¼˜ç§€ï¼š\n\n`;
      content += achievements.map((achievement: string, index: number) => `âœ… ${achievement}`).join('\n');
      content += `\n\nç»§ç»­ä¿æŒè‰¯å¥½çš„ç”Ÿæ´»ä¹ æƒ¯ï¼`;
    } else {
      title = 'å¥åº·æ•°æ®è®°å½•';
      content = `ä»Šæ—¥å¥åº·æ•°æ®å·²è®°å½•ï¼Œè¯·ç»§ç»­å…³æ³¨æ‚¨çš„å¥åº·çŠ¶å†µã€‚`;
    }

    return new HealthAnalysisResult(title, content);
  }

  private getMoodText(mood: number): string {
    if (mood >= 9) return 'éå¸¸æ„‰å¿«';
    if (mood >= 8) return 'æ„‰å¿«';
    if (mood >= 7) return 'è¾ƒå¥½';
    if (mood >= 6) return 'ä¸€èˆ¬åå¥½';
    if (mood >= 5) return 'ä¸€èˆ¬';
    if (mood >= 4) return 'ä¸€èˆ¬åå·®';
    if (mood >= 3) return 'è¾ƒå·®';
    if (mood >= 2) return 'å¾ˆå·®';
    return 'æå·®';
  }

  private formatNumber(num: number): string {
    return num.toLocaleString();
  }

  private loadDefaultMemories(): void {
    console.info('[é»˜è®¤æ•°æ®] === åŠ è½½é»˜è®¤å¥åº·è®°å¿† ===');
    let defaultHealthData: HealthData = new HealthData('0æ­¥', '0bpm', '0å°æ—¶', '0åƒå¡', '0%', 'æ— æ•°æ®', '10000æ­¥');
    let defaultMemory: MemoryItem = new MemoryItem('2025-06-08', 'æš‚æ— æ•°æ®', 'æš‚æ— å¥åº·è®°å¿†æ•°æ®ï¼Œè¯·ç¨åé‡è¯•', defaultHealthData);
    this.memories = [defaultMemory];
    this.currentHealthData = defaultHealthData;
    this.selectedMemory = 0;
  }

  build() {
    Column() {
      // ä¼˜åŒ–çš„å¯¼èˆªæ 
      this.buildNavigationBar()

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        this.buildLoadingView()
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        this.buildErrorView()
      } else {
        // æ­£å¸¸å†…å®¹
        Scroll() {
          Column({ space: 20 }) {
            // å¥åº·æ•°æ®æ¦‚è§ˆå¡ç‰‡
            this.buildHealthDataOverview()

            // å¥åº·è®°å¿†å¡ç‰‡
            this.buildHealthMemoryCard()

            // å¥åº·å»ºè®®å¡ç‰‡
            this.buildHealthAdviceCard()
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F9FA')
  }

  @Builder
  buildLoadingView() {
    Column({ space: 20 }) {
      LoadingProgress()
        .width(50)
        .height(50)
        .color('#4285F4')

      Text('æ­£åœ¨åŠ è½½å¥åº·æ•°æ®...')
        .fontSize(16)
        .fontColor('#666666')
        .fontWeight(FontWeight.Medium)

      Text('å½“å‰ç”¨æˆ·: gadz2021, åŠ è½½ä¸­è¯·ç¨å€™')
        .fontSize(14)
        .fontColor('#999999')
        .textAlign(TextAlign.Center)
        .maxLines(2)
        .lineHeight(20)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding(40)
  }

  @Builder
  buildErrorView() {
    Column({ space: 20 }) {
      Text('âš ï¸')
        .fontSize(48)

      Text('æ•°æ®åŠ è½½å¤±è´¥')
        .fontSize(18)
        .fontColor('#EA4335')
        .fontWeight(FontWeight.Bold)

      Text(this.errorMessage)
        .fontSize(14)
        .fontColor('#666666')
        .textAlign(TextAlign.Center)
        .maxLines(3)
        .lineHeight(20)

      Button('é‡æ–°åŠ è½½')
        .onClick(() => {
          this.isLoading = true;
          this.errorMessage = '';
          this.updateCounter++;
          this.initializeHealthMemorySystem();
        })
        .backgroundColor('#4285F4')
        .fontColor(Color.White)
        .borderRadius(8)
        .height(40)
        .width(120)
    }
    .width('100%')
    .layoutWeight(1)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .padding(40)
  }

  @Builder
  buildNavigationBar() {
    Row() {
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_back'))
          .width(20)
          .height(20)
      }
      .onClick(() => {
        try {
          // å¦‚æœæ˜¯æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ï¼Œè¿”å›æ—¶éœ€è¦ä¼ é€’user_idå‚æ•°ç»™ä¸»é¡µ
          if (this.isViewingOtherUser) {
            router.back({
              url: 'pages/one/pages/WxHomePage',
              params: { user_id: this.userId }
            });
          } else {
            router.back();
          }
        } catch (err) {
          router.pushUrl({ url: 'pages/one/OnePage' });
        }
      })
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .margin({ left: 10 })

      Text('ä¸ªæ€§åŒ–å¥åº·è®°å¿†')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor(Color.Black)
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å³ä¾§å ä½å…ƒç´ ï¼Œä¿æŒå¸ƒå±€å¹³è¡¡
      Row()
        .width(40)
        .height(40)
        .margin({ right: 10 })
    }
    .width('100%')
    .height(60)
    .justifyContent(FlexAlign.SpaceBetween)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  buildHealthDataOverview() {
    Column({ space: 16 }) {
      Row() {
        Text('å¥åº·æ•°æ®æ¦‚è§ˆ')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        Text('å®æ—¶æ•°æ®')
          .fontSize(12)
          .fontColor('#4285F4')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('rgba(66, 133, 244, 0.1)')
          .borderRadius(10)
      }
      .width('100%')

      // ç¬¬ä¸€è¡Œæ•°æ®å¡ç‰‡
      Row({ space: 10 }) {
        this.buildDataCard('æ­¥æ•°', this.currentHealthData.steps || '0æ­¥', '#4285F4', 'ğŸ‘Ÿ')
        this.buildDataCard('å¿ƒç‡', this.currentHealthData.heartRate || '0bpm', '#EA4335', 'â¤ï¸')
        this.buildDataCard('ç¡çœ ', this.currentHealthData.sleepHours || '0å°æ—¶', '#34A853', 'ğŸ˜´')
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)

      // ç¬¬äºŒè¡Œæ•°æ®å¡ç‰‡
      Row({ space: 10 }) {
        this.buildDataCard('çƒ­é‡', this.currentHealthData.calories || '0åƒå¡', '#FBBC05', 'ğŸ”¥')
        this.buildDataCard('è¡€æ°§', this.currentHealthData.oxygenLevel || '0%', '#9C27B0', 'ğŸ«')
        // æƒ…ç»ªæˆ–ç›®æ ‡å¡ç‰‡
        if (this.currentHealthData.mood) {
          this.buildDataCard('å¿ƒæƒ…', this.currentHealthData.mood, '#FF9800', 'ğŸ˜Š')
        } else {
          // ç©ºç™½å ä½ï¼Œä¿æŒå¯¹é½
          Column()
            .width('30%')
            .height(90)
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 8,
      color: 'rgba(0,0,0,0.06)',
      offsetX: 0,
      offsetY: 3
    })
  }

  @Builder
  buildDataCard(title: string, value: string, color: string, emoji: string) {
    Column() {
      // å›¾æ ‡åŒºåŸŸ
      Text(emoji)
        .fontSize(20)
        .margin({ bottom: 6 })

      // æ ‡é¢˜
      Text(title)
        .fontSize(12)
        .fontColor('#999999')
        .fontWeight(FontWeight.Medium)
        .margin({ bottom: 4 })
        .textAlign(TextAlign.Center)

      // æ•°å€¼
      Text(value)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
        .textAlign(TextAlign.Center)
        .maxLines(1)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('30%')
    .height(90)
    .padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .border({
      width: 1,
      color: color,
      style: BorderStyle.Solid
    })
    .shadow({
      radius: 4,
      color: 'rgba(0,0,0,0.05)',
      offsetX: 0,
      offsetY: 2
    })
  }

  @Builder
  buildHealthMemoryCard() {
    Column({ space: 16 }) {
      Row() {
        Text('å¥åº·è®°å¿†')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        Text(`å…±${this.memories.length}æ¡è®°å½•`)
          .fontSize(12)
          .fontColor('#999999')
          .padding({ left: 8, right: 8, top: 4, bottom: 4 })
          .backgroundColor('#F0F0F0')
          .borderRadius(10)
      }
      .width('100%')

      if (this.memories.length === 0) {
        Column({ space: 12 }) {
          Text('ğŸ“')
            .fontSize(32)

          Text('æš‚æ— å¥åº·è®°å¿†')
            .fontSize(16)
            .fontColor('#666666')
            .fontWeight(FontWeight.Medium)

          Text('å¥åº·æ•°æ®è®°å½•åå°†è‡ªåŠ¨ç”Ÿæˆä¸ªæ€§åŒ–è®°å¿†')
            .fontSize(14)
            .fontColor('#999999')
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(120)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        ForEach(this.memories, (item: MemoryItem, index: number) => {
          Column({ space: 12 }) {
            Row() {
              Column({ space: 4 }) {
                Text(item.date)
                  .fontSize(12)
                  .fontColor('#999999')

                Text(this.getDateLabel(index))
                  .fontSize(14)
                  .fontColor('#666666')
                  .fontWeight(FontWeight.Medium)
              }
              .alignItems(HorizontalAlign.Start)

              Blank()

              // çŠ¶æ€æŒ‡ç¤ºå™¨
              Row() {
                Text('â—')
                  .fontSize(12)
                  .fontColor(this.getStatusColor(item.title))

                Text(this.getStatusText(item.title))
                  .fontSize(12)
                  .fontColor(this.getStatusColor(item.title))
                  .margin({ left: 6 })
              }
            }
            .width('100%')

            Text(item.title)
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .width('100%')
              .textAlign(TextAlign.Start)

            Text(item.content)
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(20)
              .width('100%')
              .textAlign(TextAlign.Start)
              .maxLines(3)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            Button() {
              Text('æŸ¥çœ‹è¯¦æƒ…')
                .fontSize(14)
                .fontColor(index === this.selectedMemory ? '#FFFFFF' : '#4285F4')
                .fontWeight(FontWeight.Medium)
            }
            .height(36)
            .width(100)
            .backgroundColor(index === this.selectedMemory ? '#4285F4' : 'rgba(66, 133, 244, 0.1)')
            .borderRadius(18)
            .border({
              width: index === this.selectedMemory ? 0 : 1,
              color: '#4285F4',
              style: BorderStyle.Solid
            })
            .onClick(() => {
              this.selectedMemory = index;
              this.currentHealthData = item.healthData;
              this.updateCounter++;
              this.showHealthMemoryDetail(item, index);
            })
          }
          .width('100%')
          .padding(16)
          .backgroundColor(index === this.selectedMemory ? 'rgba(66, 133, 244, 0.05)' : '#FFFFFF')
          .borderRadius(12)
          .border({
            width: index === this.selectedMemory ? 2 : 1,
            color: index === this.selectedMemory ? '#4285F4' : '#E8E8E8',
            style: BorderStyle.Solid
          })
        })
      }
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildHealthAdviceCard() {
    Column({ space: 16 }) {
      Row() {
        Text('ä»Šæ—¥å¥åº·å»ºè®®')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')

        Blank()

        Text('ğŸ’¡')
          .fontSize(20)
      }
      .width('100%')

      Text('åŸºäºæ‚¨çš„å¥åº·æ•°æ®ï¼Œä¸ºæ‚¨æä¾›ä¸ªæ€§åŒ–å»ºè®®ï¼š')
        .fontSize(14)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Start)

      Column({ space: 12 }) {
        this.buildAdviceItem('æ¯æ—¥ä¿æŒ8000æ­¥ä»¥ä¸Šçš„æ´»åŠ¨é‡', 'ğŸš¶â€â™‚ï¸')
        this.buildAdviceItem('ç¡®ä¿æ¯æ™š7-8å°æ—¶ä¼˜è´¨ç¡çœ ', 'ğŸ›Œ')
        this.buildAdviceItem('å¤šå–æ°´ï¼Œä¿æŒèº«ä½“æ°´åˆ†å¹³è¡¡', 'ğŸ’§')
        this.buildAdviceItem('é€‚é‡è¿åŠ¨ï¼Œå¢å¼ºå¿ƒè‚ºåŠŸèƒ½', 'ğŸƒâ€â™‚ï¸')
      }
      .width('100%')
    }
    .width('100%')
    .padding(20)
    .backgroundColor('#FFFFFF')
    .borderRadius(16)
    .shadow({
      radius: 12,
      color: 'rgba(0,0,0,0.08)',
      offsetX: 0,
      offsetY: 4
    })
  }

  @Builder
  buildAdviceItem(text: string, emoji: string) {
    Row({ space: 12 }) {
      Text(emoji)
        .fontSize(16)

      Text(text)
        .fontSize(14)
        .fontColor('#333333')
        .layoutWeight(1)
        .textAlign(TextAlign.Start)
    }
    .width('100%')
    .padding(12)
    .backgroundColor('#F8F9FA')
    .borderRadius(8)
  }

  private getDateLabel(index: number): string {
    if (this.memories.length === 0) return '';

    const memoryDate = this.memories[index].date.replace(/'/g, '');
    const today = new Date().toISOString().split('T')[0];
    const targetDate = new Date(memoryDate);
    const currentDate = new Date(today);

    const diffTime = currentDate.getTime() - targetDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    console.info(`[æ—¥æœŸæ ‡ç­¾] === è®¡ç®—æ—¥æœŸå·®å€¼: ${memoryDate} vs ${today}, ç›¸å·®${diffDays}å¤© ===`);

    if (diffDays === 0) return 'ä»Šå¤©';
    if (diffDays === 1) return 'æ˜¨å¤©';
    if (diffDays === 2) return 'å‰å¤©';
    if (diffDays >= 3 && diffDays <= 7) return `${diffDays}å¤©å‰`;

    return `${diffDays}å¤©å‰`;
  }

  private getStatusColor(title: string): string {
    if (title.includes('è‰¯å¥½') || title.includes('ä¼˜ç§€') || title.includes('æˆå°±')) {
      return '#34A853';
    } else if (title.includes('æé†’') || title.includes('æ³¨æ„') || title.includes('å¼‚å¸¸')) {
      return '#EA4335';
    } else if (title.includes('æˆå°±') || title.includes('è¾¾æˆ')) {
      return '#FBBC05';
    } else {
      return '#4285F4';
    }
  }

  private getStatusText(title: string): string {
    if (title.includes('è‰¯å¥½') || title.includes('ä¼˜ç§€')) {
      return 'ä¼˜ç§€';
    } else if (title.includes('æé†’') || title.includes('æ³¨æ„') || title.includes('å¼‚å¸¸')) {
      return 'éœ€å…³æ³¨';
    } else if (title.includes('æˆå°±') || title.includes('è¾¾æˆ')) {
      return 'è¾¾æˆ';
    } else {
      return 'è®°å½•';
    }
  }

  // æ˜¾ç¤ºå¥åº·è®°å¿†è¯¦æƒ…
  private showHealthMemoryDetail(item: MemoryItem, index: number): void {
    let detailMessage: string = `æ—¥æœŸ: ${item.date}\n\nè¯¦æƒ…:${item.content}\n\nå¥åº·æ•°æ®:`;
    detailMessage += `\nâ€¢ æ­¥æ•°: ${item.healthData.steps}`;
    detailMessage += `\nâ€¢ å¿ƒç‡: ${item.healthData.heartRate}`;
    detailMessage += `\nâ€¢ ç¡çœ : ${item.healthData.sleepHours}`;
    detailMessage += `\nâ€¢ çƒ­é‡: ${item.healthData.calories}`;
    detailMessage += `\nâ€¢ è¡€æ°§: ${item.healthData.oxygenLevel}`;

    if (item.healthData.mood) {
      detailMessage += `\nâ€¢ å¿ƒæƒ…: ${item.healthData.mood}`;
    }

    AlertDialog.show({
      title: item.title,
      message: detailMessage,
      primaryButton: {
        value: 'å…³é—­',
        action: () => {
          // å…³é—­å¼¹çª—
        }
      },
      secondaryButton: {
        value: 'åˆ†äº«',
        action: () => {
          // TODO: è¿™é‡Œå¯ä»¥æ·»åŠ åˆ†äº«åŠŸèƒ½çš„å…·ä½“å®ç°
        }
      }
    });
  }
}