import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

///è¿™æ˜¯æ­¥æ•°åˆ†æé¡µé¢

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

interface RouterParams {
  user_id?: number;
}

class WeeklyStepData {
  date: string = '';
  steps: number = 0;
  distance: number = 0;
}

class StepRecord {
  time: string = '';
  value: number = 0;
  distance: string = '';
  dayOfWeek: string = '';
  timestamp: string = '';

  constructor(time: string, value: number, distance: string, dayOfWeek?: string, timestamp?: string) {
    this.time = time;
    this.value = value;
    this.distance = distance;
    this.dayOfWeek = dayOfWeek || '';
    this.timestamp = timestamp || '';
  }

  toString(): string {
    return `StepRecord{time: ${this.time}, value: ${this.value}æ­¥, distance: ${this.distance}}`;
  }
}

@Entry
@Component
export struct StepCountPage {
  @State currentSteps: number = 0;
  @State dailyGoal: number = 0;
  @State weeklyAvg: number = 0;
  @State distance: string = '';
  @State calories: string = '';
  @State stepRecords: StepRecord[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State hasDataLoaded: boolean = false;
  @State userId: number = 0;
  @State isViewingOtherUser: boolean = false; // æ·»åŠ åˆ°ç»„ä»¶çŠ¶æ€å˜é‡ä¸­


  private weekDays: string[] = [];

  aboutToAppear(): void {
    console.info('=== æ­¥æ•°åˆ†æé¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
    this.distance = '0å…¬é‡Œ';
    this.calories = '0åƒå¡';

    this.weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

    console.info('=== åˆå§‹åŒ–è®¾ç½®å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ® ===');
    this.initializeStepSystem();
  }

  private async initializeStepSystem(): Promise<void> {
    try {
      console.info('=== å¼€å§‹åˆå§‹åŒ–æ­¥æ•°ç³»ç»Ÿ ===');
      this.resetStepData();
      await this.getUserId();
      await this.loadHealthDataFromDatabase();
      this.isLoading = false;
      console.info('=== æ­¥æ•°ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      let errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error(`=== åˆå§‹åŒ–å¼‚å¸¸: ${errorMessage} ===`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${errorMessage}`;
      this.isLoading = false;
      this.resetStepData();
    }
  }

  private resetStepData(): void {
    console.info('=== é‡ç½®æ­¥æ•°æ•°æ® ===');
    this.currentSteps = 0;
    this.dailyGoal = 0;
    this.weeklyAvg = 0;
    this.distance = '0å…¬é‡Œ';
    this.calories = '0åƒå¡';
    this.stepRecords = [];
    this.hasDataLoaded = false;
  }


  private async getUserId(): Promise<void> {
    try {
      console.info('=== å¼€å§‹è·å–ç”¨æˆ·ID ===');

      // å…ˆæ£€æŸ¥è·¯ç”±å‚æ•°æ˜¯å¦æœ‰ä¼ å…¥user_id
      const params = router.getParams() as RouterParams;
      if (params && params.user_id) {
        console.info(`=== ä»è·¯ç”±å‚æ•°è·å–ç”¨æˆ·ID: ${params.user_id} ===`);
        this.userId = params.user_id;
        this.isViewingOtherUser = true;
        return;
      }

      // å¦‚æœæ²¡æœ‰è·¯ç”±å‚æ•°ï¼Œåˆ™ä»AppStorageè·å–å½“å‰ç™»å½•ç”¨æˆ·
      const userInfoStr = AppStorage.get<string>('userInfo');
      const userInfo: UserInfo = userInfoStr ? JSON.parse(userInfoStr) as UserInfo : {};

      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        this.isViewingOtherUser = false;
        console.info(`=== ä»å­˜å‚¨è·å–å½“å‰ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('=== æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
        this.isViewingOtherUser = false;
      }
    } catch (error) {
      console.error(`=== è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
      this.isViewingOtherUser = false;
    }
  }

  private async loadHealthDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('=== ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`=== å¼€å§‹åŠ è½½å¥åº·æ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      // è·å–7å¤©å†å²æ•°æ®ç”¨äºå‘¨æ­¥æ•°è®°å½•
      let healthResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 7, false);
      console.info(`=== å¥åº·æ•°æ®å“åº”: ${JSON.stringify(healthResponse)} ===`);

      if (healthResponse.success && healthResponse.data && healthResponse.data.length > 0) {
        // è¿‡æ»¤ä»Šæ—¥æ•°æ®ç”¨äºå½“å‰æ­¥æ•°æ˜¾ç¤º
        const todayDate = new Date();
        const today: string = `${todayDate.getFullYear()}-${String(todayDate.getMonth() + 1).padStart(2, '0')}-${String(todayDate.getDate()).padStart(2, '0')}`;
        const todayData: HealthDataRequest | undefined = healthResponse.data.find((item: HealthDataRequest) => {
          const itemDate: string = (item.record_date || '').replace(/'/g, '');
          return itemDate === today;
        });

        if (todayData) {
          console.info(`=== æ‰¾åˆ°ä»Šæ—¥æ•°æ®: ${JSON.stringify(todayData)} ===`);
          this.currentSteps = todayData.steps || 0;
          this.dailyGoal = todayData.steps_goal || 0;
          this.distance = `${todayData.distance || 0}å…¬é‡Œ`;
          this.calories = `${todayData.active_calories || 0}åƒå¡`;
          console.info(`=== ä»Šæ—¥æ­¥æ•°: ${this.currentSteps}, ç›®æ ‡: ${this.dailyGoal} ===`);
        } else {
          console.warn('=== ä»Šæ—¥æ­¥æ•°æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ ===');
          this.currentSteps = 0;
          this.dailyGoal = 0;
          this.distance = '0å…¬é‡Œ';
          this.calories = '0åƒå¡';
        }

        // ç”Ÿæˆå‘¨æ­¥æ•°è®°å½•ï¼ˆä½¿ç”¨æ‰€æœ‰7å¤©æ•°æ®ï¼‰
        console.info(`=== å¼€å§‹å¤„ç†å‘¨æ•°æ®ï¼Œæ•°æ®é•¿åº¦: ${healthResponse.data.length} ===`);
        let weeklyStepData: WeeklyStepData[] = [];

        for (let i = 0; i < healthResponse.data.length; i++) {
          let item = healthResponse.data[i];
          let stepData = new WeeklyStepData();
          let rawDate = item.record_date || '';
          if (rawDate.startsWith("'") && rawDate.endsWith("'")) {
            stepData.date = rawDate.slice(1, -1);
          } else {
            stepData.date = rawDate;
          }
          console.info(`=== æ—¥æœŸå¤„ç†: ${rawDate} -> ${stepData.date} ===`);
          stepData.steps = item.steps || 0;
          stepData.distance = item.distance || 0;
          weeklyStepData.push(stepData);

          console.info(`=== å¤„ç†æ•°æ®[${i}]: æ—¥æœŸ=${stepData.date}, æ­¥æ•°=${stepData.steps} ===`);
        }

        console.info(`=== å‘¨æ•°æ®å¤„ç†å®Œæˆï¼Œæ€»è®¡${weeklyStepData.length}æ¡ ===`);
        this.generateWeeklyDisplayDataFromDatabase(weeklyStepData);
      } else {
        console.warn('=== æ­¥æ•°æ•°æ®ä¸ºç©º ===');
      }

      this.hasDataLoaded = true;
    } catch (error) {
      let errorMessage = error instanceof Error ? error.message : 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error(`=== æ•°æ®åŠ è½½å¼‚å¸¸: ${errorMessage} ===`);
      throw new Error(errorMessage);
    }
  }

  private generateWeeklyDisplayDataFromDatabase(weeklyData: WeeklyStepData[]): void {
    console.info(`=== å¼€å§‹ç”Ÿæˆå‘¨æ˜¾ç¤ºæ•°æ®ï¼Œè¾“å…¥æ•°æ®: ${weeklyData.length}æ¡ ===`);

    let displayRecords: StepRecord[] = [];
    let today = new Date();
    let todayString = today.toISOString().split('T')[0];
    let totalSteps = 0;
    let validDays = 0;

    console.info(`=== ä»Šå¤©æ—¥æœŸ: ${todayString} ===`);
    console.info(`=== å¯ç”¨æ•°æ®åˆ—è¡¨: ===`);
    weeklyData.forEach((data: WeeklyStepData, index: number) => {
      console.info(`=== æ•°æ®[${index}]: ${data.date} -> ${data.steps}æ­¥ ===`);
    });

    for (let i = 1; i <= 6; i++) {
      let targetDate = new Date();
      targetDate.setDate(today.getDate() - i);
      let targetDateString = targetDate.toISOString().split('T')[0];
      let dayName = this.weekDays[targetDate.getDay()];

      console.info(`=== æŸ¥æ‰¾ç¬¬${i}å¤©æ•°æ®ï¼Œç›®æ ‡æ—¥æœŸ: ${targetDateString} (${dayName}) ===`);

      let stepData = weeklyData.find((data: WeeklyStepData) => {
        let match = data.date === targetDateString;
        console.info(`=== æ¯”è¾ƒ: ${data.date} === ${targetDateString} -> ${match} ===`);
        return match;
      });

      let steps = stepData ? stepData.steps : 0;
      let distance = stepData ? `${stepData.distance}å…¬é‡Œ` : '0å…¬é‡Œ';
      console.info(`=== ${targetDateString}(${dayName}): æ‰¾åˆ°=${stepData ? 'æ˜¯' : 'å¦'}, æ­¥æ•°=${steps} ===`);
      let stepRecord = new StepRecord(dayName, steps, distance, dayName);
      displayRecords.push(stepRecord);

      if (steps > 0) {
        totalSteps += steps;
        validDays++;
      }
    }

    // ä¸éœ€è¦reverseï¼Œä¿æŒåŸæ¥çš„é¡ºåºå°±æ˜¯å‘¨å…­åˆ°å‘¨ä¸€
    this.stepRecords = displayRecords;

    console.info(`=== æœ€ç»ˆè®°å½•æ•°é‡: ${this.stepRecords.length} ===`);
    this.stepRecords.forEach((record: StepRecord, index: number) => {
      console.info(`=== æœ€ç»ˆè®°å½•[${index}]: ${record.toString()} ===`);
    });

    this.weeklyAvg = validDays > 0 ? Math.round(totalSteps / validDays) : 0;
    console.info(`=== å‘¨å¹³å‡æ­¥æ•°: ${this.weeklyAvg} (æ€»æ­¥æ•°: ${totalSteps}, æœ‰æ•ˆå¤©æ•°: ${validDays}) ===`);

    let nonZeroSteps = this.stepRecords.filter((record: StepRecord) => record.value > 0);
    if (nonZeroSteps.length > 0) {
      let sum = nonZeroSteps.reduce((total: number, record: StepRecord) => total + record.value, 0);
      this.weeklyAvg = Math.round(sum / nonZeroSteps.length);
      console.info(`=== é‡æ–°è®¡ç®—å‘¨å¹³å‡: ${this.weeklyAvg} ===`);
    } else {
      this.weeklyAvg = 0;
      console.warn('=== æ— æœ‰æ•ˆæ­¥æ•°æ•°æ®ï¼Œå‘¨å¹³å‡ä¸º0 ===');
    }
  }

  private refreshStepData(): void {
    console.info('=== ç”¨æˆ·è§¦å‘æ•°æ®åˆ·æ–° ===');
    this.isLoading = true;
    this.errorMessage = '';
    this.initializeStepSystem();
  }

  build() {
    Column() {
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          try {
            // å¦‚æœæ˜¯æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ï¼Œè¿”å›æ—¶éœ€è¦ä¼ é€’user_idå‚æ•°ç»™ä¸»é¡µ
            if (this.isViewingOtherUser) {
              router.back({
                url: 'pages/one/pages/WxHomePage',
                params: { user_id: this.userId }
              });
            } else {
              router.back();
            }
          } catch (err) {
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text('æ­¥æ•°åˆ†æ')
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          this.refreshStepData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#4285F4')
          Text('æ­£åœ¨åŠ è½½æ­¥æ•°æ•°æ®...')
            .fontSize(18).fontColor('#333333')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ‘Ÿ').fontSize(64)
          Text('åŠ è½½å¤±è´¥')
            .fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshStepData())
            .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            Column() {
              Text(`ä»Šæ—¥æ­¥æ•° (${this.weekDays[new Date().getDay()]})`)
                .fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 20 }).fontColor('#333333')

              Stack() {
                Progress({ value: 100, total: 100, type: ProgressType.Ring })
                  .width(160).height(160).color('#F0F0F0').style({ strokeWidth: 12 })

                Progress({
                  value: this.dailyGoal > 0 ? this.currentSteps : 0,
                  total: this.dailyGoal > 0 ? this.dailyGoal : 1,
                  type: ProgressType.Ring
                })
                  .width(160).height(160).color('#4285F4').style({ strokeWidth: 12 })

                Column() {
                  Text(this.currentSteps.toString()).fontSize(36).fontWeight(FontWeight.Bold).fontColor('#4285F4')
                  Text('æ­¥')
                    .fontSize(16).fontColor('#666666').margin({ top: 4 })
                  Text(`${this.dailyGoal > 0 ? Math.round((this.currentSteps / this.dailyGoal) * 100) : 0}%`)
                    .fontSize(14).fontColor('#999999').margin({ top: 8 })
                }
              }
              .margin({ bottom: 30 })

              Row({ space: 20 }) {
                this.buildStatCard('ç›®æ ‡', `${this.dailyGoal} æ­¥`, '#4285F4', 'ğŸ¯')
                this.buildStatCard('è·ç¦»', this.distance, '#34A853', 'ğŸ“')
                this.buildStatCard('çƒ­é‡', this.calories, '#EA4335', 'ğŸ”¥')
              }
              .width('100%').justifyContent(FlexAlign.SpaceAround)
            }
            .width('90%').padding(30).backgroundColor('#FFFFFF').borderRadius(20)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 4 })

            Column() {
              Text('æ­¥æ•°è®°å½•')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              if (this.stepRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ‘Ÿ').fontSize(48)
                  Text('æš‚æ— æ­¥æ•°æ•°æ®')
                    .fontSize(18).fontColor('#666666')
                  Button('åˆ·æ–°æ•°æ®')
                    .onClick(() => this.refreshStepData())
                    .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                Column({ space: 8 }) {
                  ForEach(this.stepRecords, (record: StepRecord, index: number) => {
                    Row() {
                      Text(record.time).fontSize(16).fontColor('#333333').width('30%')
                      Text(`${record.value} æ­¥`).fontSize(16).fontColor('#4285F4')
                        .fontWeight(FontWeight.Medium).width('40%').textAlign(TextAlign.Center)
                      Text(record.distance).fontSize(16).fontColor('#666666').width('30%').textAlign(TextAlign.End)
                    }
                    .width('100%').padding({ top: 12, bottom: 12, left: 16, right: 16 })
                    .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(8)
                  })
                }
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  @Builder
  buildStatCard(label: string, value: string, color: string, icon: string) {
    Column() {
      Text(icon).fontSize(20).margin({ bottom: 6 })
      Text(label).fontSize(12).fontColor('#999999').margin({ bottom: 4 })
      Text(value).fontSize(14).fontWeight(FontWeight.Bold).fontColor(color).textAlign(TextAlign.Center)
    }
    .width(80).height(80).padding(8).backgroundColor('#F8F9FA').borderRadius(12)
    .justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
    .border({ width: 1, color: color })
  }
}