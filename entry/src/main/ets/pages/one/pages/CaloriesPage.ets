import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

//æ´»åŠ¨çƒ­é‡

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

class CalorieRecord {
  time: string;
  value: number;
  dayOfWeek: string;

  constructor(time: string, value: number, dayOfWeek: string) {
    this.time = time;
    this.value = value;
    this.dayOfWeek = dayOfWeek;
  }
}

@Entry
@Component
export struct CaloriesPage {
  @State totalCalories: number = 0;
  @State caloriesGoal: number = 0;
  @State activeCalories: number = 0;
  @State restingCalories: number = 0;
  @State calorieRecords: CalorieRecord[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State userId: number = 0;

  private weekDays: string[] = [];

  aboutToAppear(): void {
    console.info('=== çƒ­é‡åˆ†æé¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
    this.weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
    console.info('=== åˆå§‹åŒ–è®¾ç½®å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ® ===');
    this.initializeCalorieSystem();
  }

  private async initializeCalorieSystem(): Promise<void> {
    try {
      console.info('=== å¼€å§‹åˆå§‹åŒ–çƒ­é‡ç³»ç»Ÿ ===');
      this.resetCalorieData();
      await this.getUserId();
      await this.loadCalorieDataFromDatabase();
      this.isLoading = false;
      console.info('=== çƒ­é‡ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error(`=== åˆå§‹åŒ–å¼‚å¸¸: ${error} ===`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${error}`;
      this.isLoading = false;
      this.resetCalorieData();
    }
  }

  private resetCalorieData(): void {
    console.info('=== é‡ç½®çƒ­é‡æ•°æ® ===');
    this.totalCalories = 0;
    this.caloriesGoal = 0;
    this.activeCalories = 0;
    this.restingCalories = 0;
    this.calorieRecords = [];
  }

  private async getUserId(): Promise<void> {
    try {
      console.info('=== å¼€å§‹è·å–ç”¨æˆ·ID ===');
      const userInfoStr = AppStorage.get<string>('userInfo');
      const userInfo: UserInfo = userInfoStr ? JSON.parse(userInfoStr) as UserInfo : {};      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        console.info(`=== è·å–åˆ°ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('=== æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
      }
    } catch (error) {
      console.error(`=== è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
    }
  }

  private async loadCalorieDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('=== ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`=== å¼€å§‹åŠ è½½çƒ­é‡æ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      // è·å–7å¤©å†å²æ•°æ®ç”¨äºå‘¨çƒ­é‡è®°å½•
      let calorieResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 7, false);
      console.info(`=== çƒ­é‡æ•°æ®å“åº”: ${JSON.stringify(calorieResponse)} ===`);

      if (calorieResponse.success && calorieResponse.data && calorieResponse.data.length > 0) {
        // è¿‡æ»¤ä»Šæ—¥æ•°æ®ç”¨äºå½“å‰çƒ­é‡æ˜¾ç¤º
        const today: string = new Date().toISOString().split('T')[0];
        const todayData: HealthDataRequest | undefined = calorieResponse.data.find((item: HealthDataRequest) => {
          const itemDate: string = (item.record_date || '').replace(/'/g, '');
          return itemDate === today;
        });

        if (todayData) {
          console.info(`=== æ‰¾åˆ°ä»Šæ—¥æ•°æ®: ${JSON.stringify(todayData)} ===`);
          this.activeCalories = todayData.active_calories || 0;
          this.caloriesGoal = todayData.calories_goal || 2000;
          this.restingCalories = todayData.basic_metabolism_calories || 0;
          this.totalCalories = this.activeCalories + this.restingCalories;
          console.info(`=== ä»Šæ—¥çƒ­é‡: æ´»åŠ¨=${this.activeCalories}, åŸºç¡€=${this.restingCalories}, æ€»è®¡=${this.totalCalories} ===`);
        } else {
          console.warn('=== ä»Šæ—¥çƒ­é‡æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼ ===');
          this.activeCalories = 0;
          this.caloriesGoal = 0;
          this.restingCalories = 0;
          this.totalCalories = 0;
        }

        // ç”Ÿæˆå‘¨çƒ­é‡è®°å½•ï¼ˆä½¿ç”¨æ‰€æœ‰7å¤©æ•°æ®ï¼‰
        this.generateWeeklyCalorieRecords(calorieResponse.data);
      } else {
        console.warn('=== çƒ­é‡æ•°æ®ä¸ºç©º ===');
      }
    } catch (error) {
      console.error(`=== æ•°æ®åŠ è½½å¼‚å¸¸: ${error} ===`);
      throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}`);
    }
  }

  private generateWeeklyCalorieRecords(calorieData: HealthDataRequest[]): void {
    console.info(`=== å¼€å§‹ç”Ÿæˆå‘¨çƒ­é‡è®°å½•ï¼Œè¾“å…¥æ•°æ®: ${calorieData.length}æ¡ ===`);

    let records: CalorieRecord[] = [];
    let today: Date = new Date();

    for (let i: number = 1; i <= 6; i++) {
      let targetDate: Date = new Date();
      targetDate.setDate(today.getDate() - i);
      let targetDateString: string = targetDate.toISOString().split('T')[0];
      let dayName: string = this.weekDays[targetDate.getDay()];

      let calorieItem: HealthDataRequest | undefined = calorieData.find((item: HealthDataRequest) => {
        let itemDate: string = (item.record_date || '').replace(/'/g, '');
        return itemDate === targetDateString;
      });

      let calories: number = calorieItem ? (calorieItem.active_calories || 0) : 0;
      let record: CalorieRecord = new CalorieRecord(dayName, calories, dayName);
      records.push(record);

      console.info(`=== ${targetDateString}(${dayName}): çƒ­é‡=${calories} ===`);
    }

    this.calorieRecords = records;
    console.info(`=== çƒ­é‡è®°å½•ç”Ÿæˆå®Œæˆï¼Œæ€»è®¡${records.length}æ¡ ===`);
  }

  private refreshCalorieData(): void {
    console.info('=== ç”¨æˆ·è§¦å‘æ•°æ®åˆ·æ–° ===');
    this.isLoading = true;
    this.errorMessage = '';
    this.initializeCalorieSystem();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          try {
            router.back();
          } catch (err) {
            console.error('Failed to go back:', err);
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text('æ´»åŠ¨çƒ­é‡')
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          this.refreshCalorieData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#FBBC05')
          Text('æ­£åœ¨åŠ è½½çƒ­é‡æ•°æ®...')
            .fontSize(18).fontColor('#333333')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ”¥').fontSize(64)
          Text('åŠ è½½å¤±è´¥')
            .fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshCalorieData())
            .backgroundColor('#FBBC05').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            // çƒ­é‡æ¦‚è§ˆå¡ç‰‡
            Column() {
              Text(`ä»Šæ—¥çƒ­é‡æ¶ˆè€— (${this.weekDays[new Date().getDay()]})`)
                .fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 20 }).fontColor('#333333')

              // çƒ­é‡è¿›åº¦åœ†ç¯
              Stack() {
                Progress({
                  value: 100,
                  total: 100,
                  type: ProgressType.Ring
                })
                  .width(160).height(160).color('#F0F0F0').style({ strokeWidth: 12 })

                Progress({
                  value: this.caloriesGoal > 0 ? this.totalCalories : 0,
                  total: this.caloriesGoal > 0 ? this.caloriesGoal : 1,
                  type: ProgressType.Ring
                })
                  .width(160).height(160).color('#FBBC05').style({ strokeWidth: 12 })

                Column() {
                  Text(this.totalCalories.toString())
                    .fontSize(36).fontWeight(FontWeight.Bold).fontColor('#FBBC05')
                  Text('åƒå¡')
                    .fontSize(16).fontColor('#666666').margin({ top: 4 })
                  Text(`${this.caloriesGoal > 0 ? Math.round((this.totalCalories / this.caloriesGoal) * 100) : 0}%`)
                    .fontSize(14).fontColor('#999999').margin({ top: 8 })
                }
              }
              .margin({ bottom: 30 })

              // çƒ­é‡ç»Ÿè®¡ä¿¡æ¯å¡ç‰‡
              Row({ space: 20 }) {
                this.buildCalorieStatCard('ç›®æ ‡', `${this.caloriesGoal} åƒå¡`, '#FBBC05', 'ğŸ¯')
                this.buildCalorieStatCard('æ´»åŠ¨æ¶ˆè€—', `${this.activeCalories} åƒå¡`, '#EA4335', 'ğŸ”¥')
                this.buildCalorieStatCard('åŸºç¡€ä»£è°¢', `${this.restingCalories} åƒå¡`, '#34A853', 'ğŸ’ª')
              }
              .width('100%').justifyContent(FlexAlign.SpaceAround)
            }
            .width('90%').padding(30).backgroundColor('#FFFFFF').borderRadius(20)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 4 })

            // æ¯æ—¥çƒ­é‡è®°å½•
            Column() {
              Text('æ¯æ—¥çƒ­é‡è®°å½•')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              if (this.calorieRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ”¥').fontSize(48)
                  Text('æš‚æ— çƒ­é‡æ•°æ®')
                    .fontSize(18).fontColor('#666666')
                  Button('åˆ·æ–°æ•°æ®')
                    .onClick(() => this.refreshCalorieData())
                    .backgroundColor('#FBBC05').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                Column({ space: 8 }) {
                  ForEach(this.calorieRecords, (record: CalorieRecord, index: number) => {
                    Row() {
                      Text(record.time).fontSize(16).fontColor('#333333').width('30%')
                      Text(`${record.value} åƒå¡`).fontSize(16).fontColor('#FBBC05')
                        .fontWeight(FontWeight.Medium).width('70%').textAlign(TextAlign.End)
                    }
                    .width('100%').padding({ top: 12, bottom: 12, left: 16, right: 16 })
                    .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(8)
                  })
                }
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })

            // çƒ­é‡å»ºè®®
            Column() {
              Row() {
                Text('çƒ­é‡å¥åº·å»ºè®®')
                  .fontSize(18).fontWeight(FontWeight.Medium).fontColor('#333333')
                Blank()
                Text('ğŸ’¡').fontSize(20)
              }
              .width('100%').margin({ bottom: 15 })

              Column({ space: 12 }) {
                this.buildCalorieAdviceItem('ä¿æŒçƒ­é‡æ‘„å…¥ä¸æ¶ˆè€—å¹³è¡¡', 'âš–ï¸')
                this.buildCalorieAdviceItem('å¢åŠ æ—¥å¸¸æ´»åŠ¨é‡', 'ğŸš¶â€â™‚ï¸')
                this.buildCalorieAdviceItem('è¿›è¡Œé«˜å¼ºåº¦é—´æ­‡è®­ç»ƒ', 'ğŸƒâ€â™‚ï¸')
                this.buildCalorieAdviceItem('å¢å¼ºè‚Œè‚‰æå‡åŸºç¡€ä»£è°¢', 'ğŸ’ª')
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  @Builder
  buildCalorieStatCard(label: string, value: string, color: string, icon: string) {
    Column() {
      Text(icon).fontSize(18).margin({ bottom: 4 })
      Text(label).fontSize(12).fontColor('#999999').margin({ bottom: 6 })
      Text(value).fontSize(12).fontWeight(FontWeight.Bold).fontColor(color)
        .textAlign(TextAlign.Center).maxLines(2).textOverflow({ overflow: TextOverflow.Ellipsis }).lineHeight(16)
    }
    .width(90).height(90).padding(6).backgroundColor('#F8F9FA').borderRadius(12)
    .justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
    .border({ width: 1, color: color, style: BorderStyle.Solid })
  }

  @Builder
  buildCalorieAdviceItem(advice: string, icon: string) {
    Row() {
      Text(icon).fontSize(20).margin({ right: 12 })
      Text(advice).fontSize(14).fontColor('#333333').textAlign(TextAlign.Start)
        .layoutWeight(1).maxLines(3).textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%').padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .backgroundColor('#F8F9FA').borderRadius(8).alignItems(VerticalAlign.Top)
  }
}