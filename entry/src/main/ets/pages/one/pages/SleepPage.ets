import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

///è¿™æ˜¯ç¡çœ åˆ†æé¡µé¢

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

class SleepPhaseData {
  type: string = '';
  duration: number = 0;

  constructor(type: string, duration: number) {
    this.type = type;
    this.duration = duration;
  }
}

class SleepRecord {
  date: string = '';
  duration: string = '';
  quality: string = '';
  score: number = 0;

  constructor(date: string, duration: string, quality: string, score: number) {
    this.date = date;
    this.duration = duration;
    this.quality = quality;
    this.score = score;
  }

  toString(): string {
    return `SleepRecord{date: ${this.date}, duration: ${this.duration}, score: ${this.score}}`;
  }
}

@Entry
@Component
export struct SleepPage {
  @State sleepScore: number = 0;
  @State totalSleepTime: string = '0å°æ—¶0åˆ†é’Ÿ';
  @State bedTime: string = '00:00';
  @State wakeTime: string = '00:00';
  @State sleepPhases: SleepPhaseData[] = [];
  @State sleepRecords: SleepRecord[] = [];
  @State selectedTimeRange: string = '';
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State userId: number = 0;

  private timeRanges: string[] = [];
  private weekDays: string[] = [];

  aboutToAppear(): void {
    console.info('=== ç¡çœ åˆ†æé¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
    this.selectedTimeRange = 'æœ¬å‘¨';
    this.timeRanges = ['ä»Šå¤©', 'æœ¬å‘¨', 'æœ¬æœˆ', 'ä»Šå¹´'];
    this.weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

    console.info('=== åˆå§‹åŒ–è®¾ç½®å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ® ===');
    this.initializeSleepSystem();
  }

  private async initializeSleepSystem(): Promise<void> {
    try {
      console.info('=== å¼€å§‹åˆå§‹åŒ–ç¡çœ ç³»ç»Ÿ ===');
      this.resetSleepData();
      await this.getUserId();
      await this.loadSleepDataFromDatabase();
      this.isLoading = false;
      console.info('=== ç¡çœ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      let errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error(`=== åˆå§‹åŒ–å¼‚å¸¸: ${errorMessage} ===`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${errorMessage}`;
      this.isLoading = false;
      this.resetSleepData();
    }
  }

  private resetSleepData(): void {
    console.info('=== é‡ç½®ç¡çœ æ•°æ® ===');
    this.sleepScore = 0;
    this.totalSleepTime = '0å°æ—¶0åˆ†é’Ÿ';
    this.bedTime = '00:00';
    this.wakeTime = '00:00';
    this.sleepPhases = [];
    this.sleepRecords = [];
  }

  private async getUserId(): Promise<void> {
    try {
      console.info('=== å¼€å§‹è·å–ç”¨æˆ·ID ===');
      let userInfo: UserInfo = await JhAESPreferencesUtils.getModel(kUserDefault_UserInfo) as UserInfo;
      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        console.info(`=== è·å–åˆ°ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('=== æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
      }
    } catch (error) {
      console.error(`=== è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
    }
  }

  private async loadSleepDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('=== ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`=== å¼€å§‹åŠ è½½ç¡çœ æ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      let sleepResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 7);
      console.info(`=== ç¡çœ æ•°æ®å“åº”: ${JSON.stringify(sleepResponse)} ===`);

      if (sleepResponse.success && sleepResponse.data && sleepResponse.data.length > 0) {
        let todayData: HealthDataRequest = sleepResponse.data[0];
        console.info(`=== ä»Šæ—¥æ•°æ®: ${JSON.stringify(todayData)} ===`);

        this.sleepScore = todayData.sleep_score || 0;
        this.totalSleepTime = this.formatDuration(todayData.sleep_duration || 0);
        this.bedTime = todayData.sleep_start_time || '00:00';
        this.wakeTime = todayData.sleep_end_time || '00:00';

        this.sleepPhases = [
          new SleepPhaseData('æ·±ç¡çœ ', todayData.deep_sleep_duration || 0),
          new SleepPhaseData('æµ…ç¡çœ ', todayData.light_sleep_duration || 0),
          new SleepPhaseData('å¿«é€Ÿçœ¼åŠ¨', todayData.rem_sleep_duration || 0),
          new SleepPhaseData('æ¸…é†’', todayData.awake_duration || 0)
        ];

        console.info(`=== ä»Šæ—¥ç¡çœ åˆ†æ•°: ${this.sleepScore}, æ—¶é•¿: ${this.totalSleepTime} ===`);
      } else {
        console.warn('=== ä»Šæ—¥ç¡çœ æ•°æ®ä¸ºç©º ===');
      }

      if (sleepResponse.success && sleepResponse.data) {
        this.generateWeeklySleepRecords(sleepResponse.data);
      } else {
        console.warn('=== å‘¨ç¡çœ æ•°æ®ä¸ºç©ºæˆ–å¤±è´¥ ===');
      }
    } catch (error) {
      let errorMessage = error instanceof Error ? error.message : 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
      console.error(`=== æ•°æ®åŠ è½½å¼‚å¸¸: ${errorMessage} ===`);
      throw new Error(errorMessage);
    }
  }

  private generateWeeklySleepRecords(sleepData: HealthDataRequest[]): void {
    console.info(`=== å¼€å§‹ç”Ÿæˆå‘¨ç¡çœ è®°å½•ï¼Œè¾“å…¥æ•°æ®: ${sleepData.length}æ¡ ===`);

    let records: SleepRecord[] = [];
    let today = new Date();

    for (let i = 1; i <= 6; i++) {
      let targetDate = new Date();
      targetDate.setDate(today.getDate() - i);
      let targetDateString = targetDate.toISOString().split('T')[0];
      let dayName = this.weekDays[targetDate.getDay()];

      let sleepItem = sleepData.find((item: HealthDataRequest) => {
        let itemDate = (item.record_date || '').replace(/'/g, '');
        return itemDate === targetDateString;
      });

      let score = sleepItem ? sleepItem.sleep_score || 0 : 0;
      let duration = sleepItem ? this.formatDuration(sleepItem.sleep_duration || 0) : '0å°æ—¶0åˆ†é’Ÿ';
      let quality = this.getScoreLevel(score);

      let record = new SleepRecord(dayName, duration, quality, score);
      records.push(record);

      console.info(`=== ${targetDateString}(${dayName}): åˆ†æ•°=${score}, æ—¶é•¿=${duration} ===`);
    }

    this.sleepRecords = records;
    console.info(`=== ç¡çœ è®°å½•ç”Ÿæˆå®Œæˆï¼Œæ€»è®¡${records.length}æ¡ ===`);
  }

  private formatDuration(minutes: number): string {
    let hours = Math.floor(minutes / 60);
    let mins = minutes % 60;
    return `${hours}å°æ—¶${mins}åˆ†é’Ÿ`;
  }

  private getScoreLevel(score: number): string {
    if (score >= 90) return 'ä¼˜ç§€';
    if (score >= 80) return 'è‰¯å¥½';
    if (score >= 60) return 'ä¸€èˆ¬';
    if (score == 0) return '--'
    return 'è¾ƒå·®';
  }

  private refreshSleepData(): void {
    console.info('=== ç”¨æˆ·è§¦å‘æ•°æ®åˆ·æ–° ===');
    this.isLoading = true;
    this.errorMessage = '';
    this.initializeSleepSystem();
  }

  build() {
    Column() {
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          try {
            router.back();
          } catch (err) {
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text('ç¡çœ åˆ†æ')
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          this.refreshSleepData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#4285F4')
          Text('æ­£åœ¨åŠ è½½ç¡çœ æ•°æ®...')
            .fontSize(18).fontColor('#333333')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ˜´').fontSize(64)
          Text('åŠ è½½å¤±è´¥')
            .fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshSleepData())
            .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            Column() {
              Text(`ä»Šæ—¥ç¡çœ æ¦‚å†µ (${this.weekDays[new Date().getDay()]})`)
                .fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 20 }).fontColor('#333333')

              Stack() {
                Progress({ value: 100, total: 100, type: ProgressType.Ring })
                  .width(160).height(160).color('#F0F0F0').style({ strokeWidth: 12 })

                Progress({
                  value: this.sleepScore,
                  total: 100,
                  type: ProgressType.Ring
                })
                  .width(160).height(160)
                  .color(this.sleepScore >= 80 ? '#34A853' : this.sleepScore >= 60 ? '#FBBC05' : '#EA4335')
                  .style({ strokeWidth: 12 })

                Column() {
                  Text(this.sleepScore.toString())
                    .fontSize(36).fontWeight(FontWeight.Bold)
                    .fontColor(this.sleepScore >= 80 ? '#34A853' : this.sleepScore >= 60 ? '#FBBC05' : '#EA4335')
                  Text('åˆ†')
                    .fontSize(16).fontColor('#666666').margin({ top: 4 })
                  Text(this.getScoreLevel(this.sleepScore))
                    .fontSize(14).fontColor('#999999').margin({ top: 8 })
                }
              }
              .margin({ bottom: 30 })

              Row({ space: 20 }) {
                this.buildSleepStatCard('æ—¶é•¿', this.totalSleepTime, '#34A853', 'ğŸ›Œ')
                this.buildSleepStatCard('å…¥ç¡', this.bedTime, '#4285F4', 'ğŸŒ™')
                this.buildSleepStatCard('é†’æ¥', this.wakeTime, '#FBBC05', 'â˜€ï¸')
              }
              .width('100%').justifyContent(FlexAlign.SpaceAround)
            }
            .width('90%').padding(30).backgroundColor('#FFFFFF').borderRadius(20)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 4 })

            Column() {
              Text('ç¡çœ é˜¶æ®µåˆ†æ')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              Column({ space: 12 }) {
                ForEach(this.sleepPhases, (phase: SleepPhaseData, index: number) => {
                  Row() {
                    Text(phase.type)
                      .fontSize(15).fontColor('#333333').fontWeight(FontWeight.Medium)
                      .width('30%')
                    Text(this.formatDuration(phase.duration))
                      .fontSize(14).fontColor('#666666')
                      .width('70%').textAlign(TextAlign.End)
                  }
                  .width('100%').padding({ top: 12, bottom: 12, left: 16, right: 16 })
                  .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(8)
                })
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })

            Column() {
              Text('ç¡çœ è®°å½•')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              if (this.sleepRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ˜´').fontSize(48)
                  Text('æš‚æ— ç¡çœ æ•°æ®')
                    .fontSize(18).fontColor('#666666')
                  Button('åˆ·æ–°æ•°æ®')
                    .onClick(() => this.refreshSleepData())
                    .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                Column({ space: 8 }) {
                  ForEach(this.sleepRecords, (record: SleepRecord, index: number) => {
                    Row() {
                      Text(record.date).fontSize(16).fontColor('#333333').width('20%')
                      Text(record.duration).fontSize(16).fontColor('#34A853')
                        .fontWeight(FontWeight.Medium).width('40%').textAlign(TextAlign.Center)
                      Text(record.quality).fontSize(16)
                        .fontColor(
                          record.score === 0 ? '#808080' :
                            record.score >= 80 ? '#34A853' :
                              record.score >= 60 ? '#FBBC05' :
                                '#EA4335'
                        )
                        .width('20%').textAlign(TextAlign.Center)
                      Text(`${record.score}åˆ†`).fontSize(16).fontColor('#666666')
                        .width('20%').textAlign(TextAlign.End)
                    }
                    .width('100%').padding({ top: 12, bottom: 12, left: 16, right: 16 })
                    .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(8)
                  })
                }
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  @Builder
  buildSleepStatCard(label: string, value: string, color: string, icon: string) {
    Column() {
      Text(icon).fontSize(20).margin({ bottom: 6 })
      Text(label).fontSize(12).fontColor('#999999').margin({ bottom: 4 })
      Text(value).fontSize(14).fontWeight(FontWeight.Bold).fontColor(color).textAlign(TextAlign.Center)
    }
    .width(80).height(80).padding(8).backgroundColor('#F8F9FA').borderRadius(12)
    .justifyContent(FlexAlign.Center).alignItems(HorizontalAlign.Center)
    .border({ width: 1, color: color })
  }
}