import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';

// è¡€æ°§è®°å½•æ•°æ®ç»“æ„

class OxygenRecord {
  time: string = '';
  value: number = 0;
  status: string = '';
  timestamp: string = '';
  category: string = '';

  constructor(time: string, value: number, status: string, timestamp?: string, category?: string) {
    console.info('[è¡€æ°§è®°å½•æ„é€ ] ======== åˆ›å»ºè¡€æ°§è®°å½•å¯¹è±¡ ========');
    console.info(`[è¡€æ°§è®°å½•æ„é€ ] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC`);
    console.info(`[è¡€æ°§è®°å½•æ„é€ ] å‚æ•°: time=${time}, value=${value}%, status=${status}, category=${category || 'å®æ—¶'}`);

    this.time = time;
    this.value = value;
    this.status = status;
    this.timestamp = timestamp || '';
    this.category = category || 'å®æ—¶';

    console.info(`[è¡€æ°§è®°å½•æ„é€ ] è¡€æ°§è®°å½•å¯¹è±¡åˆ›å»ºå®Œæˆ: ${this.toString()}`);
  }

  toString(): string {
    return `OxygenRecord{time: ${this.time}, value: ${this.value}%, status: ${this.status}, category: ${this.category}}`;
  }
}

// è¡€æ°§ç»Ÿè®¡æ•°æ®ç»“æ„
class OxygenStats {
  minValue: number = 0;
  maxValue: number = 0;
  avgValue: number = 0;
  currentValue: number = 0;
  recordCount: number = 0;

  constructor() {}

  toString(): string {
    return `OxygenStats{min: ${this.minValue}%, max: ${this.maxValue}%, avg: ${this.avgValue}%, current: ${this.currentValue}%, count: ${this.recordCount}}`;
  }
}

// å­˜å‚¨çš„è¡€æ°§æ•°æ®ç»“æ„
class StoredOxygenData {
  timestamp: string = '';
  type: string = '';
  value: string = '';
  unit: string = '';
  additionalInfo: OxygenAdditionalInfo = new OxygenAdditionalInfo();

  constructor(timestamp: string, type: string, value: string, unit: string, additionalInfo?: OxygenAdditionalInfo) {
    this.timestamp = timestamp;
    this.type = type;
    this.value = value;
    this.unit = unit;
    if (additionalInfo) {
      this.additionalInfo = additionalInfo;
    }
  }

  toString(): string {
    return `StoredOxygenData{timestamp: "${this.timestamp}", type: "${this.type}", value: "${this.value}%", category: "${this.additionalInfo.category}"}`;
  }
}

// è¡€æ°§é™„åŠ ä¿¡æ¯ç»“æ„
class OxygenAdditionalInfo {
  category: string = '';
  minValue: string = '';
  maxValue: string = '';
  avgValue: string = '';

  constructor() {}

  toString(): string {
    return `OxygenAdditionalInfo{category: "${this.category}", min: "${this.minValue}%", max: "${this.maxValue}%", avg: "${this.avgValue}%"}`;
  }
}

// åˆ†ç±»æ ‡å¿—ç±»
class CategoryFlags {
  current: boolean = false;
  max: boolean = false;
  min: boolean = false;
  avg: boolean = false;

  constructor() {}

  toString(): string {
    return `CategoryFlags{current: ${this.current}, max: ${this.max}, min: ${this.min}, avg: ${this.avg}}`;
  }
}

@Entry
@Component
export struct BloodOxygenPage {
  @State currentOxygen: number = 0;
  @State minOxygen: number = 0;
  @State maxOxygen: number = 0;
  @State avgOxygen: number = 0;
  @State oxygenRecords: OxygenRecord[] = [];
  @State selectedTimeRange: string = '';
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State oxygenStats: OxygenStats = new OxygenStats();
  @State hasDataLoaded: boolean = false;

  private preferencesHelper: preferences.Preferences | null = null;

  private getTimeRanges(): string[] {
    return [
      getContext(this).resourceManager.getStringSync($r('app.string.today_timerange_629384751952847847392615738294751629384751952847392')),
      getContext(this).resourceManager.getStringSync($r('app.string.this_week_timerange_847392615738294184759362847392847392615738294847392')),
      getContext(this).resourceManager.getStringSync($r('app.string.this_month_timerange_573829461847392847392615738294751629384751952847392')),
      getContext(this).resourceManager.getStringSync($r('app.string.this_year_timerange_392847516293847184759362847392615738294847392615738'))
    ];
  }

  aboutToAppear(): void {
    console.info('[è¡€æ°§é¡µé¢] ================ æ™ºèƒ½è¡€æ°§ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ================');
    console.info('[è¡€æ°§é¡µé¢] å½“å‰ç”¨æˆ·: gadz2021, ç³»ç»Ÿæ—¶é—´: 2025-05-31 03:44:39 UTC');
    console.info('[è¡€æ°§é¡µé¢] é¡µé¢ç‰ˆæœ¬: v1.1.0, åŠŸèƒ½: è¡€æ°§æ•°æ®æŒä¹…åŒ–å­˜å‚¨ä¸è¯»å–');
    console.info('[è¡€æ°§é¡µé¢] æ ¸å¿ƒåŠŸèƒ½: å½“å‰ã€æœ€ä½ã€å¹³å‡ã€æœ€é«˜è¡€æ°§ç»Ÿè®¡ï¼Œå®æ—¶è¡€æ°§è®°å½•åˆ†ç¦»');
    console.info('[è¡€æ°§é¡µé¢] ä¿®å¤å†…å®¹: æ— æ•°æ®æ—¶æ˜¾ç¤º0ï¼Œæ•°æ®è¯»å–å¼‚å¸¸å¤„ç†');
    console.info('[è¡€æ°§é¡µé¢] æ•°æ®æ¥æº: é¸¿è’™PreferencesæŒä¹…åŒ–å­˜å‚¨ç³»ç»Ÿ');
    console.info('[è¡€æ°§é¡µé¢] å¼€å§‹åˆå§‹åŒ–è¡€æ°§ç›‘æµ‹ç³»ç»Ÿ');

    this.selectedTimeRange = getContext(this).resourceManager.getStringSync($r('app.string.today_timerange_629384751952847847392615738294751629384751952847392'));
    this.initializeOxygenSystem();
  }

  private async initializeOxygenSystem(): Promise<void> {
    try {
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== è¡€æ°§ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–å¼€å§‹ ========');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ç›®æ ‡: ä»æŒä¹…åŒ–å­˜å‚¨åŠ è½½è¡€æ°§æ•°æ®ï¼Œæ™ºèƒ½åˆ†ç±»ç»Ÿè®¡ä¸å®æ—¶æ•°æ®');
      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ç­–ç•¥: æ— æ•°æ®æ—¶æ˜¾ç¤º0ï¼Œæœ‰æ•°æ®æ—¶æ˜¾ç¤ºçœŸå®å€¼');

      // é‡ç½®æ‰€æœ‰æ•°æ®ä¸º0
      this.resetOxygenData();

      await this.initPreferences();
      await this.loadOxygenDataFromStorage();
      this.calculateOxygenStatistics();
      this.isLoading = false;

      console.info('[ç³»ç»Ÿåˆå§‹åŒ–] ======== è¡€æ°§ç›‘æµ‹ç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ ========');
      console.info(`[ç³»ç»Ÿåˆå§‹åŒ–] æ•°æ®åŠ è½½çŠ¶æ€: ${this.hasDataLoaded ? 'å·²åŠ è½½çœŸå®æ•°æ®' : 'æ— æ•°æ®æ˜¾ç¤º0'}`);
      console.info(`[ç³»ç»Ÿåˆå§‹åŒ–] æœ€ç»ˆè¡€æ°§ç»Ÿè®¡: å½“å‰=${this.currentOxygen}%, æœ€é«˜=${this.maxOxygen}%, å¹³å‡=${this.avgOxygen}%, æœ€ä½=${this.minOxygen}%`);
      console.info(`[ç³»ç»Ÿåˆå§‹åŒ–] å®æ—¶è¡€æ°§è®°å½•æ•°é‡: ${this.oxygenRecords.length} æ¡`);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] è¡€æ°§ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${errorMessage}`);
      console.error(`[ç³»ç»Ÿåˆå§‹åŒ–] å½“å‰ç”¨æˆ·: gadz2021, é”™è¯¯æ—¶é—´: 2025-05-31 03:44:39 UTC`);
      this.errorMessage = `è¡€æ°§æ•°æ®åŠ è½½å¤±è´¥: ${errorMessage}`;
      this.isLoading = false;
      this.resetOxygenData();
    }
  }

  private resetOxygenData(): void {
    console.info('[æ•°æ®é‡ç½®] ======== é‡ç½®è¡€æ°§æ•°æ®ä¸ºåˆå§‹çŠ¶æ€ ========');
    console.info('[æ•°æ®é‡ç½®] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
    console.info('[æ•°æ®é‡ç½®] ç­–ç•¥: æ‰€æœ‰ç»Ÿè®¡æ•°æ®è®¾ä¸º0ï¼Œå®æ—¶è®°å½•æ¸…ç©º');

    this.currentOxygen = 0;
    this.minOxygen = 0;
    this.maxOxygen = 0;
    this.avgOxygen = 0;
    this.oxygenRecords = [];
    this.hasDataLoaded = false;

    this.oxygenStats.currentValue = 0;
    this.oxygenStats.minValue = 0;
    this.oxygenStats.maxValue = 0;
    this.oxygenStats.avgValue = 0;
    this.oxygenStats.recordCount = 0;

    console.info('[æ•°æ®é‡ç½®] è¡€æ°§æ•°æ®é‡ç½®å®Œæˆï¼Œæ‰€æœ‰å€¼å·²è®¾ä¸º0');
  }

  private async initPreferences(): Promise<void> {
    console.info('[å­˜å‚¨ç³»ç»Ÿ] ======== åˆå§‹åŒ–é¸¿è’™Preferenceså­˜å‚¨ç³»ç»Ÿ ========');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] å­˜å‚¨åŸŸ: health_data, ç›®æ ‡é”®: health_records');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] è¡€æ°§æ•°æ®ç±»å‹: blood_oxygen, å•ä½: %');

    this.preferencesHelper = await preferences.getPreferences(getContext(), 'health_data');

    console.info('[å­˜å‚¨ç³»ç»Ÿ] Preferencesè¿æ¥æˆåŠŸï¼Œè¡€æ°§æ•°æ®å­˜å‚¨ç³»ç»Ÿå¯ç”¨');
    console.info('[å­˜å‚¨ç³»ç»Ÿ] æ”¯æŒæ“ä½œ: è¡€æ°§æ•°æ®è¯»å–ã€ç»Ÿè®¡è®¡ç®—ã€å®æ—¶è®°å½•åˆ†ç¦»');
  }

  private async loadOxygenDataFromStorage(): Promise<void> {
    if (!this.preferencesHelper) {
      console.warn('[è¡€æ°§æ•°æ®åŠ è½½] å­˜å‚¨ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè·³è¿‡æ•°æ®åŠ è½½');
      return;
    }

    try {
      console.info('[è¡€æ°§æ•°æ®åŠ è½½] ======== å¼€å§‹ä»å­˜å‚¨è¯»å–è¡€æ°§æ•°æ® ========');
      console.info('[è¡€æ°§æ•°æ®åŠ è½½] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
      console.info('[è¡€æ°§æ•°æ®åŠ è½½] è¯»å–ç­–ç•¥: åŒ¹é…blood_oxygenç±»å‹ï¼ŒåŸºäºcategoryå­—æ®µæ™ºèƒ½åˆ†ç±»');

      const storedData = await this.preferencesHelper.get('health_records', '[]') as string;
      console.info(`[è¡€æ°§æ•°æ®åŠ è½½] åŸå§‹å­˜å‚¨æ•°æ®é•¿åº¦: ${storedData.length} å­—ç¬¦`);

      if (storedData === '[]' || storedData.length === 0) {
        console.warn('[è¡€æ°§æ•°æ®åŠ è½½] å­˜å‚¨ä¸ºç©ºï¼Œä¿æŒæ•°æ®ä¸º0çŠ¶æ€');
        console.info('[è¡€æ°§æ•°æ®åŠ è½½] ======== è¡€æ°§æ•°æ®åŠ è½½å®Œæˆï¼ˆæ— æ•°æ®ï¼‰ ========');
        return;
      }

      const healthRecords: StoredOxygenData[] = JSON.parse(storedData);
      console.info(`[è¡€æ°§æ•°æ®åŠ è½½] JSONè§£ææˆåŠŸï¼Œå¥åº·è®°å½•æ€»æ•°: ${healthRecords.length} æ¡`);

      const oxygenRecords = healthRecords.filter((record: StoredOxygenData) =>
      record.type === 'blood_oxygen'
      );
      console.info(`[è¡€æ°§æ•°æ®åŠ è½½] è¡€æ°§è®°å½•è¿‡æ»¤å®Œæˆï¼Œæ‰¾åˆ° ${oxygenRecords.length} æ¡è¡€æ°§è®°å½•`);

      if (oxygenRecords.length === 0) {
        console.warn('[è¡€æ°§æ•°æ®åŠ è½½] æ— è¡€æ°§è®°å½•ï¼Œä¿æŒæ•°æ®ä¸º0çŠ¶æ€');
        console.info('[è¡€æ°§æ•°æ®åŠ è½½] ======== è¡€æ°§æ•°æ®åŠ è½½å®Œæˆï¼ˆæ— è¡€æ°§æ•°æ®ï¼‰ ========');
        return;
      }

      this.processOxygenRecords(oxygenRecords);
      this.hasDataLoaded = true;
      console.info('[è¡€æ°§æ•°æ®åŠ è½½] ======== è¡€æ°§æ•°æ®åŠ è½½å®Œæˆï¼ˆæœ‰æ•°æ®ï¼‰ ========');
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯';
      console.error(`[è¡€æ°§æ•°æ®åŠ è½½] æ•°æ®åŠ è½½å¼‚å¸¸: ${errorMessage}`);
      console.error(`[è¡€æ°§æ•°æ®åŠ è½½] ä¿æŒæ•°æ®ä¸º0çŠ¶æ€`);
    }
  }

  private processOxygenRecords(storedRecords: StoredOxygenData[]): void {
    console.info('[è¡€æ°§æ•°æ®å¤„ç†] ======== å¼€å§‹å¤„ç†è¡€æ°§è®°å½•ï¼ˆæ™ºèƒ½åˆ†ç±»ç‰ˆï¼‰ ========');
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] å½“å‰ç”¨æˆ·: gadz2021, å¤„ç†æ—¶é—´: 2025-05-31 03:44:39 UTC`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] å¾…å¤„ç†è¡€æ°§è®°å½•æ€»æ•°: ${storedRecords.length} æ¡`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] åˆ†ç±»ç­–ç•¥: åŸºäºcategoryå­—æ®µåˆ†ç¦»ç»Ÿè®¡æ•°æ®å’Œå®æ—¶æ•°æ®`);

    const processedRecords: OxygenRecord[] = [];
    const categoryFlags = new CategoryFlags();

    storedRecords.forEach((record: StoredOxygenData, index: number) => {
      console.info(`[è¡€æ°§æ•°æ®å¤„ç†] å¤„ç†ç¬¬ ${index + 1}/${storedRecords.length} æ¡è¡€æ°§è®°å½•`);
      console.info(`[è¡€æ°§æ•°æ®å¤„ç†] è¡€æ°§è®°å½•è¯¦æƒ…: ${record.toString()}`);

      const oxygenValue = parseInt(record.value) || 0;
      if (oxygenValue <= 0) {
        console.warn(`[è¡€æ°§æ•°æ®å¤„ç†] è¡€æ°§æ•°å€¼æ— æ•ˆ: ${record.value}%, è·³è¿‡å¤„ç†`);
        return;
      }

      const timeStr = this.extractTimeFromTimestamp(record.timestamp);
      const status = this.getOxygenStatus(oxygenValue);
      const category = record.additionalInfo?.category || 'å®æ—¶';
      const categoryLower = category.toLowerCase();

      console.info(`[è¡€æ°§æ•°æ®å¤„ç†] è¡€æ°§å€¼: ${oxygenValue}%, åŸå§‹ç±»åˆ«: "${category}"`);
      console.info(`[è¡€æ°§æ•°æ®å¤„ç†] ç±»åˆ«åˆ†æ: "${categoryLower}"`);

      // ä¸¥æ ¼çš„è¡€æ°§ç±»åˆ«è¯†åˆ«å’Œåˆ†ç±»å¤„ç†
      if (categoryLower.includes('å½“å‰') || categoryLower.includes('current')) {
        if (!categoryFlags.current) {
          this.currentOxygen = oxygenValue;
          categoryFlags.current = true;
          console.info(`[è¡€æ°§æ•°æ®å¤„ç†] âœ… è®¾ç½®å½“å‰è¡€æ°§: ${oxygenValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('æœ€é«˜') || categoryLower.includes('max') || categoryLower.includes('highest')) {
        if (!categoryFlags.max) {
          this.maxOxygen = oxygenValue;
          categoryFlags.max = true;
          console.info(`[è¡€æ°§æ•°æ®å¤„ç†] âœ… è®¾ç½®æœ€é«˜è¡€æ°§: ${oxygenValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('æœ€ä½') || categoryLower.includes('min') || categoryLower.includes('lowest')) {
        if (!categoryFlags.min) {
          this.minOxygen = oxygenValue;
          categoryFlags.min = true;
          console.info(`[è¡€æ°§æ•°æ®å¤„ç†] âœ… è®¾ç½®æœ€ä½è¡€æ°§: ${oxygenValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else if (categoryLower.includes('å¹³å‡') || categoryLower.includes('avg') || categoryLower.includes('average')) {
        if (!categoryFlags.avg) {
          this.avgOxygen = oxygenValue;
          categoryFlags.avg = true;
          console.info(`[è¡€æ°§æ•°æ®å¤„ç†] âœ… è®¾ç½®å¹³å‡è¡€æ°§: ${oxygenValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
        }
      } else {
        // åªæœ‰çœŸæ­£çš„å®æ—¶è®°å½•æ‰æ·»åŠ åˆ°åˆ—è¡¨ä¸­
        const oxygenRecord = new OxygenRecord(timeStr, oxygenValue, status, record.timestamp, category);
        processedRecords.push(oxygenRecord);
        console.info(`[è¡€æ°§æ•°æ®å¤„ç†] âœ… æ·»åŠ å®æ—¶è¡€æ°§è®°å½•: ${oxygenRecord.toString()}`);
      }

      // ä»additionalInfoä¸­æå–ç»Ÿè®¡æ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
      if (record.additionalInfo) {
        this.extractAdditionalStatistics(record.additionalInfo, categoryFlags);
      }
    });

    // æŒ‰æ—¶é—´æ’åºï¼Œæœ€æ–°çš„åœ¨å‰
    processedRecords.sort((a: OxygenRecord, b: OxygenRecord) =>
    b.timestamp.localeCompare(a.timestamp)
    );

    this.oxygenRecords = processedRecords;

    console.info('[è¡€æ°§æ•°æ®å¤„ç†] ======== è¡€æ°§è®°å½•å¤„ç†å®Œæˆï¼ˆæ™ºèƒ½åˆ†ç±»ç‰ˆï¼‰ ========');
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] åˆ†ç±»è®¾ç½®ç»“æœ:`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] - å½“å‰è¡€æ°§: ${categoryFlags.current ? this.currentOxygen + '%' : '0% (æœªè®¾ç½®)'}`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] - æœ€é«˜è¡€æ°§: ${categoryFlags.max ? this.maxOxygen + '%' : '0% (æœªè®¾ç½®)'}`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] - æœ€ä½è¡€æ°§: ${categoryFlags.min ? this.minOxygen + '%' : '0% (æœªè®¾ç½®)'}`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] - å¹³å‡è¡€æ°§: ${categoryFlags.avg ? this.avgOxygen + '%' : '0% (æœªè®¾ç½®)'}`);
    console.info(`[è¡€æ°§æ•°æ®å¤„ç†] - å®æ—¶è¡€æ°§è®°å½•æ•°é‡: ${processedRecords.length} æ¡ï¼ˆçº¯å®æ—¶æ•°æ®ï¼‰`);
  }

  private extractAdditionalStatistics(additionalInfo: OxygenAdditionalInfo, categoryFlags: CategoryFlags): void {
    console.info(`[è¡€æ°§ç»Ÿè®¡æå–] æ£€æŸ¥é™„åŠ è¡€æ°§ç»Ÿè®¡ä¿¡æ¯: ${additionalInfo.toString()}`);
    console.info(`[è¡€æ°§ç»Ÿè®¡æå–] å½“å‰åˆ†ç±»æ ‡å¿—çŠ¶æ€: ${categoryFlags.toString()}`);

    if (additionalInfo.maxValue && additionalInfo.maxValue !== '' && !categoryFlags.max) {
      const maxValue = parseInt(additionalInfo.maxValue) || 0;
      if (maxValue > 0) {
        this.maxOxygen = maxValue;
        categoryFlags.max = true;
        console.info(`[è¡€æ°§ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®æœ€é«˜è¡€æ°§: ${maxValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    if (additionalInfo.avgValue && additionalInfo.avgValue !== '' && !categoryFlags.avg) {
      const avgValue = parseInt(additionalInfo.avgValue) || 0;
      if (avgValue > 0) {
        this.avgOxygen = avgValue;
        categoryFlags.avg = true;
        console.info(`[è¡€æ°§ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®å¹³å‡è¡€æ°§: ${avgValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    if (additionalInfo.minValue && additionalInfo.minValue !== '' && !categoryFlags.min) {
      const minValue = parseInt(additionalInfo.minValue) || 0;
      if (minValue > 0) {
        this.minOxygen = minValue;
        categoryFlags.min = true;
        console.info(`[è¡€æ°§ç»Ÿè®¡æå–] âœ… ä»é™„åŠ ä¿¡æ¯è®¾ç½®æœ€ä½è¡€æ°§: ${minValue}% ï¼ˆä¸æ·»åŠ åˆ°å®æ—¶è®°å½•ï¼‰`);
      }
    }

    console.info(`[è¡€æ°§ç»Ÿè®¡æå–] æå–å®Œæˆååˆ†ç±»æ ‡å¿—çŠ¶æ€: ${categoryFlags.toString()}`);
  }

  private extractTimeFromTimestamp(timestamp: string): string {
    console.info(`[æ—¶é—´è§£æ] è§£æè¡€æ°§æ—¶é—´æˆ³: ${timestamp}`);

    if (!timestamp) {
      const currentTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      console.info(`[æ—¶é—´è§£æ] æ—¶é—´æˆ³ä¸ºç©ºï¼Œä½¿ç”¨å½“å‰æ—¶é—´: ${currentTime}`);
      return currentTime;
    }

    if (timestamp.includes(' ')) {
      const timePart = timestamp.split(' ')[1];
      if (timePart && timePart.includes(':')) {
        const timeComponents = timePart.split(':');
        const extractedTime = `${timeComponents[0]}:${timeComponents[1]}`;
        console.info(`[æ—¶é—´è§£æ] è¡€æ°§æ—¶é—´è§£æç»“æœ: ${extractedTime}`);
        return extractedTime;
      }
    }

    const date = new Date(timestamp);
    if (!isNaN(date.getTime())) {
      const extractedTime = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
      console.info(`[æ—¶é—´è§£æ] Dateè§£æè¡€æ°§æ—¶é—´ç»“æœ: ${extractedTime}`);
      return extractedTime;
    }

    const fallbackTime = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
    console.warn(`[æ—¶é—´è§£æ] è¡€æ°§æ—¶é—´è§£æå¤±è´¥ï¼Œä½¿ç”¨å½“å‰æ—¶é—´: ${fallbackTime}`);
    return fallbackTime;
  }

  private getOxygenStatus(value: number): string {
    console.info(`[è¡€æ°§çŠ¶æ€åˆ¤æ–­] åˆ¤æ–­è¡€æ°§çŠ¶æ€: ${value}%`);

    const statusMap = new Map<string, string>([
      ['ä¸¥é‡åä½', 'ä¸¥é‡åä½'],
      ['åä½', 'åä½'],
      ['æ­£å¸¸', 'æ­£å¸¸'],
      ['å¼‚å¸¸', 'å¼‚å¸¸']
    ]);

    const statusKey = value < 90 ? 'ä¸¥é‡åä½' : value < 95 ? 'åä½' : value <= 100 ? 'æ­£å¸¸' : 'å¼‚å¸¸';
    const status = statusMap.get(statusKey) as string;

    console.info(`[è¡€æ°§çŠ¶æ€åˆ¤æ–­] è¡€æ°§çŠ¶æ€ç»“æœ: ${status}`);
    return status;
  }

  private calculateOxygenStatistics(): void {
    console.info('[è¡€æ°§ç»Ÿè®¡è®¡ç®—] ======== å¼€å§‹è®¡ç®—è¡€æ°§ç»Ÿè®¡æ•°æ® ========');
    console.info('[è¡€æ°§ç»Ÿè®¡è®¡ç®—] å½“å‰ç”¨æˆ·: gadz2021, è®¡ç®—æ—¶é—´: 2025-05-31 03:44:39 UTC');
    console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] æ•°æ®åŠ è½½çŠ¶æ€: ${this.hasDataLoaded ? 'æœ‰çœŸå®æ•°æ®' : 'æ— æ•°æ®'}`);
    console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] å½“å‰è¡€æ°§çŠ¶æ€: å½“å‰=${this.currentOxygen}%, æœ€é«˜=${this.maxOxygen}%, å¹³å‡=${this.avgOxygen}%, æœ€ä½=${this.minOxygen}%`);
    console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] å®æ—¶è¡€æ°§è®°å½•æ•°é‡: ${this.oxygenRecords.length} æ¡`);

    // åªæœ‰åœ¨æœ‰æ•°æ®åŠ è½½ä¸”æŸäº›ç»Ÿè®¡æ•°æ®ç¼ºå¤±æ—¶ï¼Œæ‰ä»å®æ—¶è®°å½•ä¸­è®¡ç®—
    if (this.hasDataLoaded && this.oxygenRecords.length > 0) {
      const values = this.oxygenRecords.map((record: OxygenRecord) => record.value);
      console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] å®æ—¶è¡€æ°§è®°å½•æ•°å€¼: ${values.join('%, ')}%`);

      if (this.minOxygen === 0) {
        this.minOxygen = Math.min(...values);
        console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—æœ€ä½è¡€æ°§: ${this.minOxygen}%`);
      }

      if (this.maxOxygen === 0) {
        this.maxOxygen = Math.max(...values);
        console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—æœ€é«˜è¡€æ°§: ${this.maxOxygen}%`);
      }

      if (this.avgOxygen === 0) {
        this.avgOxygen = Math.round(values.reduce((sum: number, value: number) => sum + value, 0) / values.length);
        console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] ä»å®æ—¶è®°å½•è®¡ç®—å¹³å‡è¡€æ°§: ${this.avgOxygen}%`);
      }
    } else {
      console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] æ— æ•°æ®æˆ–æ— å®æ—¶è®°å½•ï¼Œä¿æŒç»Ÿè®¡æ•°æ®ä¸º0`);
    }

    // æ›´æ–°ç»Ÿè®¡å¯¹è±¡
    this.oxygenStats.currentValue = this.currentOxygen;
    this.oxygenStats.minValue = this.minOxygen;
    this.oxygenStats.maxValue = this.maxOxygen;
    this.oxygenStats.avgValue = this.avgOxygen;
    this.oxygenStats.recordCount = this.oxygenRecords.length;

    console.info('[è¡€æ°§ç»Ÿè®¡è®¡ç®—] ======== è¡€æ°§ç»Ÿè®¡è®¡ç®—å®Œæˆ ========');
    console.info(`[è¡€æ°§ç»Ÿè®¡è®¡ç®—] æœ€ç»ˆè¡€æ°§ç»Ÿè®¡: ${this.oxygenStats.toString()}`);
  }

  private refreshOxygenData(): void {
    console.info('[æ•°æ®åˆ·æ–°] ======== å¼€å§‹åˆ·æ–°è¡€æ°§æ•°æ® ========');
    console.info('[æ•°æ®åˆ·æ–°] å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');

    this.isLoading = true;
    this.errorMessage = '';
    this.initializeOxygenSystem();
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»è¿”å›æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
          try {
            router.back();
            console.info('[ç”¨æˆ·æ“ä½œ] è¡€æ°§é¡µé¢è·¯ç”±è¿”å›æˆåŠŸ');
          } catch (err) {
            console.error('[ç”¨æˆ·æ“ä½œ] è¡€æ°§é¡µé¢è·¯ç”±è¿”å›å¤±è´¥ï¼Œæ‰§è¡Œé™çº§æ–¹æ¡ˆ');
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text(getContext(this).resourceManager.getStringSync($r('app.string.blood_oxygen_saturation_title_847392615738294629384751952847392615738'))).fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»åˆ·æ–°è¡€æ°§æ•°æ®æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
          this.refreshOxygenData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        // åŠ è½½çŠ¶æ€
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#9C27B0')
          Text(getContext(this).resourceManager.getStringSync($r('app.string.loading_oxygen_data_text_573829461847392847392615738294751629384751'))).fontSize(18).fontColor('#333333')
          Text(getContext(this).resourceManager.getStringSync($r('app.string.current_user_prefix_392847516293847184759362847392615738294847392'))).fontSize(12).fontColor('#999999')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        // é”™è¯¯çŠ¶æ€
        Column({ space: 20 }) {
          Text('ğŸ«').fontSize(64)
          Text(getContext(this).resourceManager.getStringSync($r('app.string.oxygen_data_load_failed_758394627184759629384751952847392847392615738'))).fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button(getContext(this).resourceManager.getStringSync($r('app.string.reload_button_text_184759362847392573829461847392847392615738294')))
            .onClick(() => {
              console.info('[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·ç‚¹å‡»é‡æ–°åŠ è½½è¡€æ°§æ•°æ®æŒ‰é’®, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC');
              this.refreshOxygenData();
            })
            .backgroundColor('#9C27B0').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        // æ­£å¸¸å†…å®¹
        Scroll() {
          Column({ space: 20 }) {
            // å½“å‰è¡€æ°§æ˜¾ç¤º
            Column() {
              Text(getContext(this).resourceManager.getStringSync($r('app.string.current_oxygen_saturation_629384751952847847392615738294751629384751952'))).fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 10 })

              Row() {
                Text(this.currentOxygen.toString()).fontSize(48).fontWeight(FontWeight.Bold).fontColor('#9C27B0')
                Text(' %').fontSize(20).fontColor('#666666').margin({ bottom: 5 })
              }

              Text(getContext(this).resourceManager.getStringSync($r('app.string.normal_range_text_847392615738294184759362847392847392615738294847')) + (this.hasDataLoaded ? '' : getContext(this).resourceManager.getStringSync($r('app.string.no_data_suffix_573829461847392847392615738294751629384751952847392')))).fontSize(14)
                .fontColor('#666666').margin({ top: 5 })
            }
            .width('90%').padding(20).backgroundColor('#F8F8F8').borderRadius(15)
            .justifyContent(FlexAlign.Center)

            // ç»Ÿè®¡æ•°æ®
            Row() {
              this.statCard(getContext(this).resourceManager.getStringSync($r('app.string.lowest_label_392847516293847184759362847392615738294847392615738')), `${this.minOxygen} %`, '#FBBC05')
              this.statCard(getContext(this).resourceManager.getStringSync($r('app.string.average_label_758394627184759629384751952847392847392615738294751')), `${this.avgOxygen} %`, '#34A853')
              this.statCard(getContext(this).resourceManager.getStringSync($r('app.string.highest_label_184759362847392573829461847392847392615738294847392')), `${this.maxOxygen} %`, '#4285F4')
            }
            .width('90%').justifyContent(FlexAlign.SpaceBetween)

            // æ—¶é—´èŒƒå›´é€‰æ‹©å™¨
            Row() {
              ForEach(this.getTimeRanges(), (range: string) => {
                Text(range)
                  .fontSize(14)
                  .fontColor(this.selectedTimeRange === range ? '#9C27B0' : '#666666')
                  .fontWeight(this.selectedTimeRange === range ? FontWeight.Bold : FontWeight.Normal)
                  .padding(8)
                  .backgroundColor(this.selectedTimeRange === range ? '#F3E5F5' : 'transparent')
                  .borderRadius(15)
                  .onClick(() => {
                    console.info(`[ç”¨æˆ·æ“ä½œ] ç”¨æˆ·é€‰æ‹©è¡€æ°§æ—¶é—´èŒƒå›´: ${range}, å½“å‰ç”¨æˆ·: gadz2021, æ—¶é—´: 2025-05-31 03:44:39 UTC`);
                    this.selectedTimeRange = range;
                  })
              })
            }
            .width('90%').justifyContent(FlexAlign.SpaceAround)

            // è¡€æ°§å†å²è®°å½•
            Column() {
              Text(getContext(this).resourceManager.getStringSync($r('app.string.oxygen_records_title_758394627184759629384751952847392847392615738294751'))).fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 10 })

              if (this.oxygenRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ«').fontSize(48)
                  Text(this.hasDataLoaded ? getContext(this).resourceManager.getStringSync($r('app.string.no_realtime_oxygen_records_184759362847392573829461847392847392615738294847')) : getContext(this).resourceManager.getStringSync($r('app.string.no_oxygen_data_629384751952847847392615738294751629384751952847392615'))).fontSize(18).fontColor('#666666')
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.realtime_records_only_text_847392'))).fontSize(12)
                    .fontColor('#999999').textAlign(TextAlign.Center)
                  if (!this.hasDataLoaded) {
                    Button(getContext(this).resourceManager.getStringSync($r('app.string.refresh_data_button_573829461847392847392615738294751629384751952847392847'))).onClick(() => this.refreshOxygenData())
                      .backgroundColor('#9C27B0').fontColor(Color.White).borderRadius(20).height(40)
                  }
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                List({ space: 8 }) {
                  ForEach(this.oxygenRecords, (record: OxygenRecord) => {
                    ListItem() {
                      Row({ space: 16 }) {
                        Column({ space: 4 }) {
                          Text(record.time).fontSize(16).fontColor('#333333')
                          Text(record.category).fontSize(12).fontColor('#999999')
                        }
                        .alignItems(HorizontalAlign.Start)

                        Blank()

                        Column({ space: 4 }) {
                          Row({ space: 4 }) {
                            Text('ğŸ«').fontSize(14)
                            Text(`${record.value}`).fontSize(18)
                              .fontColor(record.value < 95 ? '#EA4335' : '#34A853')
                              .fontWeight(FontWeight.Bold)
                            Text('%').fontSize(12).fontColor('#666666')
                          }
                          .justifyContent(FlexAlign.Center)

                          Text(record.status).fontSize(12)
                            .fontColor(record.value < 95 ? '#EA4335' : '#34A853')
                            .padding({ left: 8, right: 8, top: 2, bottom: 2 })
                            .backgroundColor(record.value < 95 ? 'rgba(234,67,53,0.1)' : 'rgba(52,168,83,0.1)')
                            .borderRadius(8)
                        }
                        .alignItems(HorizontalAlign.End)
                      }
                      .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)
                    }
                  })
                }
                .width('100%').height(300).scrollBar(BarState.Auto)
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(15)

            // å¥åº·å»ºè®®
            Column() {
              Text(getContext(this).resourceManager.getStringSync($r('app.string.oxygen_health_tips_title_392847'))).fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 10 })

              Column({ space: 12 }) {
                Row({ space: 12 }) {
                  Text('ğŸ“Š').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.normal_oxygen_range_tip_758394627184759629384751952847392847392615738294751629'))).fontSize(14).fontColor('#333333')
                    .layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('ğŸŒ¬ï¸').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.breathing_habit_tip_184759362847392573829461847392847392615738294847392615738'))).fontSize(14)
                    .fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('ğŸƒâ€â™‚ï¸').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.exercise_tip_629384751952847847392615738294751629384751952847392615738294'))).fontSize(14)
                    .fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)

                Row({ space: 12 }) {
                  Text('ğŸ‘¨â€âš•ï¸').fontSize(18)
                  Text(getContext(this).resourceManager.getStringSync($r('app.string.consult_doctor_tip_847392'))).fontSize(14)
                    .fontColor('#333333').layoutWeight(1).lineHeight(22)
                }
                .width('100%').padding(16).backgroundColor('#F8F9FA').borderRadius(12)
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor(Color.White)
  }

  @Builder
  statCard(title: string, value: string, color: string) {
    Column() {
      Text(title).fontSize(14).fontColor('#666666')
      Text(value).fontSize(18).fontWeight(FontWeight.Bold).fontColor(color)
    }
    .width('30%').padding(10).backgroundColor('#FFFFFF').borderRadius(8)
    .justifyContent(FlexAlign.Center)
    .shadow({ radius: 6, color: 'rgba(0,0,0,0.06)', offsetY: 3 })
  }
}