import { BaseNavigation } from 'JhCommon';
import { router } from '@kit.ArkUI';
import { userApiService, HealthDataResponse, HealthDataRequest, RealtimeDataResponse, RealtimeDataRequest } from '../../../services/api_network/UserApiService';
import { JhAESPreferencesUtils, kUserDefault_UserInfo } from 'JhCommon';

//æƒ…ç»ªçŠ¶æ€é¡µé¢

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

interface RouterParams {
  user_id?: number;
}

class MoodRecord {
  time: string;
  mood: string;
  description: string;
  color: string;

  constructor(time: string, mood: string, description: string, color: string) {
    this.time = time;
    this.mood = mood;
    this.description = description;
    this.color = color;
  }

  toString(): string {
    return `MoodRecord{time: ${this.time}, mood: ${this.mood}}`;
  }
}

@Entry
@Component
export struct MoodPage {
  @State currentMood: string = '';
  @State moodColor: string = '#4285F4';
  @State moodDescription: string = '';
  @State moodRecords: MoodRecord[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State userId: number = 0;
  @State isViewingOtherUser: boolean = false; // æ˜¯å¦æŸ¥çœ‹å…¶ä»–ç”¨æˆ·

  private weekDays: string[] = [];

  aboutToAppear(): void {
    console.info('=== æƒ…ç»ªåˆ†æé¡µé¢åˆå§‹åŒ–å¼€å§‹ ===');
    this.currentMood = 'æ— æ•°æ®';
    this.moodColor = '#4285F4';
    this.moodDescription = 'è¯·å°è¯•å½•å…¥æ•°æ®';
    this.weekDays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];

    console.info('=== åˆå§‹åŒ–è®¾ç½®å®Œæˆï¼Œå¼€å§‹åŠ è½½æ•°æ® ===');
    this.initializeMoodSystem();
  }

  private async initializeMoodSystem(): Promise<void> {
    try {
      console.info('=== å¼€å§‹åˆå§‹åŒ–æƒ…ç»ªç³»ç»Ÿ ===');
      this.resetMoodData();
      await this.getUserId();
      await this.loadMoodDataFromDatabase();
      await this.loadMoodRecordsFromDatabase();
      this.isLoading = false;
      console.info('=== æƒ…ç»ªç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ ===');
    } catch (error) {
      console.error(`=== åˆå§‹åŒ–å¼‚å¸¸: ${error} ===`);
      this.errorMessage = `æ•°æ®åŠ è½½å¤±è´¥: ${error}`;
      this.isLoading = false;
      this.resetMoodData();
    }
  }

  private resetMoodData(): void {
    console.info('=== é‡ç½®æƒ…ç»ªæ•°æ® ===');
    this.currentMood = 'æ— æ•°æ®';
    this.moodColor = '#4285F4';
    this.moodDescription = 'è¯·å°è¯•å½•å…¥æ•°æ®';
    this.moodRecords = [];
  }

  private async getUserId(): Promise<void> {
    try {
      console.info('=== å¼€å§‹è·å–ç”¨æˆ·ID ===');

      // å…ˆæ£€æŸ¥è·¯ç”±å‚æ•°æ˜¯å¦æœ‰ä¼ å…¥user_id
      const params = router.getParams() as RouterParams;
      if (params && params.user_id) {
        console.info(`=== ä»è·¯ç”±å‚æ•°è·å–ç”¨æˆ·ID: ${params.user_id} ===`);
        this.userId = params.user_id;
        this.isViewingOtherUser = true;
        return;
      }

      // å¦‚æœæ²¡æœ‰è·¯ç”±å‚æ•°ï¼Œåˆ™ä»AppStorageè·å–å½“å‰ç™»å½•ç”¨æˆ·
      const userInfoStr = AppStorage.get<string>('userInfo');
      const userInfo: UserInfo = userInfoStr ? JSON.parse(userInfoStr) as UserInfo : {};

      if (userInfo && userInfo.userId) {
        this.userId = parseInt(userInfo.userId);
        this.isViewingOtherUser = false;
        console.info(`=== ä»å­˜å‚¨è·å–å½“å‰ç”¨æˆ·ID: ${this.userId} ===`);
      } else {
        console.warn('=== æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤ID ===');
        this.userId = 1;
        this.isViewingOtherUser = false;
      }
    } catch (error) {
      console.error(`=== è·å–ç”¨æˆ·IDå¼‚å¸¸: ${error} ===`);
      this.userId = 1;
      this.isViewingOtherUser = false;
    }
  }

  private async loadMoodDataFromDatabase(): Promise<void> {
    if (this.userId === 0) {
      console.error('=== ç”¨æˆ·IDä¸º0ï¼Œè·³è¿‡æ•°æ®åŠ è½½ ===');
      return;
    }

    try {
      console.info(`=== å¼€å§‹åŠ è½½æƒ…ç»ªæ•°æ®ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      let moodResponse: HealthDataResponse = await userApiService.getHealthData(this.userId, 7, true);
      console.info(`=== æƒ…ç»ªæ•°æ®å“åº”: ${JSON.stringify(moodResponse)} ===`);

      if (moodResponse.success && moodResponse.data && moodResponse.data.length > 0) {
        let todayData: HealthDataRequest = moodResponse.data[0];
        console.info(`=== ä»Šæ—¥æ•°æ®: ${JSON.stringify(todayData)} ===`);

        let moodValue: number = todayData.current_mood || -1;
        this.currentMood = this.getMoodFromValue(moodValue);
        this.moodColor = this.getMoodColor(this.currentMood);
        this.moodDescription = this.getMoodDescription(this.currentMood);

        console.info(`=== ä»Šæ—¥æƒ…ç»ª: ${this.currentMood}, æ•°å€¼: ${moodValue} ===`);
      } else {
        console.warn('=== ä»Šæ—¥æƒ…ç»ªæ•°æ®ä¸ºç©º ===');
      }
    } catch (error) {
      console.error(`=== æ•°æ®åŠ è½½å¼‚å¸¸: ${error} ===`);
      throw new Error(`ç½‘ç»œè¯·æ±‚å¤±è´¥: ${error}`);
    }
  }

  private async loadMoodRecordsFromDatabase(): Promise<void> {
    try {
      console.info(`=== å¼€å§‹åŠ è½½æƒ…ç»ªè®°å½•ï¼Œç”¨æˆ·ID: ${this.userId} ===`);
      let realtimeResponse: RealtimeDataResponse = await userApiService.getRealtimeData(this.userId, 'mood', 7);
      console.info(`=== å®æ—¶æƒ…ç»ªæ•°æ®å“åº”: ${JSON.stringify(realtimeResponse)} ===`);

      if (realtimeResponse.success && realtimeResponse.data) {
        let records: MoodRecord[] = [];

        for (let i: number = 0; i < realtimeResponse.data.length; i++) {
          let item: RealtimeDataRequest = realtimeResponse.data[i];
          let moodValue: number = item.value || 5;
          let mood: string = this.getMoodFromValue(moodValue);
          let color: string = this.getMoodColor(mood);
          let description: string = this.getMoodDescription(mood);
          let time: string = item.time_stamp || '';

          let record: MoodRecord = new MoodRecord(time, mood, description, color);
          records.push(record);
        }

        this.moodRecords = records;
        console.info(`=== æƒ…ç»ªè®°å½•åŠ è½½å®Œæˆï¼Œæ€»è®¡${records.length}æ¡ ===`);
      }
    } catch (error) {
      console.error(`=== åŠ è½½æƒ…ç»ªè®°å½•å¼‚å¸¸: ${error} ===`);
    }
  }

  private getMoodFromValue(value: number): string {
    if (value >= 8) return 'å¼€å¿ƒ';
    if (value >= 6) return 'æ»¡è¶³';
    if (value >= 4) return 'å¹³é™';
    if (value >= 2) return 'ç–²æƒ«';
    if (value >= 0) return 'ç„¦è™‘';
    return 'æ— æ•°æ®';
  }

  private getMoodDescription(mood: string): string {
    if (mood === 'å¼€å¿ƒ') return 'å¿ƒæƒ…æ„‰æ‚¦ï¼Œå……æ»¡æ´»åŠ›';
    if (mood === 'æ»¡è¶³') return 'å†…å¿ƒæ»¡è¶³ï¼ŒçŠ¶æ€è‰¯å¥½';
    if (mood === 'å¹³é™') return 'ä¿æŒå†…å¿ƒå¹³é™';
    if (mood === 'ç–²æƒ«') return 'æ„Ÿåˆ°æœ‰äº›ç–²æƒ«';
    if (mood === 'ç„¦è™‘') return 'æƒ…ç»ªè¾ƒä¸ºç´§å¼ ';
    if (mood === 'æ— æ•°æ®') return 'ç­‰å¾…å½•å…¥æ•°æ®'
    return 'å¿ƒæƒ…ä¸€èˆ¬';
  }

  private refreshMoodData(): void {
    console.info('=== ç”¨æˆ·è§¦å‘æ•°æ®åˆ·æ–° ===');
    this.isLoading = true;
    this.errorMessage = '';
    this.initializeMoodSystem();
  }

  private getMoodColor(mood: string): string {
    if (mood === 'å¼€å¿ƒ' || mood === 'æ»¡è¶³') return '#34A853';
    if (mood === 'å¹³é™') return '#4285F4';
    if (mood === 'ç–²æƒ«') return '#FBBC05';
    if (mood === 'ç„¦è™‘') return '#EA4335';
    return '#4285F4';
  }

  private getMoodEmoji(mood: string): string {
    if (mood === 'å¼€å¿ƒ') return 'ğŸ˜Š';
    if (mood === 'æ»¡è¶³') return 'ğŸ˜Œ';
    if (mood === 'å¹³é™') return 'ğŸ˜Œ';
    if (mood === 'ç–²æƒ«') return 'ğŸ˜´';
    if (mood === 'ç„¦è™‘') return 'ğŸ˜°';
    if (mood=== 'æ— æ•°æ®') return 'ğŸ˜•';
    return 'ğŸ˜';
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          try {
            // å¦‚æœæ˜¯æŸ¥çœ‹å…¶ä»–ç”¨æˆ·ï¼Œè¿”å›æ—¶éœ€è¦ä¼ é€’user_idå‚æ•°ç»™ä¸»é¡µ
            if (this.isViewingOtherUser) {
              router.back({
                url: 'pages/one/pages/WxHomePage',
                params: { user_id: this.userId }
              });
            } else {
              router.back();
            }
          } catch (err) {
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 10 })

        Text('æƒ…ç»ªçŠ¶æ€')
          .fontSize(24).fontWeight(FontWeight.Bold).fontColor(Color.Black)
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          Text('ğŸ”„').fontSize(18)
        }
        .onClick(() => {
          this.refreshMoodData();
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 10 })
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween).alignItems(VerticalAlign.Center)

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#4285F4')
          Text('æ­£åœ¨åŠ è½½æƒ…ç»ªæ•°æ®...')
            .fontSize(18).fontColor('#333333')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ˜”').fontSize(64)
          Text('åŠ è½½å¤±è´¥')
            .fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshMoodData())
            .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(12).height(44).width(140)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Scroll() {
          Column({ space: 20 }) {
            // å½“å‰æƒ…ç»ªæ¦‚è§ˆå¡ç‰‡
            Column() {
              Text(`ä»Šæ—¥æƒ…ç»ªçŠ¶æ€ (${this.weekDays[new Date().getDay()]})`)
                .fontSize(18).fontWeight(FontWeight.Medium).margin({ bottom: 20 }).fontColor('#333333')

              Column() {
                Text(this.getMoodEmoji(this.currentMood))
                  .fontSize(64).margin({ bottom: 15 })

                Text(this.currentMood)
                  .fontSize(32).fontWeight(FontWeight.Bold).fontColor(this.moodColor).margin({ bottom: 10 })

                Text(this.moodDescription)
                  .fontSize(16).fontColor('#666666').textAlign(TextAlign.Center).maxLines(2)
                  .textOverflow({ overflow: TextOverflow.Ellipsis })
              }
              .width('100%').alignItems(HorizontalAlign.Center)
            }
            .width('90%').padding(30).backgroundColor('#FFFFFF').borderRadius(20)
            .shadow({ radius: 12, color: 'rgba(0,0,0,0.08)', offsetX: 0, offsetY: 4 })

            // æƒ…ç»ªè®°å½•å¡ç‰‡
            Column() {
              Text('æƒ…ç»ªè®°å½•')
                .fontSize(18).fontWeight(FontWeight.Medium)
                .textAlign(TextAlign.Start).width('100%').margin({ bottom: 15 })

              if (this.moodRecords.length === 0) {
                Column({ space: 16 }) {
                  Text('ğŸ˜').fontSize(48)
                  Text('æš‚æ— æƒ…ç»ªæ•°æ®')
                    .fontSize(18).fontColor('#666666')
                  Button('åˆ·æ–°æ•°æ®')
                    .onClick(() => this.refreshMoodData())
                    .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(20).height(40)
                }
                .width('100%').height(200).justifyContent(FlexAlign.Center)
              } else {
                Column({ space: 12 }) {
                  ForEach(this.moodRecords, (record: MoodRecord, index: number) => {
                    Row() {
                      Row() {
                        Text(this.getMoodEmoji(record.mood))
                          .fontSize(20)
                      }
                      .width(44).height(44).borderRadius(22)
                      .backgroundColor(record.color + '20')
                      .justifyContent(FlexAlign.Center).margin({ right: 16 })

                      Column() {
                        Row() {
                          Text(record.mood)
                            .fontSize(16).fontWeight(FontWeight.Medium).fontColor(record.color)
                          Blank()
                          Text(record.time)
                            .fontSize(12).fontColor('#999999')
                        }
                        .width('100%')

                        Text(record.description)
                          .fontSize(14).fontColor('#666666').margin({ top: 4 })
                          .textAlign(TextAlign.Start).width('100%').maxLines(2)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                      }
                      .layoutWeight(1).alignItems(HorizontalAlign.Start)
                    }
                    .width('100%').height(60).padding({ top: 8, bottom: 8, left: 12, right: 12 })
                    .backgroundColor(index % 2 === 0 ? '#F8F9FA' : '#FFFFFF').borderRadius(12)
                    .alignItems(VerticalAlign.Center)
                  })
                }
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })

            // æƒ…ç»ªå¥åº·å»ºè®®
            Column() {
              Row() {
                Text('æƒ…ç»ªå¥åº·å»ºè®®')
                  .fontSize(18).fontWeight(FontWeight.Medium).fontColor('#333333')
                Blank()
                Text('ğŸ’¡').fontSize(20)
              }
              .width('100%').margin({ bottom: 15 })

              Column({ space: 12 }) {
                this.buildMoodAdviceItem('å®šæœŸå†¥æƒ³æœ‰åŠ©äºæ”¾æ¾å¿ƒæƒ…', 'ğŸ§˜â€â™‚ï¸')
                this.buildMoodAdviceItem('é€‚é‡è¿åŠ¨èƒ½å¤Ÿæ”¹å–„æƒ…ç»ª', 'ğŸƒâ€â™‚ï¸')
                this.buildMoodAdviceItem('å……è¶³ç¡çœ å¯¹æƒ…ç»ªç¨³å®šå¾ˆé‡è¦', 'ğŸ˜´')
                this.buildMoodAdviceItem('ä¸æœ‹å‹äº¤æµåˆ†äº«å¿ƒæƒ…', 'ğŸ‘¥')
              }
            }
            .width('90%').backgroundColor('#FFFFFF').borderRadius(15).padding(20)
            .shadow({ radius: 8, color: 'rgba(0,0,0,0.06)', offsetX: 0, offsetY: 3 })
          }
          .padding({ left: 16, right: 16, bottom: 20 })
        }
        .layoutWeight(1).scrollBar(BarState.Off)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }

  @Builder
  buildMoodAdviceItem(advice: string, icon: string) {
    Row() {
      Text(icon).fontSize(20).margin({ right: 12 })
      Text(advice)
        .fontSize(14).fontColor('#333333').textAlign(TextAlign.Start)
        .layoutWeight(1).maxLines(3).textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%').padding({ top: 12, bottom: 12, left: 8, right: 8 })
    .backgroundColor('#F8F9FA').borderRadius(8).alignItems(VerticalAlign.Top)
  }
}