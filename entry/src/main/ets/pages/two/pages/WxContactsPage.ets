
///ç¬¬äºŒé¡µä¸»é¡µ

import { router } from '@kit.ArkUI'
import { pinyin } from 'pinyin-pro';
import { BaseNavigation, JhProgressHUD, KColors } from 'JhCommon'
import { WxContactsModel } from '../models/WxContactsModel'
import { WxContactsCell } from '../widgets/WxContactsCell'
import data from '../../../pages/res/wx_contacts.json'

interface GroupItem {
  groupName: string;
  data: ESObject[];
}

@Entry
@Preview
@Component
export struct WxContactsPage {
  @State dataArr: GroupItem[] = []
  // @State tagIndexList: string[] = ['ğŸ”', 'â˜…', 'A', 'B', 'C', 'D', 'E', 'F', 'G',
  //   'H', 'I', 'J', 'K', 'L', 'M', 'N',
  //   'O', 'P', 'Q', 'R', 'S', 'T', 'U',
  //   'V', 'W', 'X', 'Y', 'Z', '#']
  @State tagIndexList: string[] = []
  // scroller: Scroller = new Scroller()
  scroller: ListScroller = new ListScroller()
  searchController: SearchController = new SearchController()
  @State selectedIndex: number = 0
  @State isShowTagPopup: boolean = false
  @State contactsCount: string = ''

  aboutToAppear() {
    this.dataArr = this.loadData()
    // console.error('data', JSON.stringify(this.dataArr))

    const tempList: string[] = [];
    for (const item of this.dataArr) {
      tempList.push(item.groupName)
    }
    this.tagIndexList = tempList;
  }

  build() {
    Column() {
      BaseNavigation({
        //isGradient: true,
        //è¿™æ¸å˜ä¹Ÿä¸å¥½çœ‹å•Š
        title: getContext(this).resourceManager.getStringSync($r('app.string.family_members_title_847592836')),
        leftItem: {},
        bgColor: Color.Transparent,
        rightImgPath: $rawfile("images/ç¬¬äºŒé¡µåŠ å·.png"),
        rightItemCallBack: () => {
          this.searchController.stopEditing()
          router.pushUrl({ url: 'pages/two/pages/WxAddFriendPage' })
        },
      })
      this.body()
    }
  }

  @Builder
  body() {
    Stack({ alignContent: Alignment.End }) {
      List({ space: 0, initialIndex: 0, scroller: this.scroller }) {
        ForEach(this.dataArr, (groupItem: GroupItem, index: number) => {
          ListItemGroup({ header: this.itemHeader(groupItem.groupName) }) {
            ForEach(groupItem.data, (cellItem: ESObject, index2: number) => {
              ListItem() {
                WxContactsCell({
                  index: index,
                  model: cellItem as WxContactsModel,
                  searchController: this.searchController,
                  onClickCell: (model: WxContactsModel) => {
                    this.searchController.stopEditing()
                    router.pushUrl({ url: 'pages/two/pages/WxUserInfoPage', params: { data: cellItem } })
                  },
                  onClickTopCell: (model: ESObject) => {
                    this.searchController.stopEditing()
                    this.clickCell(model['title'] as string)
                  },
                })
              }
              // .swipeAction({
              //   end: {
              //     builder: () => {
              //       if (index != 0) {
              //         this.itemSwipeEnd()
              //       }
              //     },
              //     actionAreaDistance: 0, // è®¾ç½®ç»„ä»¶é•¿è·ç¦»æ»‘åŠ¨åˆ é™¤è·ç¦»é˜ˆå€¼ã€‚ é»˜è®¤56
              //     onAction: () => {
              //       animateTo({ duration: 1000 }, () => {
              //       })
              //     },
              //   }
              // })
            }, (item: ESObject) => JSON.stringify(item))
          }
          // æ¯è¡Œä¹‹é—´çš„åˆ†ç•Œçº¿
          .divider({
            strokeWidth: 0.6,
            startMargin: 65,
            endMargin: 0,
            color: KColors.kFormLineColor,
          })
        })
        ListItem() {
          this.footer()
        }
      }
      .height('100%')
      .layoutWeight(1)
      .edgeEffect(EdgeEffect.Spring, {
        alwaysEnabled: true
      })
      .backgroundColor(Color.White)
      .sticky(StickyStyle.Header | StickyStyle.Footer)
      .scrollBar(BarState.Off)
      .onScrollIndex((firstIndex: number, lastIndex: number) => {
        // console.log('firstIndex', JSON.stringify(firstIndex))
        this.selectedIndex = firstIndex
      })

      AlphabetIndexer({ arrayValue: this.tagIndexList, selected: 0 })
        .color(Color.Black)// æ–‡å­—é¢œè‰²
        .selectedColor(Color.White)// é€‰ä¸­é¡¹æ–‡å­—é¢œè‰²
        .popupColor(Color.White)// æç¤ºå¼¹çª—æ–‡å­—é¢œè‰²
        .selectedBackgroundColor(KColors.kThemeColor)// é€‰ä¸­é¡¹èƒŒæ™¯é¢œè‰²
        .popupBackground('#C9C9C9')// æç¤ºå¼¹çª—èƒŒæ™¯è‰²
        .usingPopup(this.isShowTagPopup)// æ˜¯å¦ä½¿ç”¨æç¤ºå¼¹çª—
        .selectedFont({ size: 16, weight: FontWeight.Bolder })// é€‰ä¸­é¡¹å­—ä½“æ ·å¼
        .popupFont({ size: 30, weight: FontWeight.Bolder })// å¼¹å‡ºæ¡†å†…å®¹çš„å­—ä½“æ ·å¼
        .font({ size: 14 })// å­—æ¯ç´¢å¼•æ¡é»˜è®¤å­—ä½“æ ·å¼
        .itemSize(22)// å­—æ¯ç´¢å¼•æ¡å­—æ¯åŒºåŸŸå¤§å°
        .alignStyle(IndexerAlign.END)// å­—æ¯ç´¢å¼•æ¡å¼¹æ¡†çš„å¯¹é½æ ·å¼ï¼Œæ”¯æŒå¼¹çª—æ˜¾ç¤ºåœ¨ç´¢å¼•æ¡å³ä¾§å’Œå·¦ä¾§.é»˜è®¤å€¼: IndexerAlign.END
        .popupPosition({ x: 60, y: 48 })
        .itemBorderRadius(11)//ç´¢å¼•é¡¹èƒŒæ¿åœ†è§’åŠå¾„
        .popupBackgroundBlurStyle(BlurStyle.NONE)// è®¾ç½®æç¤ºå¼¹çª—çš„èƒŒæ™¯æ¨¡ç³Šæè´¨
        .selected(this.selectedIndex)
        .onSelect((index: number) => {
          // console.log('index', index)
          this.scroller.scrollToIndex(index)
          this.isShowTagPopup = true;
          setTimeout(() => {
            this.isShowTagPopup = false;
          }, 3000)
        })
        .onPopupSelect((index: number) => {
        })
    }
    .layoutWeight(1)
  }

  @Builder
  itemHeader(text: string) {
    if (text == 'ğŸ”') {
      Row()
    } else {
      Row() {
        Text(text == 'â˜…' ? getContext(this).resourceManager.getStringSync($r('app.string.special_care_members_629385741')) : text)
          .padding({ left: 15 })
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor(this.isFloat(text) ? KColors.wxPayColor : '#777777')
      }
      .width("100%")
      .height(30)
      .backgroundColor(KColors.wxBgColor)
    }
  }

  isFloat(text: string): boolean {
    return this.tagIndexList[this.selectedIndex] == text
  }

  @Builder
  itemSwipeEnd() {
    Row() {
      Text(getContext(this).resourceManager.getStringSync($r('app.string.remark_action_384759261')))
        .fontSize(14)
        .fontColor(Color.White)
    }
    .width('25%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#74736D')
    .onClick(() => {
      JhProgressHUD.showToast(getContext(this).resourceManager.getStringSync($r('app.string.remark_toast_927384615')))
      this.scroller.closeAllSwipeActions()
    })
  }

  @Builder
  footer() {
    Row() {
      Text(`${this.getData().length}${getContext(this).resourceManager.getStringSync($r('app.string.family_members_count_639481752'))}`)
        .fontSize(16)
        .fontColor(Color.Gray)
    }
    .width('100%')
    .height(50)
    .justifyContent(FlexAlign.Center)
    .backgroundColor(KColors.wxBgColor)
  }

  clickCell(text: string) {
    const newMemberText: string = getContext(this).resourceManager.getStringSync($r('app.string.new_member_758294637'))
    const groupChatText: string = getContext(this).resourceManager.getStringSync($r('app.string.group_chat_472961853'))
    const healthGoalsText: string = getContext(this).resourceManager.getStringSync($r('app.string.common_health_goals_851374269'))

    if (text == newMemberText) {
      router.pushUrl({ url: 'pages/two/pages/WxNewFriendPage' })
    }
    if (text == groupChatText) {
      router.pushUrl({ url: 'pages/two/pages/WxGroupChatPage' })
    }
    if (text == healthGoalsText) {
      router.pushUrl({ url: 'pages/two/pages/CommonHealthGoalsPage' })
    }
  }

  loadData(): GroupItem[] {
    // åŸå§‹æ•°æ®
    const dataArr: ESObject[] = this.getData()

    // å¤„ç†æ•°æ®
    const tempList: ESObject[] = [];
    for (let i = 0; i < dataArr.length; i++) {
      const item: ESObject = dataArr[i]
      const pinyinStr: string = pinyin(item.name as string, { toneType: 'none' })
      const tag: string = pinyinStr.substring(0, 1).toUpperCase();
      item.namePinyin = pinyinStr;
      if (item.isStar == true) {
        item.tagIndex = 'â˜…';
      } else if (new RegExp('[A-Z]').test(tag)) {
        item.tagIndex = tag;
      } else {
        item.tagIndex = '#';
      }
      tempList.push(item);
    }

    // æ ¹æ®A-Zæ’åº
    tempList.sort((a: ESObject, b: ESObject) => {
      if (a['tagIndex'] === b['tagIndex']) {
        return (a['name'] as string).localeCompare(b['name'] as string) as number
      }
      if (a['tagIndex'] === "#") {
        return 1
      }
      if (b['tagIndex'] === "#") {
        return -1
      }
      return (a['tagIndex'] as string).localeCompare(b['tagIndex'] as string) as number
    });

    // æŠŠæ˜Ÿæ ‡ç§»åˆ°æœ€å‰
    tempList.forEach((item: ESObject, index) => {
      if (item.isStar == true) {
        tempList.unshift(...tempList.splice(index, 1));
      }
    });

    // æ·»åŠ  header
    tempList.unshift({
      name: "header",
      tagIndex: "ğŸ”"
    });

    // æ”¹æˆåˆ†ç»„æ•°æ®
    const newArr: GroupItem[] = groupListByKey(tempList, 'tagIndex');
    return newArr
  }

  getData(): ESObject[] {
    const dataArr: ESObject[] = data['data'] as ESObject[]
    return dataArr;
  }
}

// æ•°ç»„æŒ‰æŒ‡å®škeyåˆ†ç»„
function groupListByKey<T>(array: T[], key: string): GroupItem[] {
  const result: GroupItem[] = [];
  const groupMap: Map<string, T[]> = new Map();

  // éå†æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ æŒ‰ç…§keyåˆ†ç»„
  array.forEach((item: ESObject) => {
    const groupValue: string = String(item[key]);
    if (!groupMap[groupValue]) {
      groupMap[groupValue] = [];
    }
    groupMap[groupValue].push(item);
  });

  Object.keys(groupMap).forEach((key) => {
    result.push({ groupName: key, data: groupMap[key] as ESObject[] });
  });
  return result;
}