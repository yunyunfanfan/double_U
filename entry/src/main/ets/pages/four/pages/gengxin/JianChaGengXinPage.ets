import { router } from '@kit.ArkUI'
import { JhTextList, ItemType, JhSetCell, JhProgressHUD, JhAESPreferencesUtils, kUserDefault_UserInfo, JhAlert } from 'JhCommon'

interface LocalItemType {
  label: Resource | string
  key: string
}

@Entry
@Preview
@Component
export struct SetPage {
  private _rowSpace: number = 24
  private _cellH: number = 72
  private _paddingValue: number = 24

  private localDataArr: LocalItemType[] = [
    { label: $r('app.string.update_log'), key: 'update_log' },
    { label: $r('app.string.current_version_title'), key: 'current_version' },
  ]

  @State dataArr: ItemType[] = []
  @State titleText: string = ''

  aboutToAppear(): void {
    console.info('ğŸš€ SetPage - é¡µé¢å³å°†å‡ºç°ï¼Œå¼€å§‹åˆå§‹åŒ–')
    this.initializeData()
  }

  private initializeData(): void {
    console.info('ğŸ“Š SetPage - å¼€å§‹åˆå§‹åŒ–æ•°æ®æ•°ç»„')
    try {
      const context = getContext(this)

      // ğŸŒ è·å–å¤šè¯­è¨€æ ‡é¢˜
      this.titleText = context.resourceManager.getStringSync($r('app.string.check_update').id)
      console.info('ğŸ·ï¸ SetPage - æ ‡é¢˜è·å–æˆåŠŸ', `æ ‡é¢˜: ${this.titleText}`)

      // ğŸ”„ å¤„ç†æ•°æ®æ•°ç»„
      this.dataArr = this.localDataArr.map((item: LocalItemType, index: number) => {
        const labelStr = context.resourceManager.getStringSync((item.label as Resource).id)
        console.info(`âœ… SetPage - æ•°æ®é¡¹${index}è½¬æ¢æˆåŠŸ`, `key: ${item.key}, label: ${labelStr}`)
        return { label: labelStr } as ItemType
      })
      console.info('ğŸ‰ SetPage - æ•°æ®åˆå§‹åŒ–å®Œæˆ', `æ€»æ•°: ${this.dataArr.length}`)
    } catch (error) {
      console.error('âŒ SetPage - æ•°æ®åˆå§‹åŒ–å¤±è´¥', error)
      // é™çº§å¤„ç†
      this.titleText = 'æ£€æŸ¥æ›´æ–°'
      this.dataArr = [
        { label: 'æ›´æ–°æ—¥å¿—' },
        { label: 'å½“å‰ç‰ˆæœ¬å·' }
      ] as ItemType[]
    }
  }

  build() {
    Scroll() {
      Column() {
        JhTextList({
          title: this.titleText,  // âœ… ä½¿ç”¨stringç±»å‹å˜é‡
          dataArr: this.dataArr,
          callBack: (index: number, text: string) => {
            console.info('ğŸ” SetPage - ç”¨æˆ·ç‚¹å‡»åˆ—è¡¨é¡¹', `ç´¢å¼•: ${index}, æ–‡æœ¬: ${text}`)
            const cleanText = text.replace(/[^\u4e00-\u9fa5]/g, '')
            console.info('ğŸ§¹ SetPage - æ–‡æœ¬æ¸…ç†å®Œæˆ', `æ¸…ç†å: ${cleanText}`)
            this.handleCellClick(cleanText, index)
          }
        })
          .margin({ bottom: this._rowSpace, top: 8 })
      }
      .padding({
        top: 4,
        bottom: 14,
        left: this._paddingValue,
        right: this._paddingValue
      })
      .width('100%')
    }
    .backgroundColor(0xF5F6FA)
  }

  private handleCellClick(text: string, index: number): void {
    console.info('ğŸ¯ SetPage - å¤„ç†å•å…ƒæ ¼ç‚¹å‡»', `æ–‡æœ¬: ${text}, ç´¢å¼•: ${index}`)

    const itemKey = this.localDataArr[index]?.key
    console.info('ğŸ”‘ SetPage - è·å–é¡¹ç›®é”®å€¼', `é”®å€¼: ${itemKey}`)

    switch (itemKey) {
      case 'current_version':
        console.info('ğŸ“± SetPage - æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯')
        this.showVersionInfo()
        break
      case 'update_log':
        console.info('ğŸ“ SetPage - è·³è½¬æ›´æ–°æ—¥å¿—é¡µé¢')
        this.navigateToUpdateLog()
        break
      default:
        console.error('âš ï¸ SetPage - æœªçŸ¥é€‰é¡¹', `é”®å€¼: ${itemKey}`)
    }
  }

  private showVersionInfo(): void {
    console.info('ğŸ·ï¸ SetPage - å‡†å¤‡æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯å¼¹çª—')
    try {
      const context = getContext(this)
      const titleStr = context.resourceManager.getStringSync($r('app.string.current_version_title').id)
      const messageStr = context.resourceManager.getStringSync($r('app.string.version_message').id)

      JhAlert.showSystemAlert({
        title: titleStr,    // âœ… stringç±»å‹
        message: messageStr // âœ… stringç±»å‹
      })
      console.info('âœ… SetPage - ç‰ˆæœ¬ä¿¡æ¯å¼¹çª—æ˜¾ç¤ºæˆåŠŸ')
    } catch (error) {
      console.error('âŒ SetPage - æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯å¤±è´¥', error)
    }
  }

  private navigateToUpdateLog(): void {
    console.info('ğŸ”„ SetPage - å‡†å¤‡è·³è½¬æ›´æ–°æ—¥å¿—é¡µé¢')
    try {
      router.pushUrl({ url: 'pages/four/pages/gengxin/RiZhi' })
      console.info('âœ… SetPage - é¡µé¢è·³è½¬è¯·æ±‚å‘é€æˆåŠŸ')
    } catch (error) {
      console.error('âŒ SetPage - é¡µé¢è·³è½¬å¤±è´¥', error)
    }
  }
}