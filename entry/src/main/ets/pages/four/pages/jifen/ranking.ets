import { router } from '@kit.ArkUI';
import { userApiService, PointsRankingResponse, PointsRankingItem } from '../../../../services/api_network/UserApiService';

interface UserInfo {
  userId?: string;
  userName?: string;
  phone?: string;
}

class RankingDisplayItem {
  rank: number;
  userId: number;
  username: string;
  totalPoints: number;
  isCurrentUser: boolean;

  constructor(rank: number, userId: number, username: string, totalPoints: number, isCurrentUser: boolean) {
    this.rank = rank;
    this.userId = userId;
    this.username = username;
    this.totalPoints = totalPoints;
    this.isCurrentUser = isCurrentUser;
  }
}

@Entry
@Component
export struct PointsRankingPage {
  @State rankingList: RankingDisplayItem[] = [];
  @State isLoading: boolean = true;
  @State errorMessage: string = '';
  @State currentUserId: number = 0;
  @State currentUserRank: number = 0;
  @State refreshing: boolean = false;

  aboutToAppear(): void {
    console.info('=== ç§¯åˆ†æ’è¡Œæ¦œé¡µé¢åˆå§‹åŒ– ===');
    this.loadCurrentUser();
    this.loadRankingData();
  }

  private loadCurrentUser(): void {
    try {
      const userInfoStr = AppStorage.get<string>('userInfo');
      if (userInfoStr) {
        const userInfo: UserInfo = JSON.parse(userInfoStr) as UserInfo;
        this.currentUserId = parseInt(userInfo.userId || '0');
        console.info(`=== å½“å‰ç”¨æˆ·ID: ${this.currentUserId} ===`);
      }
    } catch (error) {
      console.error(`=== è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ${error} ===`);
      this.currentUserId = 0;
    }
  }

  private async loadRankingData(): Promise<void> {
    try {
      console.info('=== å¼€å§‹åŠ è½½ç§¯åˆ†æ’è¡Œæ¦œ ===');
      this.isLoading = true;
      this.errorMessage = '';

      const response: PointsRankingResponse = await userApiService.getPointsRanking(100);
      console.info(`=== æ’è¡Œæ¦œå“åº”: ${JSON.stringify(response)} ===`);

      if (response.success && response.rankings) {
        const displayItems: RankingDisplayItem[] = response.rankings.map((item: PointsRankingItem) => {
          const isCurrentUser = item.user_id === this.currentUserId;
          if (isCurrentUser) {
            this.currentUserRank = item.rank;
          }
          return new RankingDisplayItem(
            item.rank,
            item.user_id,
            item.username,
            item.total_points,
            isCurrentUser
          );
        });

        this.rankingList = displayItems;
        console.info(`=== æ’è¡Œæ¦œåŠ è½½å®Œæˆï¼Œå…±${displayItems.length}æ¡è®°å½• ===`);
      } else {
        this.errorMessage = response.message || 'è·å–æ’è¡Œæ¦œå¤±è´¥';
        this.rankingList = [];
      }
    } catch (error) {
      console.error(`=== åŠ è½½æ’è¡Œæ¦œå¼‚å¸¸: ${error} ===`);
      this.errorMessage = `åŠ è½½å¤±è´¥: ${error}`;
      this.rankingList = [];
    } finally {
      this.isLoading = false;
      this.refreshing = false;
    }
  }

  private async refreshRanking(): Promise<void> {
    console.info('=== ç”¨æˆ·è§¦å‘æ’è¡Œæ¦œåˆ·æ–° ===');
    this.refreshing = true;
    await this.loadRankingData();
  }

  private getRankIcon(rank: number): string {
    if (rank === 1) return 'ğŸ¥‡';
    if (rank === 2) return 'ğŸ¥ˆ';
    if (rank === 3) return 'ğŸ¥‰';
    return `${rank}`;
  }

  private getRankColor(rank: number): string {
    if (rank === 1) return '#FFD700';
    if (rank === 2) return '#C0C0C0';
    if (rank === 3) return '#CD7F32';
    return '#666666';
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆªæ 
      Row() {
        Button({ type: ButtonType.Circle }) {
          Image($r('app.media.ic_back')).width(20).height(20)
        }
        .onClick(() => {
          try {
            router.back();
          } catch (err) {
            console.error('=== è¿”å›å¤±è´¥ ===', err);
            router.pushUrl({ url: 'pages/one/OnePage' });
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ left: 12 })

        Text('ç§¯åˆ†æ’è¡Œæ¦œ')
          .fontSize(20).fontWeight(FontWeight.Bold).fontColor('#333333')
          .layoutWeight(1).textAlign(TextAlign.Center)

        Button({ type: ButtonType.Circle }) {
          if (this.refreshing) {
            LoadingProgress().width(20).height(20).color('#4285F4')
          } else {
            Text('ğŸ”„').fontSize(18)
          }
        }
        .onClick(() => {
          if (!this.refreshing) {
            this.refreshRanking();
          }
        })
        .width(40).height(40).backgroundColor(Color.Transparent).margin({ right: 12 })
        .enabled(!this.refreshing)
      }
      .width('100%').height(60).justifyContent(FlexAlign.SpaceBetween)
      .backgroundColor('#FFFFFF').shadow({ radius: 8, color: 'rgba(0,0,0,0.05)', offsetY: 2 })

      if (this.isLoading) {
        Column({ space: 20 }) {
          LoadingProgress().width(60).height(60).color('#4285F4')
          Text('æ­£åœ¨åŠ è½½æ’è¡Œæ¦œ...')
            .fontSize(16).fontColor('#666666')
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
      } else if (this.errorMessage) {
        Column({ space: 20 }) {
          Text('ğŸ˜•').fontSize(64)
          Text('åŠ è½½å¤±è´¥').fontSize(20).fontColor('#EA4335')
          Text(this.errorMessage).fontSize(14).fontColor('#666666').textAlign(TextAlign.Center)
          Button('é‡æ–°åŠ è½½')
            .onClick(() => this.refreshRanking())
            .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(12).height(44).width(120)
        }
        .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center).padding(40)
      } else {
        Column() {
          // å½“å‰ç”¨æˆ·æ’åå¡ç‰‡
          if (this.currentUserRank > 0) {
            Row() {
              Text('æˆ‘çš„æ’å').fontSize(16).fontColor('#666666')
              Blank()
              Text(`ç¬¬${this.currentUserRank}å`).fontSize(18).fontWeight(FontWeight.Bold).fontColor('#4285F4')
            }
            .width('90%').padding(16).backgroundColor('#F0F8FF').borderRadius(12).margin({ top: 16, bottom: 8 })
          }

          // æ’è¡Œæ¦œåˆ—è¡¨
          if (this.rankingList.length === 0) {
            Column({ space: 16 }) {
              Text('ğŸ“Š').fontSize(48)
              Text('æš‚æ— æ’è¡Œæ¦œæ•°æ®').fontSize(16).fontColor('#666666')
              Button('åˆ·æ–°æ•°æ®')
                .onClick(() => this.refreshRanking())
                .backgroundColor('#4285F4').fontColor(Color.White).borderRadius(20).height(40)
            }
            .width('100%').layoutWeight(1).justifyContent(FlexAlign.Center)
          } else {
            Scroll() {
              Column({ space: 8 }) {
                ForEach(this.rankingList, (item: RankingDisplayItem, index: number) => {
                  Row() {
                    // æ’å
                    Row() {
                      if (item.rank <= 3) {
                        Text(this.getRankIcon(item.rank))
                          .fontSize(24).textAlign(TextAlign.Center)
                      } else {
                        Text(`${item.rank}`)
                          .fontSize(16).fontWeight(FontWeight.Bold)
                          .fontColor(this.getRankColor(item.rank))
                      }
                    }
                    .width(50).height(40).justifyContent(FlexAlign.Center)

                    // ç”¨æˆ·ä¿¡æ¯
                    Column() {
                      Text(item.username)
                        .fontSize(16).fontWeight(FontWeight.Medium)
                        .fontColor(item.isCurrentUser ? '#4285F4' : '#333333')
                        .maxLines(1).textOverflow({ overflow: TextOverflow.Ellipsis })

                      Text(`ç”¨æˆ·ID: ${item.userId}`)
                        .fontSize(12).fontColor('#999999').margin({ top: 2 })
                    }
                    .layoutWeight(1).alignItems(HorizontalAlign.Start).margin({ left: 16 })

                    // ç§¯åˆ†
                    Column() {
                      Text(`${item.totalPoints}`)
                        .fontSize(18).fontWeight(FontWeight.Bold)
                        .fontColor(item.isCurrentUser ? '#4285F4' : '#333333')
                      Text('ç§¯åˆ†')
                        .fontSize(12).fontColor('#666666')
                    }
                    .alignItems(HorizontalAlign.End)
                  }
                  .width('90%').height(60).padding({ left: 12, right: 12 })
                  .backgroundColor(item.isCurrentUser ? '#F0F8FF' : (index % 2 === 0 ? '#FAFAFA' : '#FFFFFF'))
                  .borderRadius(12).margin({ bottom: 4 })
                  .shadow({
                    radius: item.isCurrentUser ? 8 : 4,
                    color: item.isCurrentUser ? 'rgba(66, 133, 244, 0.2)' : 'rgba(0,0,0,0.05)',
                    offsetY: 2
                  })
                })
              }
              .padding({ top: 8, bottom: 20 })
            }
            .layoutWeight(1).scrollBar(BarState.Auto)
          }
        }
        .alignItems(HorizontalAlign.Center)
      }
    }
    .width('100%').height('100%').backgroundColor('#F8F9FA')
  }
}